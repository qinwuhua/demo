<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport"
	content="initial-scale=1, maximum-scale=1,user-scalable=no">
<title>arcgis js api 加载geoserver wms</title>
<link rel="stylesheet"
	href="http://js.arcgis.com/3.12/dijit/themes/tundra/tundra.css">
<link rel="stylesheet"
	href="http://js.arcgis.com/3.12/esri/css/esri.css">
<style>
html, body {
	height: 100%;
	width: 100%;
	margin: 0;
	padding: 0;
}

#map {
	height: 100%;
	width: 100%;
}
</style>

<script type="text/javascript">
	var dojoConfig = (function() {
		var path_location = location.pathname.replace(/\/[^/]+$/, '');
		return {
			async : true,
			isDebug : false,
			packages : [ {
				name : "App",
				location : path_location
			} ]
		};
	})();
</script>
<script src="framework/jquery-1.8.0.min.js"></script>
<script src="framework/jquery.tabletojson.js"></script>
<script src="http://js.arcgis.com/3.12"></script>
<script src="2.x/OpenLayers.js"></script>
<script>
	var map, basmapUrl, geoSerUrl;
	require(
			[ "dojo/parser",
			  "dojo/ready", 
			  "dojo/_base/array",
			  "dojo/on","dojo/query",
					"esri/map", "esri/config", "esri/urlUtils", "esri/request",
					"esri/geometry/Extent", "esri/tasks/GeometryService",
					"esri/tasks/ProjectParameters",
					"esri/layers/GraphicsLayer", "esri/SpatialReference",
					"esri/geometry/Point", "esri/layers/WMSLayerInfo",
					"esri/layers/WMSLayer", "esri/tasks/QueryTask",
					"esri/tasks/query", "dojo/domReady!" ],
			function(parser, ready, arrayUtils, on, query,Map, esriConfig, urlUtils,
					esriRequest, Extent, GeometryService, ProjectParameters,
					GraphicsLayer, SpatialReference, esriPoint, WMSLayerInfo,
					WMSLayer, QueryTask, esriQuery) {
				/* var proxyUrl = "http://localhost:8080/arcgis_proxy/proxy.jsp?"; */
				var proxyUrl = location.pathname.replace(/\/[^/]+$/, '') + "/proxy.jsp?";
				basmapUrl = "http://211.101.37.234:8080/hdmapserver/wms?";
				geoSerUrl = "http://211.101.37.251:6080/arcgis/rest/services/Utilities/Geometry/GeometryServer";
				var geometryService = new GeometryService(geoSerUrl);
				ready(function() {

					/* esriConfig.defaults.io.alwaysUseProxy = true;
					esriConfig.defaults.io.corsEnabledServers.push("http://211.101.37.234:8080/hdmapserver/web/");
					esriConfig.defaults.io.proxyUrl = "/arcgisserver/apis/javascript/proxy/proxy.ashx"; */
					urlUtils.addProxyRule({
								urlPrefix : "http://211.101.37.234:8080/hdmapserver/wms",
								proxyUrl : "./proxy.jsp"
							});

					parser.parse();
					var wgs = new SpatialReference({
						"wkid" : 4326
					});
					var params = new ProjectParameters();
					params.outSR = wgs;

					map = new Map("map", {
						logo : false,
						slider : true
					});
					on(map, "click", function(evtObj) {
						wmsQuery(evtObj.screenPoint);
					});
					var wmsLayerInfo = new WMSLayerInfo({
						name : 'jiangxi_map',
						title : 'jiangxi_map'
					});
					var resourceInfo = {
						extent : new Extent(113.573, 24.488, 118.482, 30.079, {
							wkid : 4326
						}),
						layerInfos : [ wmsLayerInfo ]
					};
					var wmsLayer = new WMSLayer(basmapUrl, {
						resourceInfo : resourceInfo,
						visibleLayers : [ 'jiangxi_map' ],
						format : "png"
					});
					map.addLayers([ wmsLayer ]);

					//wfs查询
					function wfsQury(){
						
					}
					
					//wms查询
					function wmsQuery(mapPoint) {
						var data = {
							BBOX : map.extent.xmin.toString() + ","
									+ map.extent.ymin.toString() + ","
									+ map.extent.xmax.toString() + ","
									+ map.extent.ymax.toString(),
							FEATURE_COUNT : 50,
							EXCEPTIONS : "application/vnd.ogc.se_xml",
							REQUEST : 'GetFeatureInfo',
							SERVICE : 'WMS',
							VERSION : '1.1.1',
							Layers : "jiangxi_map",
							Styles : '',
							INFO_FORMAT : "text/html",
							WIDTH : map.width,
							HEIGHT : map.height,
							QUERY_LAYERS : "jiangxi_map",
							x : mapPoint.x.toString(),
							y : mapPoint.y.toString(),
							format : 'image/png',
							srs : 'EPSG:'
									+ map.spatialReference.wkid.toString()
						};

						$.ajax({
							type : 'GET',
							url : proxyUrl + basmapUrl,
							data : data,
							dataType : "xml",
							success : function(responseData) {
								var nodeList = responseData.children[0].children[2].children;
								var len = nodeList.length;
								for(var i=0;i<len;i++){
									var node = nodeList[i];
									var nodeType = node.tagName;
									if(nodeType ==="table"){
										 var table = $('.featureInfo')[0].tableToJSON(); // Convert the table into a javascript object
										  console.log(table);
										  alert(JSON.stringify(table));
									}
								}
								console.info("请求成功");
							},
							err : function() {
								debugger;
								console.info("请求失败");
							}
						});
					}
				});
			});
	/**
	属性查询
	**/
	function attrQuery() {
		OpenLayers.ProxyHost="./proxy.jsp?";
		/* var searchstr="测试数据";
		var filter=new OpenLayers.Filter.Comparison({  
            type : OpenLayers.Filter.Comparison.LIKE,  
            property : "NAME",  
            value : "*" + searchstr + "*"  
        }); */
       // alert(filter.toString());
        var wfsProtocol=new OpenLayers.Protocol.WFS({  
            url : "http://127.0.0.1:8989/hdmapserver/wfs",  
            featureType : "network",
            featureNS : "http://127.0.0.1:8989/hdmapserver/sxyhmap",
            /* filter : new OpenLayers.Filter.Comparison({
				type : OpenLayers.Filter.Comparison.EQUAL_TO,
				property : encodeURIComponent("区县编码"),
				value : "140222"
			}), */
			maxFeatures:500,
			outputFormat:'GML2',
            callback:function(req){
            	console.info(req);
            	var gmlParse = new OpenLayers.Format.GML();
            	console.info(req.priv.responseText);
                var features = gmlParse.read(req.priv.responseText);
                console.info(features); 
                for (var feat in features) {
                   var  feature = features[feat];   
                   var polygon = feature.geometry.components[0].clone();

                   var vec = new OpenLayers.Feature.Vector(polygon);
                   var gjsonObj=OpenLayers.Format.GeoJSON.prototype.parseGeometry(vec);
                   //var string = OpenLayers.Format.GeoJSON.prototype.write(vec);
                   console.info(gjsonObj);
                }
            }
        });
        wfsProtocol.read();
        
		/*var wfsProtocol=new OpenLayers.Protocol.WFS({  
            url : "http://211.101.37.234:8080/hdmapserver/wfs",  
            featureType : "jx_guancezhanguosheng",
            featureNS : "http://211.101.37.234:8080/hdmapserver/jiangximap",
            callback:function(scope,response){
            	console.info(scope);
            	console.info(response);
            }
        });
        wfsProtocol.read();*/
        
	}
</script>
</head>

<body>
<div style="position: absolute;right: 1opx;top: 10px;z-index: 999">
	<button onclick="attrQuery()">属性查询</button>
</div>
	<div id="map"></div>
</body>
</html>