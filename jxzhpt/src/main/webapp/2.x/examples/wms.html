<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="../theme/default/style.css" type="text/css">
    <link rel="stylesheet" href="style.css" type="text/css">
    <script src="../lib/OpenLayers.js"></script>
    <script src="../../framework/jquery-1.8.0.min.js"></script>
    <script src="../../framework/jquery.tabletojson.js"></script>

    <script type="text/javascript">
        var lon = 115.94040;
        var lat = 27.55343;
        var zoom = 8;
        var map, layer, click, selected;
        //加载wms服务
        function init() {
            OpenLayers.ProxyHost = location.origin + "/arcgisproxy/cgi/proxy.cgi?url=";
            map = new OpenLayers.Map('map');
            layer = new OpenLayers.Layer.WMS("layer",
                    "http://211.101.37.234:8080/hdmapserver/wms", {
                        layers: 'jiangximap:jx_dist'
                    });
            map.addLayer(layer);
            map.setCenter(new OpenLayers.LonLat(lon, lat), zoom);
//            selected = new OpenLayers.Layer.Vector("Selection", {
//                styleMap: new OpenLayers.Style(OpenLayers.Feature.Vector.style["select"])
//            });
            infoControls = {
//                click: new OpenLayers.Control.WMSGetFeatureInfo({
//                    url: 'http://211.101.37.234:8080/hdmapserver/wms',
//                    layers: [layer],
//                    queryVisible: true,//查找可见图层
//                    drillDown: true,
//                    maxFeatures: 50//最大返回要素数目50个
//                }),
                getFeature: new OpenLayers.Control.GetFeature({
                    protocol: new OpenLayers.Protocol.WFS({
                        version: "1.0.0",
                        url: "http://211.101.37.234:8080/hdmapserver/wfs",
                        featureType: "jx_dist",
                        featureNS: "http://www.hdtest.com/jiangximap",
                        readFormat: new OpenLayers.Format.GeoJSON(),
                        formatOptions: {
                            outputFormat: "JSON"
                        }
                    }),
                    box: true,
                    click: true,
                    multipleKey: "shiftKey",
                    toggleKey: "ctrlKey",
                    eventListeners: {
                        "featureselected": function (event) {
                            debugger;
                            selected.addFeatures([event.feature]);
                        },
                        "featureunselected": function (event) {
                            debugger;
                            selected.removeFeatures([event.feature]);
                        }
                    }
                })

            };
            for (var i in infoControls) {
//                infoControls[i].events.register("getfeatureinfo", this, showInfo);
//                infoControls[i].events.register("nogetfeatureinfo", this, notGetInfo);
                map.addControl(infoControls[i]);
            }
            infoControls.getFeature.activate();
            showInfo();
        }
        //按照路线编码、起止点桩号，在地图上标注路线（可多段标注，指定不同颜色）
        function query(queryObj) {

        }

        function showInfo(evtObj) {
//            var parser = new DOMParser();
//            var responseTest = parser.parseFromString(evtObj.text, "text/html");
//            var mm = $("table.featureInfo", responseTest);
//            var len = mm.length;
//            var jsonTables = [];
//            for (var i = 0; i < len; i++) {
//                var table = $(mm[i]).tableToJSON({
//                    ignoreHiddenRows: false
//                });
//                jsonTables[i] = table
//            }
//            jsonTables = JSON.stringify(jsonTables);
//            console.log(jsonTables);


            var wfs = new OpenLayers.Layer.Vector("WFS", {
                projection: new OpenLayers.Projection("EPSG:4326"),
                protocol: new OpenLayers.Protocol.WFS({
                    version: "1.0.0",
                    url: "http://211.101.37.234:8080/hdmapserver/wfs",
                    featureType: "jx_dist",
                    featureNS: "http://www.hdtest.com/jiangximap",
                    srsName: "EPSG:4326",
                    geometryName: "the_geom"
                })
            });
//
            var feature = wfs.getFeatureByFid("jx_dist.10");
            debugger;
        }

        function notGetInfo(obj) {

        }
    </script>
</head>
<body onload="init()">
<h1 id="title">WMS Demo</h1>

<div id="map" class="smallmap"></div>
</body>
</html>