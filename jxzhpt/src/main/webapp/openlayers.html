<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Openlayer</title>
    <script src="2.x/OpenLayers.js"></script>
    <script src="framework/jquery-1.8.0.min.js"></script>
    <script src="framework/jquery.tabletojson.js"></script>
    <script type="text/javascript" src="./js/YMLib.js"></script>
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script>
        /**
         * DEMO代码主要完成技术突破和技术验证使用，请在理解的基础上按需COPY
         * 代码设计还有待完善
         * */

        /**
         *地图服务地址
         **/
        var mapServerUrl = "http://192.168.1.101:8989/hdmapserver";
        /**
         * 服务命名空间 不能随便填，请通过hdmapserver服务查看
         **/
		var nameSpace = "http://192.168.1.108:8989/hdmapserver/jiangximap";
		jQuery(document).ready(function () {
			OpenLayers.ProxyHost = "./proxy.jsp?";
			initMap();
			initDefaultStyle();
			
			var _lx=parent.YMLib.Var.type!=undefined?parent.YMLib.Var.type:"";
			var signFlag=parent.YMLib.Var.bm.substr(0,1);
			var signName=parent.YMLib.Var.bm.length>11?"桥梁图层":"路线图层";
			$.ajax({
				type:"post",
				url : '/jxzhpt/xtgl/getBmbmTreeByName2.do?yhm='
					+ encodeURI(encodeURI(signName)),
				dataType:'json',
				async:false,
				success:function(msg){
					var showLayer="";
					var lx="";
					if(msg.length==4){
						if((signFlag=="G"||signFlag=="S")&&(_lx=="特大桥"||_lx=="大桥")) showLayer=msg[0].bmid;
						if((signFlag=="G"||signFlag=="S")&&(_lx=="中桥"||_lx=="小桥")) showLayer=msg[1].bmid;
						if((signFlag=="X"||signFlag=="Y"||signFlag=="Z"||signFlag=="C")&&(_lx=="特大桥"||_lx=="大桥")) showLayer=msg[2].bmid;
						if((signFlag=="X"||signFlag=="Y"||signFlag=="Z"||signFlag=="C")&&(_lx=="中桥"||_lx=="小桥")) showLayer=msg[3].bmid;
						lx="ROADBM";
					}else if(msg.length==6){
						if(signFlag=="G") showLayer=msg[0].bmid;
						if(signFlag=="S") showLayer=msg[1].bmid;
						if(signFlag=="X") showLayer=msg[2].bmid;
						if(signFlag=="Y") showLayer=msg[3].bmid;
						if(signFlag=="Z") showLayer=msg[4].bmid;
						if(signFlag=="C") showLayer=msg[5].bmid;
						lx="ROADCODE";
					}
					wfsAttrQuery(showLayer, lx, parent.YMLib.Var.bm);
				}
			});
        });
        var map, baseLayers;
        var format = 'image/png';
        //全图视野范围
        var bounds = new OpenLayers.Bounds(
                113.573, 24.488,
                118.482, 30.079
        );
        /**
         * 初始化默认点、线、面样式
         * */
        var styleMap = null;
        function initDefaultStyle() {
            var sketchSymbolizers = {
                "Point": {
                    pointRadius: 4,
                    graphicName: "square",
                    fillColor: "white",
                    fillOpacity: 1,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    strokeColor: "#333333",
                    externalGraphic: "images/mark.png",
                    graphicWidth: 24,
                    graphicHeight: 24
                },
                "Line": {
                    strokeWidth: 3,
                    strokeOpacity: 1,
                    strokeColor: "#0000FF"
                },
                "Polygon": {
                    strokeWidth: 2,
                    strokeOpacity: 1,
                    strokeColor: "#ffffff",
                    fillColor: "#0000FF",
                    fillOpacity: 0.3
                }
            };
            var style = new OpenLayers.Style();
            style.addRules([
                new OpenLayers.Rule({symbolizer: sketchSymbolizers})
            ]);
            styleMap = new OpenLayers.StyleMap({"default": style});
        }

        /**
         * 初始化地图
         */
        function initMap() {
            var options = {
                controls: [],
                maxExtent: bounds,
                maxResolution: 0.02183984375,
                projection: "EPSG:4326",
                units: 'degrees'
            };
            //可选代码 设置地图的宽度、高度
            var w = $(document.body).width();
            var h = $(document.body).height();
            $("#map").css({
                width: w,
                height: h
            });
            //
            map = new OpenLayers.Map('map', options);
            baseLayers = new OpenLayers.Layer.WMS(
                    "Geoserver layers - Tiled",
                    mapServerUrl + "/wms",
                    {
                        LAYERS: 'jiangxi_map',
                        STYLES: '',
                        format: format,
                        tiled: true,
                        tilesOrigin: map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                        buffer: 0,
                        displayOutsideMaxExtent: true,
                        isBaseLayer: true,
                        numZoomLevels: 10
                    }
            );
            map.addControl(new OpenLayers.Control.Navigation());
            map.addLayers([baseLayers]);
            map.zoomToExtent(bounds);
            map.addControl(new OpenLayers.Control.PanZoomBar({
                position: new OpenLayers.Pixel(2, 15)
            }));
        }
        /**
         * 属性查询示例
         */
        function attrQuery() {
            wfsAttrQuery("jx_xianxiangtedaqiao", "ROADCODE", "X457360721");
        }
        /**
         * I查询
         * */
        var infoControl = null;
        function IQuery() {
            if (infoControl != null) {
                infoControl.activate();
                return;
            }
            infoControl = new OpenLayers.Control.WMSGetFeatureInfo({
                url: mapServerUrl + '/wms',
                layers: [baseLayers],
                queryVisible: true,//查找可见图层
                drillDown: true,
                maxFeatures: 50//最大返回要素数目50个
            });
            //console.info(infoControl);
            infoControl.events.register("getfeatureinfo", this, showInfo);
            infoControl.events.register("nogetfeatureinfo", this, notGetInfo);
            map.addControl(infoControl);
            infoControl.activate();
            //console.info(infoControl);
        }
        /**
         * I查询查询到数据后的处理方法
         */
        var layersConfig = [];
        function showInfo(event) {
            var parser = new DOMParser();
            var responseTest = parser.parseFromString(event.text, "text/html");
            var jsonTables = [];
            var tableNames = [];
            $("table.featureInfo", responseTest).each(function (i, obj) {
                var table = $(obj).tableToJSON({
                    ignoreHiddenRows: false
                });
                jsonTables[i] = table;
                tableNames[i] = $(obj).find("caption").html();
            });
            // console.info(tableNames,jsonTables);
            /*jsonTables = JSON.stringify(jsonTables);
             console.log(jsonTables);*/
            //
            var len = jsonTables.length;
            var keyId = "ID";//主键字段
            var keyValue = null;
            var index = len - 1;
            for (var i = len - 1; i >= 0; i--) {
                var jsonTable = jsonTables[i];
                if (jsonTable[0][keyId]) {
                    index = i;
                    keyValue = jsonTable[0][keyId];
                    break;
                }
            }
            //
            var layerName = tableNames[index];
            wfsAttrQuery(layerName, keyId, keyValue);
        }
        /**
         * 调用WFS进行属性查询
         * 注意：这里只封装了单一属性查询，实际上WFS是支持多种属性条件查询和空间查询
         */
        var resultLayer = null;
        function wfsAttrQuery(layerName, keyCol, keyValue) {
            debugger;
            if (resultLayer == null) {
                resultLayer = new OpenLayers.Layer.Vector("resultLayer", {styleMap: styleMap});
                map.addLayer(resultLayer);
                //添加数据移动上去显示气泡
                var selectControl = new OpenLayers.Control.SelectFeature(resultLayer, {
                    onSelect: onFeatureSelect,
                    onUnselect: onFeatureUnselect,
                    hover: false
                });
                map.addControl(selectControl);
                selectControl.activate();
            } else {
                resultLayer.removeAllFeatures();
            }
            var wfsProtocol = new OpenLayers.Protocol.WFS({
                url: mapServerUrl + "/wfs",//正式环境代码：mapServerUrl+"/wfs",
                featureType: layerName,
                featureNS: nameSpace,//正式环境代码：nameSpace
                /**
                 * 更复杂的逻辑条件请参考OpenLayers的API
                 * */
                filter: new OpenLayers.Filter.Comparison({
                    type: OpenLayers.Filter.Comparison.EQUAL_TO,
                    property: keyCol,
                    value: keyValue
                }),
                maxFeatures: 1000,
                outputFormat: 'GML2',
                callback: function (req) {
                    //console.info(req);
                    var gmlParse = new OpenLayers.Format.GML();
                    var features = gmlParse.read(req.priv.responseText);
                    resultLayer.addFeatures(features);
                    if (resultLayer.features && resultLayer.features.length > 0) {
                        map.zoomToExtent(resultLayer.getDataExtent());
                    }

                }
            });
            wfsProtocol.read();
        }
        /**
         * I查询没有查询到数据的处理方法
         */
        function notGetInfo() {

        }
        //构造弹出窗口的函数
        var selectedFeature = null;
        function onFeatureSelect(feature) {
        	YMLib.Var.bm=parent.YMLib.Var.bm;
        	if(parent.YMLib.Var.bm.length>11) parent.YMLib.UI.createWindow('ql_add','桥梁项目查询','/jxzhpt/page/dzdt/dzdt_ql.jsp','app_add',630,330);
         	else parent.YMLib.UI.createWindow('lx_add','路线项目查询','/jxzhpt/page/dzdt/dzdt_lx.jsp','app_add',630,330);
        	
        }
        //销毁弹出窗口的函数
        function onFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
        }
        //关闭弹出窗口的函数
        function onPopupClose(evt) {
            selectControl.unselect(selectedFeature);
        }
    </script>
</head>
<body>
<!-- <div style="position: absolute;top: 10px;right:10px;z-index: 9999">
    <button onclick="attrQuery()">桥梁属性查询</button>
    <button onclick="IQuery()">I查询</button>
</div> -->
<div id="map" style="width:900px;height:800px">

</div>
</body>
</html>