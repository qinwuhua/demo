<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.plan_yhdzx">
	<resultMap type="plan_yhdzx" id="yhdzx_jh">
		<id property="id" column="id" />
		<result property="xdsj" column="xdsj"/>
		<result property="sbnf" column="sbnf"/>
		<result property="classify" column="classify"/>
		<result property="fee" column="fee"/>
		<result property="newfee" column="newfee"/>
		<result property="reportingfee" column="reportingfee"/>
		<result property="totalinvest" column="totalinvest"/>
		<result property="totalsubsidyfund" column="totalsubsidyfund"/>
		<result property="nowyearsubsidyfund" column="nowyearsubsidyfund"/>
		<result property="accumulativesubsidyfund" column="accumulativesubsidyfund"/>
		<result property="dianceng" column="dianceng"/>
		<result property="jiceng" column="jiceng"/>
		<result property="surface" column="surface"/>
		<result property="mark" column="mark"/>
		<result property="pqi" column="pqi"/>
		<result property="aadt" column="aadt"/>
		<result property="constructnumber" column="constructnumber"/>
		<result property="replynumber" column="replynumber"/>
		<result property="devisenumber" column="devisenumber"/>
		<result property="plandownnumber" column="plandownnumber"/>
		<result property="description" column="description"/>
		<result property="xchsqk" column="xchsqk"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="remarks" column="remarks"/>
		<result property="qtbz" column="qtbz"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<result property="totalplacefund" column="totalplacefund"/>
		<result property="devisenumbder" column="devisenumbder"/>
		<collection property="plan_lx_yhdzxs" ofType="plan_lx_yhdzx" resultMap="yhdzx_lx"/>
	</resultMap>
	<resultMap type="plan_lx_yhdzx" id="yhdzx_lx">
		<id property="lxid" column="lxid" />
		<result property="lxbm" column="lxbm"/>
		<result property="lxmc" column="lxmc"/>
		<result property="gydwmc" column="gydwmc"/>
		<result property="gydwdm" column="gydwdm"/>
		<result property="xzqhdm" column="xzqhdm"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="qdzh" column="qdzh"/>
		<result property="zdzh" column="zdzh"/>
		<result property="qzlc" column="qzlc"/>
		<result property="hdlc" column="hdlc"/>
		<result property="yjsdj" column="yjsdj"/>
		<result property="ylmlx" column="ylmlx"/>
		<result property="ylmkd" column="ylmkd"/>
		<result property="ylmhd" column="ylmhd"/>
		<result property="dzxkd" column="dzxkd"/>
		<result property="lmjg" column="lmjg"/>
		<result property="aym" column="aym"/>
		<result property="asl" column="asl"/>
		<result property="glf" column="glf"/>
	</resultMap>
	<select id="queryYhdzxList" parameterType="java.util.Map" resultMap="yhdzx_jh">
		select * from (
			select rownum as num,t.* from (
	    		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
	       		where 1=1 
	       		<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
					and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
				</if>
				<if test="jh.sbnf!=null and jh.sbnf!=''">
					and jh.sbnf =#{jh.sbnf}
				</if>
				<if test="jh.sbzt!=null and jh.sbzt!=''">
					and jh.sbzt=#{jh.sbzt}
				</if>
				<if test="jh.spzt!=null and jh.spzt!=''">
					and jh.spzt=#{jh.spzt}
				</if>
				<if test="lx.gydwdm!=null and lx.gydwdm!=''">
					and lx.gydwdm like #{lx.gydwdm}
				</if>
				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
					and lx.xzqhdm like #{lx.xzqhdm}
				</if>
				<if test="lx.lxmc!=null and lx.lxmc!=''">
					and lx.lxmc like '%'||#{lx.lxmc}||'%'
				</if>
				<if test="lx.lxbm!=null and lx.lxbm!=''">
					and lx.lxbm like '%'||#{lx.lxbm}||'%'
				</if>
				<if test="lx.yjsdj!=null and lx.yjsdj!=''">
					and lx.yjsdj=#{lx.yjsdj}
				</if>
				<if test="lx.tsdq!=null and lx.tsdq!=''">
					and lx.xzqhdm in (
						select B.XZQHDM from BT_XZQHTSDQ b where B.AREACODE=#{lx.tsdq})
				</if>
	       		order by jh.sbnf,jh.sbzt,jh.spzt
	       		) t
	       	)
		where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="queryYhdzxCount" parameterType="java.util.Map" resultType="int">
		select count(*) from plan_yhdzx jh left join plan_lx_yhdzx lx 
		on (jh.id=lx.jhid) where 1=1
		<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
				and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
			</if>
			<if test="jh.sbnf!=null and jh.sbnf!=''">
				and jh.sbnf =#{jh.sbnf}
			</if>
			<if test="jh.sbzt!=null and jh.sbzt!=''">
				and jh.sbzt=#{jh.sbzt}
			</if>
			<if test="jh.spzt!=null and jh.spzt!=''">
				and jh.spzt=#{jh.spzt}
			</if>
			<if test="lx.gydwdm!=null and lx.gydwdm!=''">
				and lx.gydwdm like #{lx.gydwdm}
			</if>
			<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				and lx.xzqhdm like #{lx.xzqhdm}
			</if>
			<if test="lx.lxmc!=null and lx.lxmc!=''">
				and lx.lxmc like '%'||#{lx.lxmc}||'%'
			</if>
			<if test="lx.lxbm!=null and lx.lxbm!=''">
				and lx.lxbm like '%'||#{lx.lxbm}||'%'
			</if>
			<if test="lx.yjsdj!=null and lx.yjsdj!=''">
				and lx.yjsdj=#{lx.yjsdj}
			</if>
			<if test="lx.tsdq!=null and lx.tsdq!=''">
				and lx.xzqhdm in (
					select B.XZQHDM from BT_XZQHTSDQ b where B.AREACODE=#{lx.tsdq})
			</if> 
	</select>
	<select id="queryYhdzxById" parameterType="string" resultMap="yhdzx_jh">
		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid)
		where jh.id=#{id}
	</select>
	<update id="editYhdzxLxByid" parameterType="java.util.Map">
		update plan_lx_yhdzx lx set lx.lxmc=#{lx.lxmc},lx.lxbm=#{lx.lxbm},
		lx.qdzh=#{lx.qdzh},lx.zdzh=#{lx.zdzh},lx.qzlc=#{lx.qzlc},lx.hdlc=#{lx.hdlc},
		lx.dzxkd=#{lx.dzxkd},lx.lmjg=#{lx.lmjg},lx.aym=#{lx.aym},
		lx.asl=#{lx.asl},lx.glf=#{lx.glf}
		where lx.lxid=#{lx.lxid}
	</update>
	<update id="editYhdzxById" parameterType="java.util.Map">
		update plan_yhdzx jh set jh.sbnf=#{jh.sbnf},jh.jhkgsj=#{jh.jhkgsj},jh.jhwgsj=#{jh.jhwgsj},
		jh.classify=#{jh.classify},jh.aadt=#{jh.aadt},jh.pqi=#{jh.pqi},jh.dianceng=#{jh.dianceng},jh.jiceng=#{jh.jiceng},
		jh.surface=#{jh.surface},jh.reportingfee=#{jh.reportingfee},jh.mark=#{jh.mark},
		jh.plandownnumber=#{jh.plandownnumber},jh.xdsj=#{jh.xdsj},
		jh.constructnumber=#{jh.constructnumber},jh.replynumber=#{jh.replynumber},
		jh.devisenumbder=#{jh.devisenumbder},jh.description=#{jh.description},
		jh.xchsqk=#{jh.xchsqk},jh.remarks=#{jh.remarks},jh.qtbz=#{jh.qtbz},
		jh.fee=#{jh.fee},jh.newfee=#{jh.newfee},jh.totalplacefund=#{jh.totalplacefund},
		jh.totalsubsidyfund=#{jh.totalsubsidyfund},jh.totalinvest=#{jh.totalinvest}
		<!-- 
		jh.accumulativesubsidyfund=#{jh.accumulativesubsidyfund},
		jh.nowyearsubsidyfund=#{jh.nowyearsubsidyfund},
		 -->
		where jh.id=#{jh.id}
	</update>
	<update id="editYhdzxStatus" parameterType="plan_yhdzx">
		update plan_yhdzx set 
			<if test="sbbm!=null">sbbm=(select name from XTGL_DEPARTMENT t where t.id = #{sbbm}),</if>
			<if test="sbsj!=null">sbsj=#{sbsj},</if>
			<if test="sbzt!=null">sbzt=#{sbzt},</if>
			<if test="spbm!=null">spbm=(select name from XTGL_DEPARTMENT t where t.id = #{spbm}),</if>
			<if test="spsj!=null">spsj=#{spsj},</if>
			<if test="spzt!=null">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<delete id="dropYhdzxById" parameterType="java.util.List">
		delete from plan_yhdzx jh where jh.id =#{id}
	</delete>
	<insert id="insertYhdzx_lx" parameterType="hashMap">
		insert into plan_lx_yhdzx (lxid,jhid,gydwmc,gydwdm,xzqhdm,xzqhmc,
			lxmc,lxbm,qdzh,zdzh,qzlc,hdlc,
			yjsdj,ylmkd,ylmhd,ylmlx,DZXKD,
			tbbm,tbbmdm,tbsj) 
		values (
			sys_guid(),#{jhid},#{0},(select id from XTGL_DEPARTMENT t where t.name = #{0}),#{1},#{2},
			#{3},#{4},#{5},#{6},#{7},#{8},
			#{9},#{10},#{11},#{12},#{18},
			(select name from XTGL_DEPARTMENT t where t.id = #{gydwdm}),#{gydwdm},#{tbsj})
	</insert>
	<insert id="insertYhdzx_jh" parameterType="hashMap">
		insert into plan_yhdzx (
	    	id,sbnf,classify,jhkgsj,jhwgsj,xdsj,dianceng,
	    	jiceng,surface,reportingfee,totalinvest,
	    	mark,constructnumber,replynumber,devisenumbder,
	    	plandownnumber,remarks,qtbz,tbbm,tbsj <!-- -->)
		values (
			#{jhid},#{13},#{14},to_date(#{15},'yyyy-mm-dd'),to_date(#{16},'yyyy-mm-dd'),to_date(#{17},'yyyy-mm-dd'),#{19},
			#{20},#{21},#{22},#{23},
			#{24},#{25},#{26},#{27},
			#{28},#{29},#{30},(select name from XTGL_DEPARTMENT t where t.id = #{gydwdm}),#{tbsj} <!-- -->)
	</insert>
	<select id="querySumYhdzx" resultMap="yhdzx_jh" parameterType="java.util.Map">
		select count(id) as id,sum(qzlc) as qzlc,sum(hdlc) as hdlc,
		sum(TOTALINVEST) as totalinvest,sum(totalsubsidyfund) as totalsubsidyfund from (
			select count(jh.id) as id,sum(lx.qzlc) as qzlc,sum(lx.hdlc) as hdlc,
			sum(jh.TOTALINVEST) as totalinvest,sum(jh.totalsubsidyfund) as totalsubsidyfund
			from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id) 
			where 1=1
			<if test="lx.gydwdm!=null and lx.gydwdm!=''">
				and lx.gydwdm like #{lx.gydwdm}
			</if>
			<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
				and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
			</if>
			<if test="jh.sbzt!=null and jh.sbzt!=''">
				and jh.sbzt=#{jh.sbzt}
			</if>
			<if test="jh.spzt!=null and jh.spzt!=''">
				and jh.spzt=#{jh.spzt}
			</if>
			group by jh.id)
	</select>
	<select id="dropYhdzxLxByJhid" parameterType="java.util.List">
		delete from plan_lx_yhdzx where jhid=#{String}
	</select>
	<select id="queryTjJeAndSl" resultType="treenode" parameterType="java.util.Map">
		select t.parent as id,xz.name as name,NVL(sum(t.je),0) as text,sum(sl) as parent from (
          select distinct xt.parent,lx.xzqhdm,lx.xzqhmc,jh.sbnf,jh.id,
            (select sum(jh1.newfee) from plan_yhdzx jh1 left join plan_lx_yhdzx lx1 on (jh1.id=lx1.jhid) right join xtgl_xzqh xt1 on (lx1.xzqhdm=xt1.id) 
            where jh1.sbnf=#{nf} and jh1.id=jh.id group by jh1.id) as je,
            (select count(jh1.id) from plan_yhdzx jh1 where jh1.sbnf=#{nf} and jh1.id=jh.id) as sl
          from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) right join xtgl_xzqh xt on (lx.xzqhdm=xt.id) order by xt.parent
      ) t join xtgl_xzqh xz on(t.parent=xz.id) group by t.parent,xz.name order by t.parent
	</select>
	<select id="queryJhktj2" resultType="treenode" parameterType="java.util.Map">
		select t.sbnf as id,sum(t.totalsubsidyfund) as text,count(t.totalsubsidyfund) as name from (
       		select distinct jh.id,lx.xzqhdm,jh.sbnf,jh.totalsubsidyfund
       		from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) where lx.xzqhdm like rtrim(#{xzqhdm},'0')||'%') t
		where t.sbnf>=#{start} and <![CDATA[t.sbnf<=#{end}]]> group by t.sbnf
	</select>
	<select id="queryJhktjt2" resultType="string" parameterType="java.util.Map">
		select NVL(sum(t.totalsubsidyfund),0) from (
       		select distinct jh.id,lx.xzqhdm,jh.sbnf,jh.totalsubsidyfund
       		from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
       		where lx.xzqhdm like #{xzqhdm} and sbnf=#{nf}) t
		group by t.sbnf
	</select>
	<select id="queryJhktjt3" resultType="treenode" parameterType="java.util.Map">
		select sbnf as name,sum(totalsubsidyfund) as text from (
		select distinct jh.id,jh.sbnf,jh.totalsubsidyfund from plan_yhdzx jh left join plan_lx_yhdzx lx on jh.id=lx.jhid
		where jh.sbnf>=#{start} and <![CDATA[jh.sbnf<=#{end}]]> and lx.xzqhdm like #{xzqhdm}) s group by s.sbnf
	</select>
	<select id="queryGcktj" resultType="treenode" parameterType="java.util.Map">
		select (r.kgzt+r.jgzt) as id,count(r.kgzt+r.jgzt) as name,sum(r.totalsubsidyfund) as text,sum(btz+qttz) as parent from (
       		select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz
       			from gcgl_gcgzgj gcgl right join (
            		select distinct jh.id,jh.kgzt,jh.jgzt,jh.totalsubsidyfund from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
                where lx.xzqhdm like #{xzqhdm} and jh.sbnf=#{nf} and jh.spzt='1' and jh.jh_sbthcd='6')
       		jh_lx on (gcgl.jhid=jh_lx.id) group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund
		) r group by r.kgzt,r.jgzt order by r.kgzt,r.jgzt
	</select>
	<select id="queryGcktjt" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.totalsubsidyfund),0) as text,nvl(sum(btz+qttz),0) as parent from (
       		select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz
       			from gcgl_gcgzgj gcgl right join (
            		select distinct jh.id,jh.kgzt,jh.jgzt,jh.totalsubsidyfund from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
                where jh.spzt='1' and jh.jh_sbthcd='6'
                <if test="xzqhdm!=null and xzqhdm!=''">
                	and lx.xzqhdm like #{xzqhdm}
                </if>
                )
       		jh_lx on (gcgl.jhid=jh_lx.id) group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund
		) r
	</select>
	<select id="queryGcktj2" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.bn),0) as id,nvl(count(r.bn),0) as name,nvl(sum(r.fbn),0) as text,nvl(count(r.fbn),0) as parent from (
		   	select distinct jh.id,jh.kgzt,jh.jgzt,
		   	(select y.totalsubsidyfund from plan_yhdzx y where y.sbnf=#{nf} and y.id=jh.id) as bn,
		   	(select y.totalsubsidyfund from plan_yhdzx y where #{nf}>y.sbnf and y.id=jh.id) as fbn 
		   	from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
		where jh.spzt='1' and jh.jh_sbthcd='6'and lx.xzqhdm like #{xzqhdm} order by jh.id) r
	</select>
</mapper>
