<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.plan_yhdzx">
	<resultMap type="plan_yhdzx" id="yhdzx_jh">
		<id property="id" column="id" />
		<result property="tbbm" column="tbbm"/>
		<result property="xdsj" column="xdsj"/>
		<result property="sbnf" column="sbnf"/>
		<result property="xmmc" column="xmmc"/>
		<result property="classify" column="classify"/>
		<result property="fee" column="fee"/>
		<result property="newfee" column="newfee"/>
		<result property="reportingfee" column="reportingfee"/>
		<result property="totalinvest" column="totalinvest"/>
		<result property="totalsubsidyfund" column="totalsubsidyfund"/>
		<result property="nowyearsubsidyfund" column="nowyearsubsidyfund"/>
		<result property="accumulativesubsidyfund" column="accumulativesubsidyfund"/>
		<result property="planhistorycompara" column="planhistorycompara"/>
		<result property="dianceng" column="dianceng"/>
		<result property="jiceng" column="jiceng"/>
		<result property="surface" column="surface"/>
		<result property="mark" column="mark"/>
		<result property="pqi" column="pqi"/>
		<result property="aadt" column="aadt"/>
		<result property="constructnumber" column="constructnumber"/>
		<result property="replynumber" column="replynumber"/>
		<result property="devisenumber" column="devisenumber"/>
		<result property="plandownnumber" column="plandownnumber"/>
		<result property="description" column="description"/>
		<result property="xchsqk" column="xchsqk"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="kgzt" column="kgzt"/>
		<result property="jgzt" column="jgzt"/>
		<result property="remarks" column="remarks"/>
		<result property="qtbz" column="qtbz"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<result property="totalplacefund" column="totalplacefund"/>
		<result property="devisenumbder" column="devisenumbder"/>
		<result property="pqi" column="pqi"/>
		<collection property="plan_lx_yhdzxs" ofType="plan_lx_yhdzx" resultMap="yhdzx_lx"/>
	</resultMap>
	<resultMap type="plan_lx_yhdzx" id="yhdzx_lx">
		<id property="lxid" column="lxid" />
		<result property="lxbm" column="lxbm"/>
		<result property="bhnr" column="bhnr"/>
		<result property="lxmc" column="lxmc"/>
		<result property="gydwmc" column="gydwmc"/>
		<result property="gydwdm" column="gydwdm"/>
		<result property="xzqhdm" column="xzqhdm"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="qdzh" column="qdzh"/>
		<result property="zdzh" column="zdzh"/>
		<result property="qzlc" column="qzlc"/>
		<result property="hdlc" column="hdlc"/>
		<result property="yjsdj" column="yjsdj"/>
		<result property="ylmlx" column="ylmlx"/>
		<result property="ylmkd" column="ylmkd"/>
		<result property="ylmhd" column="ylmhd"/>
		<result property="dzxkd" column="dzxkd"/>
		<result property="lmjg" column="lmjg"/>
		<result property="aym" column="aym"/>
		<result property="asl" column="asl"/>
		<result property="glf" column="glf"/>
		<result property="tsdq" column="tsdq"/>
	</resultMap>
	<select id="queryYhdzxList" parameterType="java.util.Map" resultMap="yhdzx_jh">
		select t1.*,t2.* from (
			select rownum as num,t.* from (
	    		select jh.* from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
	       		where 1=1 
	       		<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">	
			 		and jh.jh_sbthcd=#{jh.jh_sbthcd}
				</if>
				<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
					and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
				</if>
				<if test="jh.sbnf!=null and jh.sbnf!=''">
					and jh.sbnf =#{jh.sbnf}
				</if>
				<if test="jh.sbzt!=null and jh.sbzt!=''">
					and jh.sbzt=#{jh.sbzt}
				</if>
				<if test="jh.spzt!=null and jh.spzt!=''">
					and jh.spzt=#{jh.spzt}
				</if>
				<if test="jh.kgzt!=null and jh.kgzt!=''">
					and jh.kgzt=#{jh.kgzt}
	 			</if>
	 			<if test="jh.jgzt!=null and jh.jgzt!=''">
	 				and jh.jgzt=#{jh.jgzt}
	 			</if>
				<if test="lx.gydwdm!=null and lx.gydwdm!=''">
					and ${lx.gydwdm}
				</if>
				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
					and ${lx.xzqhdm}
				</if>
				<if test="lx.lxmc!=null and lx.lxmc!=''">
					and lx.lxmc like '%'||#{lx.lxmc}||'%'
				</if>
				<if test="lx.lxbm!=null and lx.lxbm!=''">
					and lx.lxbm like '%'||#{lx.lxbm}||'%'
				</if>
				<if test="lx.yjsdj!=null and lx.yjsdj!=''">
					and lx.yjsdj=#{lx.yjsdj}
				</if>
				<if test="lx.tsdq!=null and lx.tsdq!=''">
					and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				</if>
	       		order by jh.sbnf desc,jh.jh_sbthcd) t ) t1
	       	left join plan_lx_yhdzx t2 on (t1.id=t2.jhid) 
		where <![CDATA[ t1.num <= (#{page} * #{rows})]]> and t1.num>(#{page}-1)*#{rows} order by t1.sbnf desc,t1.jh_sbthcd
	</select>
	<select id="queryYhdzxList2" parameterType="java.util.Map" resultMap="yhdzx_jh">
		select * from (
			select rownum as num,t.* from (
	    		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
	       		where 1=1 
	       		<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">	
			 		and jh.jh_sbthcd=#{jh.jh_sbthcd}
				</if>
				<if test="jh.sbnf!=null and jh.sbnf!=''">
					and jh.sbnf =#{jh.sbnf}
				</if>
				<if test="jh.kgzt!=null and jh.kgzt!=''">
					and jh.kgzt=#{jh.kgzt}
	 			</if>
	 			<if test="jh.jgzt!=null and jh.jgzt!=''">
	 				and jh.jgzt=#{jh.jgzt}
	 			</if>
				<if test="lx.gydwdm!=null and lx.gydwdm!=''">
					and ${lx.gydwdm}
				</if>
				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
					and ${lx.xzqhdm}
				</if>
				<if test="lx.lxmc!=null and lx.lxmc!=''">
					and lx.lxmc like '%'||#{lx.lxmc}||'%'
				</if>
				<if test="lx.lxbm!=null and lx.lxbm!=''">
					and lx.lxbm like '%'||#{lx.lxbm}||'%'
				</if>
				<if test="lx.yjsdj!=null and lx.yjsdj!=''">
					and lx.yjsdj=#{lx.yjsdj}
				</if>
				<if test="lx.tsdq!=null and lx.tsdq!=''">
					and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				</if>
	       		order by jh.sbnf desc,jh.jh_sbthcd) t order by t.sbnf desc,t.jh_sbthcd)
	</select>
	<select id="queryYhdzxCount" parameterType="java.util.Map" resultType="int">
		select count(*) from plan_yhdzx jh left join plan_lx_yhdzx lx 
		on (jh.id=lx.jhid) where 1=1
			<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">	
		 		and jh.jh_sbthcd=#{jh.jh_sbthcd}
			</if>
			<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
				and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
			</if>
			<if test="jh.sbnf!=null and jh.sbnf!=''">
				and jh.sbnf =#{jh.sbnf}
			</if>
			<if test="jh.sbzt!=null and jh.sbzt!=''">
				and jh.sbzt=#{jh.sbzt}
			</if>
			<if test="jh.spzt!=null and jh.spzt!=''">
				and jh.spzt=#{jh.spzt}
			</if>
			<if test="jh.kgzt!=null and jh.kgzt!=''">
				and jh.kgzt=#{jh.kgzt}
			</if>
	 		<if test="jh.jgzt!=null and jh.jgzt!=''">
	 			and jh.jgzt=#{jh.jgzt}
	 		</if>
			<if test="lx.gydwdm!=null and lx.gydwdm!=''">
				and ${lx.gydwdm}
			</if>
			<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				and ${lx.xzqhdm}
			</if>
			<if test="lx.lxmc!=null and lx.lxmc!=''">
				and lx.lxmc like '%'||#{lx.lxmc}||'%'
			</if>
			<if test="lx.lxbm!=null and lx.lxbm!=''">
				and lx.lxbm like '%'||#{lx.lxbm}||'%'
			</if>
			<if test="lx.yjsdj!=null and lx.yjsdj!=''">
				and lx.yjsdj=#{lx.yjsdj}
			</if>
			<if test="lx.tsdq!=null and lx.tsdq!=''">
				and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
			</if> 
	</select>
	<select id="queryYhdzxById" parameterType="string" resultMap="yhdzx_jh">
		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid)
		where jh.id=#{id} order by lx.lmjg desc
	</select>
	<update id="editYhdzxLxById" parameterType="java.util.Map">
		update plan_lx_yhdzx lx set
			<if test="lx.lxmc!=null">lx.lxmc=#{lx.lxmc}</if>
			<if test="lx.lxbm!=null">,lx.lxbm=#{lx.lxbm}</if>
			<if test="lx.qdzh!=null">,lx.qdzh=#{lx.qdzh}</if>
			<if test="lx.zdzh!=null">,lx.zdzh=#{lx.zdzh}</if>
			<if test="lx.qzlc!=null">,lx.qzlc=#{lx.qzlc}</if>
			<if test="lx.hdlc!=null">,lx.hdlc=#{lx.hdlc}</if>
			<if test="lx.ylmlx!=null">,lx.ylmlx=#{lx.ylmlx}</if>
			<if test="lx.ylmkd!=null">,lx.ylmkd=#{lx.ylmkd}</if>
			<if test="lx.ylmhd!=null">,lx.ylmhd=#{lx.ylmhd}</if>
			<if test="lx.yjsdj!=null">,lx.yjsdj=#{lx.yjsdj}</if>
			<if test="lx.xzqhdm!=null">,lx.xzqhdm=#{lx.xzqhdm}</if>
			<if test="lx.xzqhmc!=null">,lx.xzqhmc=#{lx.xzqhmc}</if>
			<if test="lx.gydwmc!=null">,lx.gydwmc=#{lx.gydwmc}</if>
			<if test="lx.gydwdm!=null">,lx.gydwdm=#{lx.gydwdm}</if>
			<if test="lx.dzxkd!=null">,lx.dzxkd=#{lx.dzxkd}</if>
			<if test="lx.bhnr!=null">,lx.bhnr=#{lx.bhnr}</if>
			<if test="lx.lmjg!=null">,lx.lmjg=#{lx.lmjg}</if>
			<if test="lx.aym!=null">,lx.aym=#{lx.aym}</if>
			<if test="lx.asl!=null">,lx.asl=#{lx.asl}</if>
			<if test="lx.glf!=null">,lx.glf=#{lx.glf}</if>
		where lx.lxid=#{lx.lxid}
	</update>
	<update id="editYhdzxById" parameterType="java.util.Map">
		update plan_yhdzx jh set jh.id=#{jh.id}
		<if test="jh.sbnf!=null and jh.sbnf!=''">,jh.sbnf=#{jh.sbnf}</if>
		<if test="jh.jhkgsj!=null and jh.jhkgsj!=''">,jh.jhkgsj=#{jh.jhkgsj}</if>
		<if test="jh.jhwgsj!=null and jh.jhwgsj!=''">,jh.jhwgsj=#{jh.jhwgsj}</if>
		<if test="jh.xdsj!=null and jh.xdsj!=''">,jh.xdsj=#{jh.xdsj}</if>
		<if test="jh.xmmc!=null">,jh.xmmc=#{jh.xmmc}</if>
		<if test="jh.classify!=null">,jh.classify=#{jh.classify}</if>
		<if test="jh.aadt!=null">,jh.aadt=#{jh.aadt}</if>
		<if test="jh.pqi!=null">,jh.pqi=#{jh.pqi}</if>
		<if test="jh.dianceng!=null">,jh.dianceng=#{jh.dianceng}</if>
		<if test="jh.jiceng!=null">,jh.jiceng=#{jh.jiceng}</if>
		<if test="jh.surface!=null">,jh.surface=#{jh.surface}</if>
		<if test="jh.reportingfee!=null">,jh.reportingfee=#{jh.reportingfee}</if>
		<if test="jh.mark!=null">,jh.mark=#{jh.mark}</if>
		<if test="jh.plandownnumber!=null">,jh.plandownnumber=#{jh.plandownnumber}</if>
		<if test="jh.constructnumber!=null">,jh.constructnumber=#{jh.constructnumber}</if>
		<if test="jh.replynumber!=null">,jh.replynumber=#{jh.replynumber}</if>
		<if test="jh.devisenumbder!=null">,jh.devisenumbder=#{jh.devisenumbder}</if>
		<if test="jh.description!=null">,jh.description=#{jh.description}</if>
		<if test="jh.xchsqk!=null">,jh.xchsqk=#{jh.xchsqk}</if>
		<if test="jh.remarks!=null">,jh.remarks=#{jh.remarks}</if>
		<if test="jh.qtbz!=null">,jh.qtbz=#{jh.qtbz}</if>
		<if test="jh.fee!=null">,jh.fee=#{jh.fee}</if>
		<if test="jh.newfee!=null">,jh.newfee=#{jh.newfee}</if>
		<if test="jh.totalplacefund!=null">,jh.totalplacefund=#{jh.totalplacefund}</if>
		<if test="jh.totalsubsidyfund!=null">,jh.totalsubsidyfund=#{jh.totalsubsidyfund}</if>
		<if test="jh.totalinvest!=null">,jh.totalinvest=#{jh.totalinvest}</if>
		<!--
		jh.accumulativesubsidyfund=#{jh.accumulativesubsidyfund},
		jh.nowyearsubsidyfund=#{jh.nowyearsubsidyfund},
		 -->
		where jh.id=#{jh.id}
	</update>
	<update id="editYhdzxStatus" parameterType="plan_yhdzx">
		update plan_yhdzx set 
			<if test="sbbm!=null">sbbm=(select name from XTGL_DEPARTMENT t where t.id = #{sbbm}),</if>
			<if test="sbsj!=null">sbsj=#{sbsj},</if>
			<if test="sbzt!=null">sbzt=#{sbzt},</if>
			<if test="spbm!=null">spbm=(select name from XTGL_DEPARTMENT t where t.id = #{spbm}),</if>
			<if test="spsj!=null">spsj=#{spsj},</if>
			<if test="spzt!=null">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<update id="editYhdzxStatusBatch" parameterType="java.util.List">
		update plan_yhdzx set 
			<if test="sbbm!=null">sbbm=(select name from XTGL_DEPARTMENT t where t.id = #{sbbm}),</if>
			<if test="sbsj!=null">sbsj=#{sbsj},</if>
			<if test="sbzt!=null">sbzt=#{sbzt},</if>
			<if test="spbm!=null">spbm=(select name from XTGL_DEPARTMENT t where t.id = #{spbm}),</if>
			<if test="spsj!=null">spsj=#{spsj},</if>
			<if test="spzt!=null">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<delete id="dropYhdzxById" parameterType="java.util.List">
		delete from plan_yhdzx jh where jh.id =#{id}
	</delete>
	<insert id="insertYhdzx_lx" parameterType="hashMap">
		insert into plan_lx_yhdzx (lxid,jhid,gydwmc,gydwdm,xzqhdm,xzqhmc,
			lxmc,lxbm,qdzh,zdzh,qzlc,hdlc,
			yjsdj,ylmkd,ylmhd,ylmlx,DZXKD,
			tbbm,tbbmdm,tbsj) 
		values (
			sys_guid(),#{jhid},#{0},(select id from XTGL_DEPARTMENT t where t.name = #{0}),#{1},#{2},
			#{3},#{4},#{5},#{6},#{7},#{8},
			#{9},#{10},#{11},#{12},#{20},
			(select name from XTGL_DEPARTMENT t where t.id = #{tbbm}),#{tbbm},#{tbsj})
	</insert>
	<insert id="insertYhdzx_jh" parameterType="hashMap">
		insert into plan_yhdzx (
	    	id,xmmc,sbnf,classify,jhkgsj,jhwgsj,xdsj,dianceng,
	    	jiceng,surface,reportingfee,totalinvest,
	    	mark,constructnumber,replynumber,devisenumbder,
	    	plandownnumber,remarks,qtbz,tbbm,tbsj,sjlmlx,jh_sbthcd<!-- -->)
		values (
			#{jhid},#{14},#{15},#{16},to_date(#{17},'yyyy-mm-dd'),to_date(#{18},'yyyy-mm-dd'),to_date(#{19},'yyyy-mm-dd'),#{21},
			#{22},#{23},#{24},#{25},
			#{26},#{27},#{28},#{29},
			#{30},#{31},#{32},#{tbbm},#{tbsj},#{13},#{jh_sbthcd}<!-- -->)
	</insert>
	<select id="querySumYhdzx" resultMap="yhdzx_jh" parameterType="java.util.Map">
		select count(id) as id,sum(qzlc) as qzlc,sum(hdlc) as hdlc,
		sum(TOTALINVEST) as totalinvest,sum(totalsubsidyfund) as totalsubsidyfund from (
			select count(jh.id) as id,sum(lx.qzlc) as qzlc,sum(lx.hdlc) as hdlc,
			sum(jh.TOTALINVEST) as totalinvest,sum(jh.totalsubsidyfund) as totalsubsidyfund
			from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id) 
			where 1=1
			<if test="lx.gydwdm!=null and lx.gydwdm!=''">
				and ${lx.gydwdm}
			</if>
			<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				and ${lx.xzqhdm}
			</if>
			<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">	
		 		and jh.jh_sbthcd=#{jh.jh_sbthcd}
			</if>
			<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
				and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
			</if>
			<if test="jh.kgzt!=null and jh.kgzt!=''">
				and jh.kgzt=#{jh.kgzt}
			</if>
	 		<if test="jh.jgzt!=null and jh.jgzt!=''">
	 			and jh.jgzt=#{jh.jgzt}
	 		</if>
			<if test="jh.sbnf!=null and jh.sbnf!=''">
				and jh.sbnf =#{jh.sbnf}
			</if>
			<if test="jh.sbzt!=null and jh.sbzt!=''">
				and jh.sbzt=#{jh.sbzt}
			</if>
			<if test="jh.spzt!=null and jh.spzt!=''">
				and jh.spzt=#{jh.spzt}
			</if>
			<if test="lx.tsdq!=null and lx.tsdq!=''">
				and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
			</if> 
			group by jh.id)
	</select>
	<select id="dropYhdzxLxByJhid" parameterType="java.util.List">
		delete from plan_lx_yhdzx where jhid=#{String}
	</select>
	<select id="queryTjJeAndSl" resultType="treenode" parameterType="java.util.Map">
		select t.parent as id,xz.name as name,NVL(sum(t.je),0) as text,sum(sl) as parent from (
          select distinct xt.parent,lx.xzqhdm,lx.xzqhmc,jh.sbnf,jh.id,
            (select sum(jh1.newfee) from plan_yhdzx jh1 left join plan_lx_yhdzx lx1 on (jh1.id=lx1.jhid) right join xtgl_xzqh xt1 on (lx1.xzqhdm=xt1.id) 
            where jh1.sbnf=#{nf} and jh1.id=jh.id group by jh1.id) as je,
            (select count(jh1.id) from plan_yhdzx jh1 where jh1.sbnf=#{nf} and jh1.id=jh.id) as sl
          from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) right join xtgl_xzqh xt on (lx.xzqhdm=xt.id) order by xt.parent
      ) t join xtgl_xzqh xz on(t.parent=xz.id) group by t.parent,xz.name order by t.parent
	</select>
	<select id="queryJhktj2" resultType="treenode" parameterType="java.util.Map">
		select t.sbnf as id,sum(t.totalsubsidyfund) as text,count(t.totalsubsidyfund) as name from (
       		select distinct jh.id,lx.xzqhdm,jh.sbnf,jh.totalsubsidyfund
       		from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) where lx.xzqhdm like rtrim(#{xzqhdm},'0')||'%') t
		where t.sbnf>=#{start} and <![CDATA[t.sbnf<=#{end}]]> group by t.sbnf
	</select>
	<select id="queryJhktjt2" resultType="string" parameterType="java.util.Map">
		select NVL(sum(t.totalsubsidyfund),0) from (
       		select distinct jh.id,lx.xzqhdm,jh.sbnf,jh.totalsubsidyfund
       		from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
       		where lx.xzqhdm like #{xzqhdm} and sbnf=#{nf}) t
		group by t.sbnf
	</select>
	<select id="queryJhktjt3" resultType="treenode" parameterType="java.util.Map">
		select sbnf as name,sum(totalsubsidyfund) as text from (
		select distinct jh.id,jh.sbnf,jh.totalsubsidyfund from plan_yhdzx jh left join plan_lx_yhdzx lx on jh.id=lx.jhid
		where jh.sbnf>=#{start} and <![CDATA[jh.sbnf<=#{end}]]> and lx.xzqhdm like #{xzqhdm}) s group by s.sbnf
	</select>
	<select id="queryGcktj" resultType="treenode" parameterType="java.util.Map">
		select (r.kgzt+r.jgzt) as id,count(r.kgzt+r.jgzt) as name,sum(r.totalsubsidyfund) as text,sum(btz+qttz) as parent from (
       		select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz
       			from gcgl_gcgzgj gcgl right join (
            		select distinct jh.id,jh.kgzt,jh.jgzt,jh.totalsubsidyfund from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
                where lx.xzqhdm like #{xzqhdm} and jh.sbnf=#{nf} and jh.spzt='1' and jh.jh_sbthcd='6')
       		jh_lx on (gcgl.jhid=jh_lx.id) group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund
		) r group by r.kgzt,r.jgzt order by r.kgzt,r.jgzt
	</select>
	<select id="queryGcktjt" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.totalsubsidyfund),0) as text,nvl(sum(btz+qttz),0) as parent from (
       		select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz
       			from gcgl_gcgzgj gcgl right join (
            		select distinct jh.id,jh.kgzt,jh.jgzt,jh.totalsubsidyfund from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
                where jh.spzt='1' and jh.jh_sbthcd='6'
                <if test="xzqhdm!=null and xzqhdm!=''">
                	and lx.xzqhdm like #{xzqhdm}
                </if>
                )
       		jh_lx on (gcgl.jhid=jh_lx.id) group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.totalsubsidyfund
		) r
	</select>
	<select id="queryGcktj2" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.bn),0) as id,nvl(count(r.bn),0) as name,nvl(sum(r.fbn),0) as text,nvl(count(r.fbn),0) as parent from (
		   	select distinct jh.id,jh.kgzt,jh.jgzt,
		   	(select y.totalsubsidyfund from plan_yhdzx y where y.sbnf=#{nf} and y.id=jh.id) as bn,
		   	(select y.totalsubsidyfund from plan_yhdzx y where #{nf}>y.sbnf and y.id=jh.id) as fbn 
		   	from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id)
		where jh.spzt='1' and jh.jh_sbthcd='6'and lx.xzqhdm like #{xzqhdm} order by jh.id) r
	</select>
	<insert id="insertYhdzxLx" parameterType="plan_lx_yhdzx">
		insert into plan_lx_yhdzx (lxid,jhid
			<if test="gydwmc!=null">,gydwmc</if>
			<if test="gydwdm!=null">,gydwdm</if>
			<if test="xzqhdm!=null">,xzqhdm</if>
			<if test="xzqhmc!=null">,xzqhmc</if>
			<if test="lxmc!=null">,lxmc</if>
			<if test="lxbm!=null">,lxbm</if>
			<if test="qdzh!=null">,qdzh</if>
			<if test="zdzh!=null">,zdzh</if>
			<if test="qzlc!=null">,qzlc</if>
			<if test="hdlc!=null">,hdlc</if>
			<if test="yjsdj!=null">,yjsdj</if>
			<if test="ylmkd!=null">,ylmkd</if>
			<if test="ylmhd!=null">,ylmhd</if>
			<if test="ylmlx!=null">,ylmlx</if>
			<if test="dzxkd!=null">,DZXKD</if>
			<if test="tbbmdm!=null">,tbbm</if>
			<if test="tbbmdm!=null">,tbbmdm</if>
			<if test="tbsj!=null">,tbsj</if>
			<if test="lmjg!=null">,lmjg</if>
			<if test="aym!=null">,aym</if>
			<if test="asl!=null">,asl</if>
			<if test="glf!=null">,glf</if>
			<if test="bhnr!=null">,bhnr</if>
			<if test="tsdq!=null">,tsdq</if>) 
		values (sys_guid(),#{jhid}
			<if test="gydwmc!=null">,#{gydwmc}</if>
			<if test="gydwdm!=null">,#{gydwdm}</if>
			<if test="xzqhdm!=null">,#{xzqhdm}</if>
			<if test="xzqhmc!=null">,#{xzqhmc}</if>
			<if test="lxmc!=null">,#{lxmc}</if>
			<if test="lxbm!=null">,#{lxbm}</if>
			<if test="qdzh!=null">,#{qdzh}</if>
			<if test="zdzh!=null">,#{zdzh}</if>
			<if test="qzlc!=null">,#{qzlc}</if>
			<if test="hdlc!=null">,#{hdlc}</if>
			<if test="yjsdj!=null">,#{yjsdj}</if>
			<if test="ylmkd!=null">,#{ylmkd}</if>
			<if test="ylmhd!=null">,#{ylmhd}</if>
			<if test="ylmlx!=null">,#{ylmlx}</if>
			<if test="dzxkd!=null">,#{dzxkd}</if>
			<if test="tbbmdm!=null">,(select name from XTGL_DEPARTMENT t where t.id = #{tbbmdm})</if>
			<if test="tbbmdm!=null">,#{tbbmdm}</if>
			<if test="tbsj!=null">,#{tbsj}</if>
			<if test="lmjg!=null">,#{lmjg}</if>
			<if test="aym!=null">,#{aym}</if>
			<if test="asl!=null">,#{asl}</if>
			<if test="glf!=null">,#{glf}</if>
			<if test="bhnr!=null">,#{bhnr}</if>
			<if test="tsdq!=null">,#{tsdq}</if>)
	</insert>
	<insert id="insertYhdzxJh" parameterType="plan_yhdzx">
		insert into plan_yhdzx (
	    	id
	    	<if test="sbnf!=null">,sbnf</if>
	    	<if test="classify!=null">,classify</if>
	    	<if test="jhkgsj!=null">,jhkgsj</if>
	    	<if test="jhwgsj!=null">,jhwgsj</if>
	    	<if test="xdsj!=null">,xdsj</if>
	    	<if test="dianceng!=null">,dianceng</if>
	    	<if test="jiceng!=null">,jiceng</if>
	    	<if test="surface!=null">,surface</if>
	    	<if test="reportingfee!=null">,reportingfee</if>
	    	<if test="totalinvest!=null">,totalinvest</if>
	    	<if test="constructnumber!=null">,constructnumber</if>
	    	<if test="replynumber!=null">,replynumber</if>
	    	<if test="devisenumbder!=null">,devisenumbder</if>
	    	<if test="mark!=null">,mark</if>
	    	<if test="plandownnumber!=null">,plandownnumber</if>
	    	<if test="remarks!=null">,remarks</if>
	    	<if test="qtbz!=null">,qtbz</if>
	    	<if test="tbbm!=null">,tbbm</if>
	    	<if test="tbsj!=null">,tbsj</if>
	    	<if test="xmmc!=null">,xmmc</if>
	    	<if test="pqi!=null">,pqi</if>
	    	<if test="jh_sbthcd!=null">,jh_sbthcd</if>
	    	<if test="totalplacefund!=null">,totalplacefund</if>
	    	<if test="totalsubsidyfund!=null">,totalsubsidyfund</if>
	    	<if test="fee!=null and fee!=''">,fee</if>
	    	<if test="newfee!=null and newfee!=''">,newfee</if>
	    	<if test="aadt!=null and aadt!=''">,aadt</if>
	    	<if test="description!=null and description!=''">,description</if>
	    	<if test="xchsqk!=null and xchsqk!=''">,xchsqk</if>
	    	<if test="planhistorycompara!=null and planhistorycompara!=''">,Planhistorycompara</if>)
		values (
			#{id}
			<if test="sbnf!=null">,#{sbnf}</if>
	    	<if test="classify!=null">,#{classify}</if>
	    	<if test="jhkgsj!=null">,#{jhkgsj}</if>
	    	<if test="jhwgsj!=null">,#{jhwgsj}</if>
	    	<if test="xdsj!=null">,#{xdsj}</if>
	    	<if test="dianceng!=null">,#{dianceng}</if>
	    	<if test="jiceng!=null">,#{jiceng}</if>
	    	<if test="surface!=null">,#{surface}</if>
	    	<if test="reportingfee!=null">,#{reportingfee}</if>
	    	<if test="totalinvest!=null">,#{totalinvest}</if>
	    	<if test="constructnumber!=null">,#{constructnumber}</if>
	    	<if test="replynumber!=null">,#{replynumber}</if>
	    	<if test="devisenumbder!=null">,#{devisenumbder}</if>
	    	<if test="mark!=null">,#{mark}</if>
	    	<if test="plandownnumber!=null">,#{plandownnumber}</if>
	    	<if test="remarks!=null">,#{remarks}</if>
	    	<if test="qtbz!=null">,#{qtbz}</if>
	    	<if test="tbbm!=null">,#{tbbm}</if>
	    	<if test="tbsj!=null">,to_date(#{tbsj},'yyyy-mm-dd')</if>
	    	<if test="xmmc!=null">,#{xmmc}</if>
	    	<if test="pqi!=null">,#{pqi}</if>
	    	<if test="jh_sbthcd!=null">,#{jh_sbthcd}</if>
	    	<if test="totalplacefund!=null">,#{totalplacefund}</if>
	    	<if test="totalsubsidyfund!=null">,#{totalsubsidyfund}</if>
	    	<if test="fee!=null and fee!=''">,#{fee}</if>
	    	<if test="newfee!=null and newfee!=''">,#{newfee}</if>
	    	<if test="aadt!=null and aadt!=''">,#{aadt}</if>
	    	<if test="description!=null and description!=''">,#{description}</if>
	    	<if test="xchsqk!=null and xchsqk!=''">,#{xchsqk}</if>
	    	<if test="planhistorycompara!=null and planhistorycompara!=''">,#{planhistorycompara}</if>)
	</insert>
	<select id="yhdzxAutoCompleteLxbm" parameterType="plan_lx_yhdzx" resultType="plan_lx_yhdzx">
		select g.roadname as lxmc,g.roadcode as lxbm,min(g.roadstart) as qdzh,max(g.roadends) as zdzh,
		(max(g.roadends)-min(g.roadstart)) as qzlc,max(g.f114) as yjsdj,max(g.f116) as ylmlx,max(g.f018) as ylmkd
		from  GPSROAD g
		where substr(roadcode,1,1) in('G','S','X') and F048='1' and roadcode like #{lxbm}||'%'
		and roadcode like '%'||rtrim(#{xzqhdm},0)||'%'
		group by roadname,roadcode order by lxbm
	</select>
	<select id="queryJhExist" parameterType="plan_lx_yhdzx" resultType="int">
		select gj.gjCon+shuih.shCon+sj.sjCon+yh.yhCon from 
		(select count(*) gjCon from plan_lx_gcgj lx right join plan_gcgj jh on (lx.jhid=jh.id) 
		where lx.lxbm = #{lxbm} and <![CDATA[lx.qdzh<#{zdzh}]]> and lx.zdzh>#{qdzh}
		and jh.sbnf=#{jhid}) gj,
		(select count(*) shCon from plan_lx_shuih lx right join plan_shuih jh on (lx.jhid=jh.id) 
		where lx.lxbm=#{lxbm} and <![CDATA[lx.qdzh<=#{zdzh}]]> and lx.zdzh>=#{qdzh} 
		and jh.sbnf=#{jhid}) shuih,
		(select count(jh.id) sjCon from plan_lx_gcsj lx right join plan_gcsj jh on (lx.jhid=jh.id) 
		where lx.lxbm=#{lxbm} and <![CDATA[lx.qdzh<#{zdzh}]]> and lx.zdzh>#{qdzh}
		and jh.jhnf=#{jhid}) sj,
		(select count(jh.id) yhCon from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id) 
    	where lx.lxbm=#{lxbm} and <![CDATA[lx.qdzh<#{zdzh}]]> and lx.zdzh>#{qdzh}
    	and jh.sbnf=#{jhid}) yh
	</select>
	<select id="queryJlBylx" parameterType="plan_lx_yhdzx" resultType="int">
		SELECT C1.CON1+C2.CON2+shC1.CON1+shC2.CON2+sjC1.CON1+sjC2.Con2+yhC1.CON1+yhC2.CON2 FROM
		(select count(jh.id) CON1 from plan_lx_gcgj lx right join plan_gcgj jh on (lx.jhid=jh.id) 
		    where <![CDATA[lx.lxbm like #{lxbm}||'%' and (lx.qdzh<=${zdzh} or lx.zdzh>=${qdzh}) and jh.sbnf<#{jhid}]]>
		)C1,
		<![CDATA[(select count(*) CON2 from
		(select lx.lxbm,lx.qdzh,lx.zdzh from plan_lx_gcgj lx, plan_gcgj jh where lx.jhid=jh.id and jh.sbnf<#{jhid})  j,
		(select YLXBM,YQDZH,YZDZH from XTGL_LXSJ where XLXBM like #{lxbm}||'%' and XQDZH<=${zdzh} and XZDZH>=${qdzh}) k
		where j.lxbm=k.YLXBM and j.qdzh<k.YZDZH and j.zdzh>k.YQDZH) C2]]>,
		
		(select count(jh.id) CON1 from plan_lx_shuih lx right join plan_shuih jh on (lx.jhid=jh.id) 
		    where <![CDATA[lx.lxbm like #{lxbm}||'%' and (lx.qdzh<=${zdzh} or lx.zdzh>=${qdzh}) and jh.sbnf<#{jhid}]]>
		) shC1,
		<![CDATA[(select count(*) CON2 from
		(select lx.lxbm,lx.qdzh,lx.zdzh from plan_lx_shuih lx, plan_shuih jh where lx.jhid=jh.id and jh.sbnf<#{jhid})  j,
		(select YLXBM,YQDZH,YZDZH from XTGL_LXSJ where XLXBM like #{lxbm}||'%' and XQDZH<=${zdzh} and XZDZH>=${qdzh}) k
		where j.lxbm=k.YLXBM and j.qdzh<k.YZDZH and j.zdzh>k.YQDZH) shC2]]>,
		
		<![CDATA[(select count(jh.id) CON1 from plan_lx_gcsj lx right join plan_gcsj jh on (lx.jhid=jh.id) 
		    where lx.lxbm like #{lxbm}||'%' and (lx.qdzh<=${zdzh} and lx.zdzh>=${qdzh}) and jh.jhnf<#{jhid}
		) sjC1,
		(select count(*) CON2 from
		(select lx.lxbm,lx.qdzh,lx.zdzh from plan_lx_gcsj lx, plan_gcsj jh where lx.jhid=jh.id and jh.jhnf<#{jhid}) j,
		(select YLXBM,YQDZH,YZDZH from XTGL_LXSJ where XLXBM like #{lxbm}||'%' and XQDZH<=${zdzh} and XZDZH>=${qdzh}) k
		where j.lxbm=k.YLXBM and j.qdzh<k.YZDZH and j.zdzh>k.YQDZH) sjC2 ]]>,
		
		<![CDATA[(select count(jh.id) CON1 from plan_lx_yhdzx lx right join plan_yhdzx jh on (lx.jhid=jh.id) 
		    where lx.lxbm like 'G105'||'%' and (lx.qdzh<=1727.33 and lx.zdzh>=1721.756) and jh.sbnf<2015
		) yhC1,
		(select count(*) CON2 from
		(select lx.lxbm,lx.qdzh,lx.zdzh from plan_lx_yhdzx lx, plan_yhdzx jh where lx.jhid=jh.id and jh.sbnf<2015) j,
		(select YLXBM,YQDZH,YZDZH from XTGL_LXSJ where XLXBM like 'G105'||'%' and XQDZH<=1727.33 and XZDZH>=1721.756) k
		where j.lxbm=k.YLXBM and j.qdzh<k.YZDZH and j.zdzh>k.YQDZH) yhC2]]>
	</select>
</mapper>
