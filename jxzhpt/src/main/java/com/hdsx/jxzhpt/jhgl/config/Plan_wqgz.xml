<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.plan_wqgz">
	<resultMap type="plan_wqgz"  id="wqgz_jh">
		<id property="id" column="id" />
		<result property="sckid" column="sckid"/>
		<result property="sbnf" column="sbnf"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="pfztz" column="pfztz"/>
		<result property="kgzt" column="kgzt"/>
		<result property="jgzt" column="jgzt"/>
		<result property="sfylsjl" column="sfylsjl"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<association property="jckwqgz"  resultMap="wqgz_lx" ></association>
	</resultMap>
	<resultMap type="jckwqgz"  id="wqgz_lx">
		<id property="id" column="id" />
		<result property="gydw" column="gydw"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="lxbm" column="lxbm"/>
		<result property="lxmc" column="lxmc"/>
		<result property="qlmc" column="qlmc"/>
		<result property="qlbh" column="qlbh"/>
	</resultMap>
	<select id="queryWqgzList" parameterType="java.util.Map" resultMap="wqgz_jh">
		select * from 
			(
				select rownum as num,t.* from
				(
					select * from plan_wqgz jh left join sck_wqgz sc on (jh.sckid=sc.sckid) 
					left join xmk_wqgz lx on (sc.xmkid=lx.id) where 1=1
	 				<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
	 				<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					and jh.sbnf=#{jh.sbnf}
	 				</if>
	 				<if test="jh.sbzt!=null and jh.sbzt!=''">
	 					and jh.sbzt=#{jh.sbzt}
	 				</if>
	 				<if test="jh.spzt!=null and jh.spzt!=''">
	 					and jh.spzt=#{jh.spzt}
	 				</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and lx.gydwbm like #{lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and lx.xzqhdm like #{lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.lxbm!=null and lx.lxbm!=''">
	 					and lx.lxbm like #{lx.lxbm}||'%'
	 				</if>
	 				<if test="lx.jsdj!=null and lx.jsdj!=''">
	 					and lx.jsdj = #{lx.jsjd}
	 				</if>
	 				<if test="lx.qlmc!=null and lx.qlmc!=''">
	 					and lx.qlmc like '%'||#{lx.qlmc}||'%'
	 				</if>
	 				<if test="lx.akjfl!=null and lx.akjfl!=''">
	 					and lx.akjfl like #{lx.akjfl}||'%'
	 				</if>
	 				order by jh.sbzt,jh.spzt,jh.sbnf
	 			) t
 			)
 		where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="queryWqgzCount"  parameterType="java.util.Map"  resultType="int">
		select count(*) from plan_wqgz jh left join sck_wqgz sc on (jh.sckid=sc.sckid) 
		left join xmk_wqgz lx on (sc.xmkid=lx.id) where 1=1
	 	<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
			and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
		</if>
	 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 		and jh.sbnf=#{jh.sbnf}
	 	</if>
	 	<if test="jh.sbzt!=null and jh.sbzt!=''">
	 		and jh.sbzt=#{jh.sbzt}
	 	</if>
	 	<if test="jh.spzt!=null and jh.spzt!=''">
	 		and jh.spzt=#{jh.spzt}
	 	</if>
	 	<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 		and lx.gydwbm like #{lx.gydwbm}
	 	</if>
	 	<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 		and lx.xzqhdm like #{lx.xzqhdm}
	 	</if>
	 	<if test="lx.lxmc!=null and lx.lxmc!=''">
	 		and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 	</if>
	 	<if test="lx.lxbm!=null and lx.lxbm!=''">
	 		and lx.lxbm like #{lx.lxbm}||'%'
	 	</if>
	 	<if test="lx.jsdj!=null and lx.jsdj!=''">
	 		and lx.jsdj = #{lx.jsjd}
	 	</if>
	 	<if test="lx.qlmc!=null and lx.qlmc!=''">
	 		and lx.qlmc like '%'||#{lx.qlmc}||'%'
	 	</if>
	 	<if test="lx.akjfl!=null and lx.akjfl!=''">
	 		and lx.akjfl like #{lx.akjfl}||'%'
	 	</if>
	</select>
	<select id="queryWqgzNfs"  resultType="treenode">
		select distinct t.sbnf as text from PLAN_wqgz t order by t.sbnf
	</select>
	<select id="queryWqgzById" parameterType="string" resultType="plan_wqgz">
		<!-- select * from plan_wqgz jh where jh.id=#{id} -->
		select 	id,sckid,sbnf,jhkgsj,jhwgsj, sjdw,sjpfdw,pfwh, pfsj,pfztz, jhsybzje, jhsydfzcje, sfsqablbz,ablbzsqwh, bz,tbsj,
	 tbbm,spzt,spbm,spsj,sbzt, sbbm, sbsj, xdsj,gkbglj,sjsgtlj,sjkgsj,sjwgsj,sgdw,jldw,htje,sgxkwj,
	jgtcwj,jgyswj,wjsczt,kgzt,jgzt,yjjgsj,wjgyy, jsdw, jhxdwh, xdzt, xfzt,xfsj,xfbm,wjzt,wjsj,gys, sbbmdm,spbmdm,sfylsjl
	from plan_wqgz jh where jh.id=#{id}
	</select>
	<select id="insertToSheet" parameterType="hashMap" resultType="sjbb">
		select xzqhdm v_0,
		       xzqhmc v_1,
		       sc.sck_lxbm v_2,
		       lxmc v_3,
		       sc.sck_qlbh v_4,
		       qlmc v_5,
		       sc.sck_qlzxzh v_6,
		       sc.jsxz v_7,
		       sc.jsnr v_8,
		       jh.sbnf v_9,
		       to_char(jh.jhkgsj, 'yyyy-mm-dd') v_10,
		       to_char(jh.jhwgsj, 'yyyy-mm-dd') v_11,
		       to_char(jh.xdsj, 'yyyy-mm-dd') v_12,
		       jh.sjdw v_13,
		       jh.sjpfdw v_14,
		       jh.pfwh v_15,
		       to_char(jh.pfsj, 'yyyy-mm-dd') v_16,
		       jh.pfztz v_17,
		       jh.jhsybzje v_18,
		       jh.jhsydfzcje v_19,
		       jh.sfsqablbz v_20,
		       jh.ablbzsqwh v_21,
		       jh.bz v_22
		  from sck_wqgz sc, xmk_wqgz xm, plan_wqgz jh
		  where sc.xmkid = xm.id
	  	  and jh.sckid = sc.sckid
		  and sck_sbzt = '已上报'
		  and jh.spzt='0'
		  and sck_sbthcd &lt;=#{sck_sbthcd} 
		  <if test="tbdw!=null and tbdw!=''">
		 	 and scbmbm like #{tbdw}||'%'
		  </if>
	</select>
	<select id="exportExcel_jh" parameterType="hashMap" resultType="sjbb">
		select decode(jh.sbzt,0,'未上报',decode(jh.spzt,0,'上报待审批','已审批')) v_0,jh.sbnf v_1,to_char(jh.jhkgsj,'yyyy-mm-dd') v_2,to_char(jh.jhwgsj,'yyyy-mm-dd') v_3,lx.gydw v_4,lx.xzqhmc v_5,lx.lxbm v_6,lx.lxmc v_7,lx.qlbh v_8,lx.qlmc v_9,jh.pfztz v_10 
		from plan_wqgz jh
		left join sck_wqgz sc on (jh.sckid = sc.sckid)
		left join xmk_wqgz lx on (sc.xmkid = lx.id)
		<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
		and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
	</if>
		<if test="jh.sbnf!=null and jh.sbnf!=''">
			and jh.sbnf=#{jh.sbnf}
		</if>
		<if test="jh.sbzt!=null and jh.sbzt!=''">
			and jh.sbzt=#{jh.sbzt}
		</if>
		<if test="jh.spzt!=null and jh.spzt!=''">
			and jh.spzt=#{jh.spzt}
		</if>
		<if test="lx.gydwbm!=null and lx.gydwbm!=''">
			and lx.gydwbm like #{lx.gydwbm}
		</if>
		<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
			and lx.xzqhdm like #{lx.xzqhdm}
		</if>
		<if test="lx.lxmc!=null and lx.lxmc!=''">
			and lx.lxmc like '%'||#{lx.lxmc}||'%'
		</if>
		<if test="lx.lxbm!=null and lx.lxbm!=''">
			and lx.lxbm like #{lx.lxbm}||'%'
		</if>
		<if test="lx.jsdj!=null and lx.jsdj!=''">
			and lx.jsdj = #{lx.jsjd}
		</if>
		<if test="lx.qlmc!=null and lx.qlmc!=''">
			and lx.qlmc like '%'||#{lx.qlmc}||'%'
		</if>
		<if test="lx.akjfl!=null and lx.akjfl!=''">
			and lx.akjfl like #{lx.akjfl}||'%'
		</if>		
		order by jh.sbnf desc
	</select>
	<delete id="dropWqgzById" parameterType="string">
		delete from plan_wqgz jh where jh.id=#{id}
	</delete>
	<update id="editWqgzById" parameterType="plan_wqgz">
		update plan_wqgz set sbnf=#{sbnf},
		<if test="jhkgsj!=null and jhkgsj!=''">
			jhkgsj=#{jhkgsj},
		</if>
		<if test="jhwgsj!=null and jhwgsj!=''">
			jhwgsj=#{jhwgsj},
		</if>
		<if test="xdsj!=null and xdsj!=''">
			xdsj=#{xdsj},
		</if>
		<if test="pfsj!=null and pfsj!=''">
			pfsj=#{pfsj},
		</if>
			jhxdwh=#{jhxdwh},sjdw=#{sjdw},sjpfdw=#{sjpfdw},pfwh=#{pfwh},pfztz=#{pfztz},
			jhsybzje=#{jhsybzje},jhsydfzcje=#{jhsydfzcje},sfsqablbz=#{sfsqablbz},
			ablbzsqwh=#{ablbzsqwh},bz=#{bz}
		where id=#{id}
	</update>
	<update id="editWqgzStatus" parameterType="plan_wqgz">
		update plan_wqgz set 
			<if test="sbbm!=null">sbbm=#{sbbm},</if>
			<if test="sbbmdm!=null">sbbmdm=#{sbbmdm},</if>
			<if test="sbsj!=null">sbsj=#{sbsj},</if>
			<if test="sbzt!=null">sbzt=#{sbzt},</if>
			<if test="spbm!=null">spbm=#{spbm},</if>
			<if test="spbmdm!=null">spbmdm=#{spbmdm},</if>
			<if test="spsj!=null">spsj=#{spsj},</if>
			<if test="spzt!=null">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<!-- <insert id="importWqgz_jh" parameterType="hashMap">
		insert into PLAN_WQGZ(id,sckid,sbnf,jhkgsj,jhwgsj,xdsj,sjdw,sjpfdw,pfwh,pfsj,pfztz,jhsybzje,jhsydfzcje,sfsqablbz,ablbzsqwh,bz,xdzt)
		values(sys_guid(),(select id from xmk_wqgz where lxbm=#{2}  and qlbh=#{4} and qlzxzh=#{6}),#{9},to_date(#{10},'yyyy-mm-dd'),to_date(#{11},'yyyy-mm-dd'),to_date(#{12},'yyyy-mm-dd'),#{13},#{14},#{15},to_date(#{16},'yyyy-mm-dd'),#{17},#{18},#{19},#{20},#{21},#{22},'0')
	</insert> -->
	<update id="importWqgz_jh" parameterType="hashMap">
		update PLAN_WQGZ set sbnf=#{9},jhkgsj=to_date(#{10},'yyyy-mm-dd'),jhwgsj=to_date(#{11},'yyyy-mm-dd'),xdsj=to_date(#{12},'yyyy-mm-dd'),sjdw=#{13},sjpfdw=#{14},pfwh=#{15},pfsj=to_date(#{16},'yyyy-mm-dd'),pfztz=#{17},jhsybzje=#{18},jhsydfzcje=#{19},sfsqablbz=#{20},ablbzsqwh=#{21},bz=#{22}
		where sckid = (select sckid from sck_wqgz where sck_lxbm=#{2}  and sck_qlbh=#{4} and sck_qlzxzh=#{6})
	</update>
	<select id="querySumWqgz" parameterType="java.util.Map" resultType="plan_wqgz">
		select count(jh.id) as id,sum(jh.pfztz) as pfztz,sum(jh.jhsybzje) as jhsybzje,sum(jh.jhsydfzcje) as jhsydfzcje 
		from xmk_wqgz lx right join sck_wqgz sc on (lx.id=sc.xmkid) 
		right join plan_wqgz jh on (sc.sckid=jh.id)
	</select>
	<update id="updateLrztBySckid" parameterType="java.util.List">
 		update sck_wqgz set lrjh='未列入'  where sckid=#{String}
 	</update>
 	<select id="queryJckWqgz" parameterType="String" resultType="plan_wqgz">
		select * from xmk_wqgz where qlbh=#{String}
	</select>
	<update id="updateGkbg" parameterType="plan_wqgz">
 		update plan_wqgz set gkbgmc=#{gkbgmc},gkbgdata=#{gkbgdata} where id=#{id}
 	</update>
 	<update id="updateSjsgt" parameterType="plan_wqgz">
 		update plan_wqgz set sjsgtmc=#{sjsgtmc},sjsgtdata=#{sjsgtdata} where id=#{id}
 	</update>
 	<select id="queryWqgzFjById" parameterType="string" resultType="plan_wqgz">
		select gkbgmc,gkbgdata,sjsgtmc,sjsgtdata from plan_wqgz jh where jh.id=#{id}
	</select>
</mapper>
