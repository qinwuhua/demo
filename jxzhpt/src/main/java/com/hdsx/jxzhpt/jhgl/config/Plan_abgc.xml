<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.plan_abgc">
	<resultMap type="plan_abgc"  id="abgc_jh">
		<id property="id" column="id" />
		<result property="sckid" column="sckid"/>
		<result property="xdsj" column="xdsj"/>
		<result property="jhnf" column="jhnf"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="jhwc_c" column="jhwc_c"/>
		<result property="sjdw" column="sjdw"/>
		<result property="sjpfdw" column="sjpfdw"/>
		<result property="pfwh" column="pfwh"/>
		<result property="pfsj" column="pfsj"/>
		<result property="jhsybbzje" column="jhsybbzje"/>
		<result property="jhsydfzczj" column="jhsydfzczj"/>
		<result property="jhxdwh" column="jhxdwh"/>
		<result property="sfsqablbz" column="sfsqablbz"/>
		<result property="ablbzsqwh" column="ablbzsqwh"/>
		<result property="pfztz" column="pfztz"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="sbbmdm" column="sbbmdm"/>
		<result property="spbmdm" column="spbmdm"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<result property="kgzt" column="kgzt"/>
		<result property="jgzt" column="jgzt"/>
		<result property="sfylsjl" column="sfylsjl"/>
		<association property="jckabgc"  resultMap="abgc_lx"></association>
	</resultMap>
	<resultMap type="jckabgc"  id="abgc_lx">
		<id property="id" column="id" />
		<result property="lxmc" column="lxmc"/>
		<result property="lxbm" column="lxbm"/>
		<result property="gydw" column="gydw"/>
		<result property="qdzh" column="qdzh"/>
		<result property="zdzh" column="zdzh"/>
		<result property="xzqhdm" column="xzqhdm"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="qzlc" column="qzlc"/>
		<result property="yhlc" column="yhlc"/>
	</resultMap>
	
	<select id="queryAbgcList"  parameterType="java.util.Map"  resultMap="abgc_jh">
		select * from 
			(
				select rownum as num,t.* from 
				(
					select * from plan_abgc jh left join sck_abgc sc on (jh.sckid=sc.sckid) 
					left join xmk_abgc lx on (sc.xmkid=lx.id) where 1=1 
				    <if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				    <if test="jh.jhnf!=null and jh.jhnf!=''">
				 		and jh.jhnf=#{jh.jhnf}
				 	</if>
				 	<if test="jh.sbzt!=null and jh.sbzt!=''">
				 		and jh.sbzt=#{jh.sbzt}
				 	</if>
				 	<if test="jh.spzt!=null and jh.spzt!=''">
				 		and jh.spzt=#{jh.spzt}
				 	</if>
				 	<if test="lx.gydwbm!=null and lx.gydwbm!=''">
				 		and lx.gydwbm like #{lx.gydwbm}
				 	</if>
				 	<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				 		and lx.xzqhdm like #{lx.xzqhdm}
				 	</if>
				 	<if test="lx.lxmc!=null and lx.lxmc!=''">
				 		and lx.lxmc like '%'||#{lx.lxmc}||'%'
				 	</if>
				 	<if test="lx.lxbm!=null and lx.lxbm!=''">
				 		and lx.lxbm like #{lx.lxbm}||'%'
				 	</if>
				 	<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
				 		and lx.lxjsdj = #{lx.lxjsjd}
				 	</if>
				 	<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from BT_XZQHTSDQ t where t.areacode=#{lx.tsdq})
				 	</if>
	    			order by jh.sbzt,jh.spzt,jh.jhnf desc
	    		) t
    		)
    	where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="queryAbgcCount"  parameterType="java.util.Map"  resultType="int">
		select count(*) from plan_abgc jh left join sck_abgc sc on (jh.sckid=sc.sckid) 
					left join xmk_abgc lx on (sc.xmkid=lx.id) where 1=1 
				    <if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				    <if test="jh.jhnf!=null and jh.jhnf!=''">
				 		and jh.jhnf=#{jh.jhnf}
				 	</if>
				 	<if test="jh.sbzt!=null and jh.sbzt!=''">
				 		and jh.sbzt=#{jh.sbzt}
				 	</if>
				 	<if test="jh.spzt!=null and jh.spzt!=''">
				 		and jh.spzt=#{jh.spzt}
				 	</if>
				 	<if test="lx.gydwbm!=null and lx.gydwbm!=''">
				 		and lx.gydwbm like #{lx.gydwbm}
				 	</if>
				 	<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				 		and lx.xzqhdm like #{lx.xzqhdm}
				 	</if>
				 	<if test="lx.lxmc!=null and lx.lxmc!=''">
				 		and lx.lxmc like '%'||#{lx.lxmc}||'%'
				 	</if>
				 	<if test="lx.lxbm!=null and lx.lxbm!=''">
				 		and lx.lxbm like #{lx.lxbm}||'%'
				 	</if>
				 	<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
				 		and lx.lxjsdj = #{lx.lxjsjd}
				 	</if>
				 	<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from BT_XZQHTSDQ t where t.areacode=#{lx.tsdq})
				 	</if>
	</select>
	<select id="queryAbgcById"  parameterType="string"  resultType="plan_abgc">
		<!-- select * from Plan_Abgc jh left join Xmk_Abgc lx on jh.sckid=lx.id where jh.id=#{id} -->
		select id,sckid,jhnf,jhkgsj,jhwgsj,sjdw,sjpfdw,pfwh, pfsj,pfztz,jhsybbzje,jhsydfzczj,sfsqablbz,ablbzsqwh, remarks, tbsj, tbbm, spzt,spbm,
	spsj,sbzt,sbbm,sbsj,xdsj,gkbglj,sjsgtlj,sjkgsj,sjwgsj,sgdw, jldw, htje,sgxkwj,jgtcwj, jgyswj,wjsczt,kgzt,jgzt,wjgyy,
	yjwgsj, jhwc_c,jsdw,jhxdwh,xdzt,xfzt,xfsj,xfbm,wjzt,sfylsjl from Plan_Abgc jh where jh.id=#{id}
	</select>
	<select id="queryAbgcNfs" resultType="treenode">
		 select distinct t.jhnf as text from PLAN_abgc t order by t.jhnf
	</select>
	<select id="insertToSheet" parameterType="hashMap" resultType="sjbb">
		select xzqhdm      v_0,
		       xzqhmc      v_1,
		       sc.sck_lxbm v_2,
		       sc.sck_lxmc v_3,
		       sc.scqdzh   v_4,
		       sc.sczdzh   v_5,
		       sc.scyhlc   v_6,
		       sc.jsxz     v_7,
		       sc.jsnr     v_8,
		       jh.jhnf v_9,
		       jh.jhwc_c v_10,
		       to_char(jh.jhkgsj, 'yyyy-mm-dd') v_11,
		       to_char(jh.jhwgsj, 'yyyy-mm-dd') v_12,
		       to_char(jh.xdsj, 'yyyy-mm-dd') v_13,
		       jh.sjdw v_14,
		       jh.sjpfdw v_15,
		       jh.pfwh v_16,
		       to_char(jh.pfsj, 'yyyy-mm-dd') v_17,
		       jh.pfztz v_18,
		       jh.jhsybbzje v_19,
		       jh.jhsydfzczj v_20,
		       jh.sfsqablbz v_21,
		       jh.ablbzsqwh v_22,
		       jh.remarks v_23
		  from sck_abgc sc, xmk_abgc xm,plan_abgc jh
		 where sc.xmkid = xm.id and jh.sckid = sc.sckid
		   and sck_sbzt = '已上报'
		   and sc.lrjh = '已列入'
		   and jh.spzt='0'
		and sck_sbthcd &lt;=#{sck_sbthcd}  
		<if test="tbdw!=null and tbdw!=''">
		 	and scbmbm like #{tbdw}||'%'
	    </if>
	</select>
	<select id="exportExcel_jh" parameterType="hashMap" resultType="sjbb">
		select  decode(jh.sbzt,0,'未上报',decode(jh.spzt,0,'上报待审批','已审批')) v_0,jh.jhnf v_1,to_char(jh.jhkgsj,'yyyy-mm-dd') v_2,to_char(jh.jhwgsj,'yyyy-mm-dd') v_3,lx.gydw v_4,lx.xzqhmc v_5,lx.lxbm v_6,lx.lxmc v_7,lx.qdzh v_8,lx.zdzh v_9,lx.yhlc v_10,jh.pfztz v_11
		 from plan_abgc jh
  		left join sck_abgc sc on (jh.sckid = sc.sckid)
  		left join xmk_abgc lx on (sc.xmkid = lx.id) where 1=1 
		<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='')">
			and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
		</if>
	    <if test="jh.jhnf!=null and jh.jhnf!=''">
	 		and jh.jhnf=#{jh.jhnf}
	 	</if>
	 	<if test="jh.sbzt!=null and jh.sbzt!=''">
	 		and jh.sbzt=#{jh.sbzt}
	 	</if>
	 	<if test="jh.spzt!=null and jh.spzt!=''">
	 		and jh.spzt=#{jh.spzt}
	 	</if>
	 	<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 		and lx.gydwbm like #{lx.gydwbm}
	 	</if>
	 	<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 		and lx.xzqhdm like #{lx.xzqhdm}
	 	</if>
	 	<if test="lx.lxmc!=null and lx.lxmc!=''">
	 		and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 	</if>
	 	<if test="lx.lxbm!=null and lx.lxbm!=''">
	 		and lx.lxbm like #{lx.lxbm}||'%'
	 	</if>
	 	<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 		and lx.lxjsdj = #{lx.lxjsjd}
	 	</if>
		order by jh.jhnf desc
	</select>
	<delete id="dropAbgcById" parameterType="string">
		delete from plan_abgc jh where jh.id=#{id}
	</delete>
	<update id="editAbgcById" parameterType="plan_abgc">
		update plan_abgc set 
			<if test="jhnf!=null and jhnf!=''">
				jhnf=#{jhnf},
			</if>
			<if test="jhkgsj!=null and jhkgsj!=''">
				jhkgsj=#{jhkgsj},
			</if>
			<if test="jhwgsj!=null and jhwgsj!=''">
				jhwgsj=#{jhwgsj},
			</if>
			<if test="xdsj!=null and xdsj!=''">
				xdsj=#{xdsj},
			</if>
			<if test="pfsj!=null and pfsj!=''">
				pfsj=#{pfsj},
			</if>
			jhwc_c=#{jhwc_c},sjdw=#{sjdw},sjpfdw=#{sjpfdw},pfwh=#{pfwh},pfztz=#{pfztz},jhsybbzje=#{jhsybbzje},
			jhsydfzczj=#{jhsydfzczj},jhxdwh=#{jhxdwh},sfsqablbz=#{sfsqablbz},ablbzsqwh=#{ablbzsqwh},remarks=#{remarks}
		where id=#{id}
	</update>
	<update id="editStatus" parameterType="plan_abgc">
		update plan_abgc set 
			<if test="sbbm!=null">sbbm=#{sbbm},</if>
			<if test="sbbmdm!=null">sbbmdm=#{sbbmdm},</if>
			<if test="sbsj!=null">sbsj=#{sbsj},</if>
			<if test="sbzt!=null">sbzt=#{sbzt},</if>
			<if test="spbm!=null">spbm=#{spbm},</if>
			<if test="spbmdm!=null">spbmdm=#{spbmdm},</if>
			<if test="spsj!=null">spsj=#{spsj},</if>
			<if test="spzt!=null">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<!-- <insert id="importAbgc_jh" parameterType="hashMap">
		insert into PLAN_ABGC(id,sckid,JHNF,jhkgsj,jhwgsj,xdsj,sjdw,sjpfdw,pfwh,pfsj,pfztz,JHSYBBZJE,JHSYDFZCZJ,sfsqablbz,ablbzsqwh,REMARKS,xdzt)
		values(sys_guid(),(select id from xmk_abgc where lxbm=#{2} and lxmc=#{3} and qdzh=#{4} and zdzh=#{5}),#{9},to_date(#{11},'yyyy-mm-dd'),to_date(#{12},'yyyy-mm-dd'),to_date(#{13},'yyyy-mm-dd'),
		#{14},#{15},#{16},to_date(#{17},'yyyy-mm-dd'),#{18},#{19},#{20},#{21},#{22},#{23},'0')
	</insert> -->
	<update id="importAbgc_jh" parameterType="hashMap">
		update PLAN_ABGC set JHNF=#{9},jhkgsj=to_date(#{11},'yyyy-mm-dd'),jhwgsj=to_date(#{12},'yyyy-mm-dd'),xdsj=to_date(#{13},'yyyy-mm-dd'),sjdw=#{14},sjpfdw=#{15},pfwh=#{16},pfsj=to_date(#{17},'yyyy-mm-dd'),pfztz=#{18},JHSYBBZJE=#{19},JHSYDFZCZJ=#{20},sfsqablbz=#{21},ablbzsqwh=#{22},REMARKS=#{23}
		where sckid = (select sckid from sck_abgc where sck_lxbm=#{2} and sck_lxmc=#{3} and scqdzh=#{4} and sczdzh=#{5})
	</update>
	<select id="querySumAbgc" resultMap="abgc_jh">
		select count(p.id) as id,sum(x.qzlc) as qzlc,sum(x.zlc) as zlc,sum(x.yhlc) as yhlc,
		sum(p.pfztz) as pfztz,sum(p.jhsybbzje) as jhsybbzje,sum(p.jhsydfzczj) as jhsydfzczj
		from xmk_abgc x right join sck_abgc s on (x.id=s.xmkid) right join plan_abgc p on (s.sckid=p.sckid)
	</select>
	<update id="updateLrztBySckid" parameterType="java.util.List">
 		update sck_abgc set lrjh='未列入'  where sckid=#{String}
 	</update>
	<select id="lwBzbz" parameterType="bzbz" resultType="bzbz">
		select * from lwbzbz where xmlx=#{xmlx} 
		<if test="lx!=null and lx!=''">
		and lx=#{lx}
		</if>
	</select>
<!-- 	<update id="updateGkbg" parameterType="plan_abgc">
 		update plan_abgc set gkbgmc=#{gkbgmc},gkbgdata=#{gkbgdata} where id=#{id}
 	</update>  -->
 	
<!--  	<update id="updateSjsgt" parameterType="plan_abgc">
 		update plan_abgc set sjsgtmc=#{sjsgtmc},sjsgtdata=#{sjsgtdata} where id=#{id}
 	</update>  -->
 	<insert id="insertGkbg" parameterType="plan_upload">
 		insert into plan_upload(filename,filedata,parentid,filetype)
 		 values(#{filename},#{filedata},#{parentid},'工可报告')
 	</insert>
	<insert id="insertSjsgt" parameterType="plan_upload">
 		insert into plan_upload(filename,filedata,parentid,filetype)
 		 values(#{filename},#{filedata},#{parentid},'设计施工图')
 	</insert>
 	<select id="queryFjById"  parameterType="plan_upload"  resultType="plan_upload">
		select  * from plan_upload where id=#{id}
	</select>
	<select id="queryFjByParentId"  parameterType="plan_upload"  resultType="plan_upload">
		select  id,filename,parentid,filetype from plan_upload where parentid=#{id} order by filename desc
	</select>
	<delete id="deleteFile" parameterType="plan_upload" >
		delete from plan_upload where id=#{id}
	</delete>
	<select id="queryTsdq" resultType="treenode">
		select t.areacode as id,t.areaname as text from BT_SPECIALAREA t

	</select>
</mapper>
