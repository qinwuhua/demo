<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.gcglwqgz">

	<select id="selectWqgzYbByJhid" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj,t2.cscyj,t2.stz from GCGL_WQGZ t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and t1.sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectWqgzYbByJhidCount" parameterType="gcglwqgz" resultType="int">
		select count(*) from GCGL_WQGZ 
		where 1=1 and sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<select id="selectWqgzYbByJhid1" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj,t2.cscyj,t2.stz from GCGL_WQGZ t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and sfsj=7
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectWqgzYbByJhidCount1" parameterType="gcglwqgz" resultType="int">
		select count(*) from GCGL_WQGZ 
		where 1=1 and sfsj=7
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 添加月报 -->
	<insert id="insertWqgzYb" parameterType="gcglwqgz">
		insert into GCGL_WQGZ(id,jhid,wc_btz,wc_stz,wc_qttz,zjdw_btz,zjdw_stz,zjdw_qttz,bywcmc,kgdl,qksm,wcqk,sbsj,sbyf,shzt,sfsj,sfth)
		values(sys_guid(),#{jhid},#{wc_btz},#{wc_stz},#{wc_qttz},#{zjdw_btz},#{zjdw_stz},#{zjdw_qttz},#{bywcmc},#{kgdl},#{qksm},#{wcqk},#{sbsj},#{sbyf},#{shzt},#{sfsj},'否')
	</insert>
	<insert id="insertWqgzYb1" parameterType="gcglwqgz">
		insert into GCGL_WQGZ(id,jhid,wc_btz,wc_stz,wc_qttz,zjdw_btz,zjdw_stz,zjdw_qttz,bywcmc,kgdl,qksm,wcqk,sbsj,sbyf,shzt,sfsj,sfth,zjc,xbgz,sbjg)
		values(sys_guid(),#{jhid},#{wc_btz},#{wc_stz},#{wc_qttz},#{zjdw_btz},#{zjdw_stz},#{zjdw_qttz},#{bywcmc},#{kgdl},#{qksm},#{wcqk},#{sbsj},#{sbyf},#{shzt},#{sfsj},'否',#{zjc},#{xbgz},#{sbjg})
	</insert>
	<select id="queryYbByYf" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from GCGL_WQGZ where sbyf=#{sbyf} and jhid=#{jhid}
	</select>
	<!-- 修改月报 -->
	<update id="updateWqgzYb" parameterType="gcglwqgz">
		update GCGL_WQGZ set wc_btz=#{wc_btz},wc_stz=#{wc_stz},wc_qttz=#{wc_qttz},zjdw_btz=#{zjdw_btz},zjdw_stz=#{zjdw_stz},zjdw_qttz=#{zjdw_qttz},bywcmc=#{bywcmc},kgdl=#{kgdl},qksm=#{qksm},wcqk=#{wcqk},sbyf=#{sbyf}
		<if test="zjc !=null  and zjc !=''">,zjc=#{zjc}</if>
	    <if test="xbgz !=null  and xbgz !=''">,xbgz=#{xbgz}</if>
	    <if test="sbjg !=null  and sbjg !=''">,sbjg=#{sbjg}</if>
		where id=#{id} and jhid=#{jhid}
	</update>
	<!-- 修改月报状态 -->
	<update id="sbWqgzYb" parameterType="gcglwqgz">
		update GCGL_WQGZ set sfsj=#{sfsj}
		where id=#{id}
	</update>
	<!-- 删除月报 -->
	<delete id="deleteWqgzYb" parameterType="gcglwqgz">
		delete from GCGL_WQGZ where id=#{id}
	</delete>
	<!-- 审核月报 -->
	<update id="shwqgzyb" parameterType="gcglwqgz">
		update GCGL_WQGZ set shuser=#{shuser},shtime=#{shtime},zjje=#{zjje},xgcsyj=#{xgcsyj},shzt='已审核'
		where id=#{id} and jhid=#{jhid}
	</update>
	
	<!-- 添加车购税 -->
	<insert id="insertWqgzCgs" parameterType="gcglwqgz">
		insert into GCGL_CGS(id,jhid,cgsdwzj,tbr,tbyf,tbsj,stz,cscyj)
		values(sys_guid(),#{jhid},#{cgsdwzj},#{tbr},#{tbyf},#{tbsj},#{stz},#{cscyj})
	</insert>
	<select id="queryCGSByYf" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from GCGL_CGS where tbyf=#{tbyf} and jhid=#{jhid}
	</select>
	<!-- 查询cgs -->
	<select id="selectWqgzCgsList" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.sbsj,t2.sbyf from GCGL_CGS t1 left join GCGL_WQGZ t2 on t1.jhid=t2.jhid and t1.tbyf=t2.sbyf
			where 1=1
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(tbyf,0,4))desc,to_number(replace(tbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectWqgzCgsListCount" parameterType="gcglwqgz" resultType="int">
		select count(*) from GCGL_CGS 
		where 1=1
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 删除cgs -->
	<delete id="deletewqgzCgs" parameterType="gcglwqgz">
		delete from GCGL_CGS where id=#{id}
	</delete>
	<!-- 修改cgs -->
	<update id="updateWqgzCgs" parameterType="gcglwqgz">
		update GCGL_CGS set cgsdwzj=#{cgsdwzj},tbyf=#{tbyf},stz=#{stz},cscyj=#{cscyj}
		where id=#{id} and jhid=#{jhid}
	</update>
	<!-- 上传 -->
	<update id="uploadWqgzFilesgxk" parameterType="gcglwqgz">
		update PLAN_WQGZ set SGXKWJ=#{tiaojian},SGXKWJFILE=#{sgxkwjfile}
		where =ID#{jhid}
	</update>
		<update id="uploadWqgzFilejgtc" parameterType="gcglwqgz">
		update PLAN_WQGZ set JGTCWJ=#{tiaojian},JGTCWJFILE=#{jgtcwjfile}
		where ID=#{jhid}
	</update>
		<update id="uploadWqgzFilejgys" parameterType="gcglwqgz">
		update PLAN_WQGZ set JGYSWJ=#{tiaojian},JGYSWJFILE=#{jgyswjfile}
		where ID=#{jhid}
	</update>
	<!-- 下载 -->
	<select id="downWqgzFile" parameterType="gcglwqgz" resultType="gcglwqgz">
		select ${tiaojian} tiaojian,${lxmc} sgxkwjfile from PLAN_WQGZ where ID=#{jhid}
	</select>
	<update id="insertWqgzwwg" parameterType="gcglwqgz">
		update PLAN_WQGZ set WJGYY=#{wjgyy} where ID=#{jhid}
	</update>
	<update id="insertWqgzwg" parameterType="gcglwqgz">
		update PLAN_WQGZ set SJWGSJ=#{sjwgsj},JGZT=#{jgzt} where ID=#{jhid}
	</update>
	<update id="insertWqgzkg" parameterType="gcglwqgz">
		update PLAN_WQGZ set xdsj=#{xdsj},jhxdwh=#{xdwh},kgzt=#{kgzt},sjkgsj=#{sjkgsj},yjjgsj=#{yjjgsj},sgdw=#{sgdw},jldw=#{jldw},jsdw=#{jsdw},htje=#{htje},gys=#{gys},zljdwj=#{zljdwj} where ID=#{jhid}
	</update>
	
	<select id="selectWqgzjhList" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from (
		select m.*,rownum rn from (
		select 
		t1.sbnf,t1.jhkgsj,t1.jhwgsj,t1.sjdw,t1.sjpfdw,t1.pfwh,t1.pfsj,t1.pfztz,t1.jhsybzje,t1.jhsydfzcje,t1.sfsqablbz,t1.ablbzsqwh,t1.gkbglj,t1.gkbgmc,t1.sjsgtlj,t1.sjsgtmc,t1.bz jhbz,t1.xdsj,t1.jhxdwh xdwh,t1.sjkgsj,t1.ID jhid,t1.id,t1.zljdwj,t1.jhqlqc,t1.jhqlqk,
		t1.yjjgsj,t1.sgdw,t1.jldw,t1.jsdw,t1.gys,t1.htje,t1.sjwgsj,t1.kgzt,t1.jgzt,t1.wjgyy,t1.sgxkwj,t1.jgtcwj,t1.jgyswj,
		t3.qlmc,t3.qlbh,t3.qlzxzh,t3.xzqhmc,t3.xzqhdm,t3.gydw,t3.lxmc,t3.lxbm,t2.SCQLQK qlkd,t2.SCQLQC qlqc,t3.kjzc,t3.dkzdkj,t3.jsdj,t3.pddj,t3.xjgjnd,t3.akjfl,t3.sbjgxs,t3.xmnf,t3.xmtype,t3.ptx,t3.pty,t3.bhnr,t3.bz,t3.tsdq,
		t2.tzgs,t2.spwh,t2.fapgdw,t2.fascdw,t2.faspsj,t2.jsxz,t2.jsnr,t2.scbz,zj.jhxdwh,t1.qljsgm
		from PLAN_WQGZ t1 left join SCK_WQGZ  t2 on t1.SCKID=t2.SCKID left join XMK_WQGZ t3 on t2.xmkid=t3.id left join (select decode(max(jhxdwh),null,'-',max(jhxdwh)) jhxdwh,xmid from plan_zjxd group by xmid) zj on t1.id=zj.xmid
		where  t1.spzt='1' 
			<if test="gydw != null and  gydw != ''">
					${gydw}
			</if>
			<if test="sfylrbwqk != null and  sfylrbwqk != ''">
					and t1.sfylrbwqk = #{sfylrbwqk}
			</if>
			<if test="kgzt != null and  kgzt != ''">
					and t1.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and t1.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="xmnf != null and  xmnf != ''">
					and t1.sbnf like '%'||trim(#{xmnf})||'%'
			</if>
			<if test="lxmc != null and  lxmc != ''">
					and t3.lxmc like '%'||trim(#{lxmc})||'%'
			</if>
			<if test="qlmc != null and  qlmc != ''">
					and t3.qlmc like '%'||trim(#{qlmc})||'%'
			</if>
			<if test="shzt != null and  shzt != ''">
					and ${tiaojian} like '%'||trim(#{shzt})||'%'
			</if>
			order by t1.sbnf
			) m
					where <![CDATA[rownum<=(#{page} * #{rows})]]>
				) 
			where RN>((#{page} - 1) * #{rows})
	</select>
	 <select id="selectWqgzjhListCount" parameterType="gcglwqgz" resultType="int">
	 	select count(*) from  PLAN_WQGZ t1 left join SCK_WQGZ  t2 on t1.SCKID=t2.SCKID left join XMK_WQGZ t3 on t2.xmkid=t3.id 
		where  t1.spzt='1' 
	<if test="gydw != null and  gydw != ''">
			${gydw}
	</if>
	<if test="sfylrbwqk != null and  sfylrbwqk != ''">
			and t1.sfylrbwqk = #{sfylrbwqk}
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and t1.kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and t1.jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="lxmc != null and  lxmc != ''">
			and t3.lxmc like '%'||trim(#{lxmc})||'%'
	</if>
	<if test="xmnf != null and  xmnf != ''">
			and t1.sbnf like '%'||trim(#{xmnf})||'%'
	</if>
	<if test="qlmc != null and  qlmc != ''">
			and t3.qlmc like '%'||trim(#{qlmc})||'%'
	</if>
	 <if test="shzt != null and  shzt != ''">
			and ${tiaojian} like '%'||trim(#{shzt})||'%'
	</if>	
	 </select>
	 <select id="selectWqgzjhFile" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select sgxkwj,jgtcwj,jgyswj from PLAN_WQGZ where ID=#{jhid}
	 </select>
	  <select id="selectWqgzyf" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select tbyf,cgsdwzj from GCGL_CGS where jhid=#{jhid} 
	 	order by to_number(substr(tbyf,0,4))desc,to_number(replace(tbyf,'-','')) desc
	 </select>
	 
	 <select id="selectWqgzwcqkmin" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select max(wcqk) wcqkmin 
	 	from GCGL_WQGZ 
	 	where 1=1 and jhid=#{jhid}
	 	and	to_date(sbyf,'yyyy-mm')&lt;to_date(#{sbyf},'yyyy-mm') 
	 </select>
	 <select id="selectWqgzwcqkmax" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select min(wcqk) wcqkmax 
	 	from GCGL_WQGZ 
	 	where 1=1 and jhid=#{jhid}
	 	and	to_date(sbyf,'yyyy-mm')&gt;to_date(#{sbyf},'yyyy-mm') 
	 </select>	 
	 <select id="selectwqzj1" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select sum(cgsdwzj)+sum(stz) zbfzj from gcgl_cgs where jhid=#{jhid}
	 </select>
	  <select id="selectwqzj2" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select sum(cgsdwzj)+sum(stz) nbfzj from gcgl_cgs where jhid=#{jhid} and tbyf like #{nf}||'%'
	 </select>
	  <select id="selectwqzj3" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select sum(btzzj)+sum(stz) nxdzj from PLAN_ZJXD where xmid=#{id} and xdnf like #{nf}||'%'
	 </select>
	 <select id="selectwqzj4" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select sum(btzzj)+sum(stz) zxdzj from PLAN_ZJXD where xmid=#{id}
	 </select>
	 <update id="updateSjZT" parameterType="gcglwqgz" >
	 update PLAN_WQGZ set sjzt=#{sjzt} where id=#{jhid}
	 </update>
	 <update id="updateXjZT" parameterType="gcglwqgz" >
	 update PLAN_WQGZ set xjzt=#{xjzt} where id=#{jhid}
	 </update>
	 <update id="updateSJSH" parameterType="gcglwqgz" >
	 update PLAN_WQGZ set sjsh=#{sjsh} where id=#{jhid}
	 </update>
	  <update id="updatezdyf" parameterType="gcglwqgz" >
	 update PLAN_WQGZ set zdyf=#{sbyf} where id=#{jhid}
	 </update>
	 <select id="selectnumbyyh" parameterType="gcglwqgz" resultType="int">
	 	select count(*) from GCGL_WQGZ 
		where jhid=#{jhid} and sfsj=#{yhtype} and shzt='未审核'
	 </select>
	 
	 <!-- 拨付资金列表 -->
	 <select id="selectWqgzjhList1" parameterType="gcglwqgz" resultType="gcglwqgz">
		select * from (
		select m.*,rownum rn from (
		select 
		t1.sbnf,t1.jhkgsj,t1.jhwgsj,t1.sjdw,t1.sjpfdw,t1.pfwh,t1.pfsj,t1.pfztz,t1.jhsybzje,t1.jhsydfzcje,t1.sfsqablbz,t1.ablbzsqwh,t1.gkbglj,t1.gkbgmc,t1.sjsgtlj,t1.sjsgtmc,t1.bz jhbz,t1.xdsj,t1.sjkgsj,t1.ID jhid,t1.id,t1.zljdwj,t1.jhqlqc,t1.jhqlqk,
		t1.yjjgsj,t1.sgdw,t1.jldw,t1.jsdw,t1.gys,t1.htje,t1.sjwgsj,t1.kgzt,t1.jgzt,t1.wjgyy,t1.sgxkwj,t1.jgtcwj,t1.jgyswj,
		t3.qlmc,t3.qlbh,t3.qlzxzh,t3.xzqhmc,t3.xzqhdm,t3.gydw,t3.lxmc,t3.lxbm,t2.SCQLQK qlkd,t2.SCQLQC qlqc,t3.kjzc,t3.dkzdkj,t3.jsdj,t3.pddj,t3.xjgjnd,t3.akjfl,t3.sbjgxs,t3.xmnf,t3.xmtype,t3.ptx,t3.pty,t3.bhnr,t3.bz,t3.tsdq,
		t2.tzgs,t2.spwh,t2.fapgdw,t2.fascdw,t2.faspsj,t2.jsxz,t2.jsnr,t2.scbz
		from PLAN_WQGZ t1 left join SCK_WQGZ  t2 on t1.SCKID=t2.SCKID left join XMK_WQGZ t3 on t2.xmkid=t3.id left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on t1.id=c.jhid
		where  t1.spzt='1' 
			<if test="xmnf != null and  xmnf != ''">
					and t1.sbnf like '%'||trim(#{xmnf})||'%'
			</if>
			<if test="sfylrbwqk != null and  sfylrbwqk != ''">
					and t1.sfylrbwqk = #{sfylrbwqk}
			</if>
			<if test="gydw != null and  gydw != ''">
					${gydw}
			</if>
			<if test="kgzt != null and  kgzt != ''">
					and t1.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and t1.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="lxmc != null and  lxmc != ''">
					and t3.lxmc like '%'||trim(#{lxmc})||'%'
			</if>
			<if test="qlmc != null and  qlmc != ''">
					and t3.qlmc like '%'||trim(#{qlmc})||'%'
			</if>
			<if test="tiaojian != null and  tiaojian != ''">
				<if test="tiaojian =='未拨付'">
					and c.tbyf is null
				</if>
				<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
				</if>
			</if>
			order by t1.sbnf
			) m
					where <![CDATA[rownum<=(#{page} * #{rows})]]>
				) 
					where RN>((#{page} - 1) * #{rows})
	</select>
	<select id="selectWqgzjhListcount1" parameterType="gcglwqgz" resultType="int">
	 	select count(*) from  PLAN_WQGZ t1 left join SCK_WQGZ  t2 on t1.SCKID=t2.SCKID left join XMK_WQGZ t3 on t2.xmkid=t3.id left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on t1.id=c.jhid
		where  t1.spzt='1' 
			<if test="xmnf != null and  xmnf != ''">
				and t1.sbnf like '%'||trim(#{xmnf})||'%'
			</if>
			<if test="sfylrbwqk != null and  sfylrbwqk != ''">
					and t1.sfylrbwqk = #{sfylrbwqk}
			</if>
			<if test="gydw != null and  gydw != ''">
					${gydw}
			</if>
			<if test="kgzt != null and  kgzt != ''">
					and t1.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and t1.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="lxmc != null and  lxmc != ''">
					and t3.lxmc like '%'||trim(#{lxmc})||'%'
			</if>
			<if test="qlmc != null and  qlmc != ''">
					and t3.qlmc like '%'||trim(#{qlmc})||'%'
			</if>
			 <if test="shzt != null and  shzt != ''">
					and ${tiaojian} like '%'||trim(#{shzt})||'%'
			</if>	
			<if test="tiaojian != null and  tiaojian != ''">
			<if test="tiaojian =='未拨付'">
					and c.tbyf is null
			</if>
			<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
			</if>
		</if>
	 </select>
	 <!-- 查询每月的车购税 -->
	 <select id="selectcgsyf" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select cgsdwzj zjdw_btz,stz zjdw_stz from gcgl_cgs where tbyf=#{tbyf} and jhid=#{jhid}
	 </select>
	 <!-- 查询最进展大月份 -->
	 <select id="querymaxybyf" parameterType="gcglwqgz" resultType="gcglwqgz">
	 	select max(sbyf) sbyf from gcgl_wqgz where jhid=#{jhid}
	 </select>
</mapper>