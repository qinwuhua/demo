<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.gcglhsly">

	<select id="selecthslyYbByJhid" parameterType="gcglhsly" resultType="gcglhsly">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_HSLY t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and t1.sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selecthslyYbByJhidCount" parameterType="gcglhsly" resultType="int">
		select count(*) from GCGL_HSLY 
		where 1=1 and sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	
	<select id="selecthslyYbByJhid1" parameterType="gcglhsly" resultType="gcglhsly">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_HSLY t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and sfsj=7
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selecthslyYbByJhidCount1" parameterType="gcglhsly" resultType="int">
		select count(*) from GCGL_HSLY 
		where 1=1 and sfsj=7 
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 添加月报 -->
	<insert id="inserthslyYb" parameterType="gcglhsly">
		insert into GCGL_HSLY(id,jhid,bywcdc,bywcjc,bywcmc,kgdl,qksm,sbsj,sbyf,shzt,bfzj,sfsj,sfth,ssdctc,bndsslc,wcqk,wkglc,wcbtz,wcstz,wcqttz,dwstz,dwqttz)
		values(sys_guid(),#{jhid},#{bywcdc},#{bywcjc},#{bywcmc},#{kgdl},#{qksm},#{sbsj},#{sbyf},#{shzt},#{bfzj},#{sfsj},'否',#{ssdctc},#{bndsslc},#{wcqk},#{wkglc},#{wc_btz},#{wc_stz},#{wc_qttz},#{zjdw_stz},#{zjdw_qttz})
	</insert>
	<select id="queryYbByYf" parameterType="gcglhsly" resultType="gcglhsly">
		select * from GCGL_HSLY where sbyf=#{sbyf} and jhid=#{jhid}
	</select>
	<!-- 修改月报 -->
	<update id="updatehslyYb" parameterType="gcglhsly">
		update GCGL_HSLY set bywcdc=#{bywcdc},bywcjc=#{bywcjc},bywcmc=#{bywcmc},bfzj=#{bfzj},kgdl=#{kgdl},qksm=#{qksm},sbyf=#{sbyf},ssdctc=#{ssdctc},bndsslc=#{bndsslc},wcqk=#{wcqk},wkglc=#{wkglc},wcbtz=#{wc_btz},wcstz=#{wc_stz},wcqttz=#{wc_qttz},dwstz=#{zjdw_stz},dwqttz=#{zjdw_qttz} 
		where id=#{id} and jhid=#{jhid}
	</update>
		<!-- 修改月报状态 -->
	<update id="sbWqgzYb" parameterType="gcglhsly">
		update GCGL_HSLY set sfsj=#{sfsj}
		where id=#{id}
	</update>
	<!-- 删除月报 -->
	<delete id="deletehslyYb" parameterType="gcglhsly">
		delete from GCGL_HSLY where id=#{id}
	</delete>
	<!-- 审核月报 -->
	<update id="shhslyYb" parameterType="gcglhsly">
		update GCGL_HSLY set shuser=#{shuser},shtime=#{shtime},zjje=#{zjje},xgcsyj=#{xgcsyj},cscyj=#{cscyj},shzt='已审核'
		where id=#{id} and jhid=#{jhid}
	</update>
		<!-- 添加车购税 -->
	<insert id="insertHslyCgs" parameterType="gcglhsly">
		insert into GCGL_CGS(id,jhid,cgsdwzj,tbr,tbyf,tbsj,stz,cscyj)
		values(sys_guid(),#{jhid},#{cgsdwzj},#{tbr},#{tbyf},#{tbsj},#{stz},#{cscyj})
	</insert>
	<select id="queryCGSByYf" parameterType="gcglhsly" resultType="gcglhsly">
		select * from GCGL_CGS where tbyf=#{tbyf} and jhid=#{jhid}
	</select>
	<!-- 查询cgs -->
	<select id="selectHslyCgsList" parameterType="gcglhsly" resultType="gcglhsly">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.sbsj,t2.sbyf from GCGL_CGS t1 left join GCGL_HSLY t2 on t1.jhid=t2.jhid and t1.tbyf=t2.sbyf
			where 1=1
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(tbyf,0,4))desc,to_number(replace(tbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectHslyCgsListCount" parameterType="gcglhsly" resultType="int">
		select count(*) from GCGL_CGS 
		where 1=1
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 删除cgs -->
	<delete id="deleteHslyCgs" parameterType="gcglhsly">
		delete from GCGL_CGS where id=#{id}
	</delete>
	<!-- 修改cgs -->
	<update id="updateHslyCgs" parameterType="gcglhsly">
			update GCGL_CGS set cgsdwzj=#{cgsdwzj},tbyf=#{tbyf},stz=#{stz},cscyj=#{cscyj}
		where id=#{id} and jhid=#{jhid}
	</update>
	
	<!-- 上传 -->
	<update id="uploadWqgzFilesgxk" parameterType="gcglhsly">
		update PLAN_HSLY set SGXKWJ=#{tiaojian},SGXKWJFILE=#{sgxkwjfile}
		where id=#{jhid}
	</update>
		<update id="uploadWqgzFilejgtc" parameterType="gcglhsly">
		update PLAN_HSLY set JGTCWJ=#{tiaojian},JGTCWJFILE=#{jgtcwjfile}
		where id=#{jhid}
	</update>
		<update id="uploadWqgzFilejgys" parameterType="gcglhsly">
		update PLAN_HSLY set JGYSWJ=#{tiaojian},JGYSWJFILE=#{jgyswjfile}
		where id=#{jhid}
	</update>
	<!-- 下载 -->
	<select id="downWqgzFile" parameterType="gcglhsly" resultType="gcglhsly">
		select ${tiaojian} tiaojian,${xzqhmc} sgxkwjfile from PLAN_HSLY where id=#{jhid}
	</select>
	<update id="insertWqgzwwg" parameterType="gcglhsly">
		update PLAN_HSLY set WJGYY=#{wjgyy} where id=#{jhid}
	</update>
	<update id="insertWqgzwg" parameterType="gcglhsly">
		update PLAN_HSLY set SJWGSJ=#{sjwgsj},JGZT=#{jgzt} where id=#{jhid}
	</update>
	<update id="insertWqgzkg" parameterType="gcglhsly">
		update PLAN_HSLY set xdsj=#{xdsj},kgzt=#{kgzt},sjkgsj=#{sjkgsj},yjwgsj=#{yjwgsj},sgdw=#{sgdw},jldw=#{jldw},jsdw=#{jsdw},htje=#{htje},GSZTZ=#{gsztz} where id=#{jhid}
	</update>
	
	<select id="selectWqgzjhList" parameterType="gcglhsly" resultType="gcglhsly">
		select * from (
		select m.*,rownum rn from (
		select 
		xmmc,xzqhdm,xzqhmc,jhnf,jsgmhj,jsgmy,jsgme,jsgms,jsgmf,jsgmdldq,kgn,wgn,
		ztz,zytz,dfta,gndk,lywz,jsxz,gkpfwh,sgtpfwh,zyjsnr,xzscl,
		xdsj,sjkgsj,yjwgsj,sjwgsj,sgdw,jldw,jsdw,htje,sgxkwj,jgtcwj,jgyswj,
		wjgyy,gsztz,sfqxkg,kgzt,jgzt,id jhid,id
		from PLAN_HSLY 
		where 1=1
	<if test="xzqhdm != null and  xzqhdm != ''">
			${xzqhdm}
	</if>
	<if test="gydwdm != null and  gydwdm != ''">
			${gydwdm}
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="xmmc != null and  xmmc != ''">
			and xmmc like '%'||trim(#{xmmc})||'%'
	</if>
	<if test="shzt != null and  shzt != ''">
			and ${tiaojian} like '%'||trim(#{shzt})||'%'
	</if>
	order by jhnf desc
	) m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
	</select>
	 <select id="selectWqgzjhListCount" parameterType="gcglhsly" resultType="int">
	 	select count(*) 	
	 	from PLAN_HSLY 
		where 1=1
	<if test="xzqhdm != null and  xzqhdm != ''">
			${xzqhdm}
	</if>
	<if test="gydwdm != null and  gydwdm != ''">
			${gydwdm}
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="xmmc != null and  xmmc != ''">
			and xmmc like '%'||trim(#{xmmc})||'%'
	</if>
	<if test="shzt != null and  shzt != ''">
			and ${tiaojian} like '%'||trim(#{shzt})||'%'
	</if>
	 </select>
	 <select id="selectWqgzjhFile" parameterType="gcglhsly" resultType="gcglhsly">
	 	select sgxkwj,jgtcwj,jgyswj from PLAN_HSLY where id=#{jhid}
	 </select>
	 <update id="updateSjZT" parameterType="gcglhsly" >
	 update PLAN_HSLY set sjzt=#{sjzt} where id=#{jhid}
	 </update>
	 <update id="updateXjZT" parameterType="gcglhsly" >
	 update PLAN_HSLY set xjzt=#{xjzt} where id=#{jhid}
	 </update>
	 <update id="updateSJSH" parameterType="gcglhsly" >
	 update PLAN_HSLY set sjsh=#{sjsh} where id=#{jhid}
	 </update>
	 <update id="updatezdyf" parameterType="gcglhsly" >
	 update PLAN_HSLY set zdyf=#{sbyf} where id=#{jhid}
	 </update>
	 <select id="selectnumbyyh" parameterType="gcglhsly" resultType="int">
	 	select count(*) from GCGL_HSLY 
		where jhid=#{jhid} and sfsj=#{yhtype} and shzt='未审核'
	 </select>
	  <!-- 查询最进展大月份 -->
	 <select id="querymaxybyf" parameterType="gcglhsly" resultType="gcglhsly">
	 	select max(sbyf) sbyf from gcgl_hsly where jhid=#{jhid}
	 </select>
	 
	 <select id="selectWqgzjhList1" parameterType="gcglhsly" resultType="gcglhsly">
		select * from (
		select m.*,rownum rn from (
		select 
		xmmc,xzqhdm,xzqhmc,jhnf,jsgmhj,jsgmy,jsgme,jsgms,jsgmf,jsgmdldq,kgn,wgn,
		ztz,zytz,dfta,gndk,lywz,jsxz,gkpfwh,sgtpfwh,zyjsnr,xzscl,
		xdsj,sjkgsj,yjwgsj,sjwgsj,sgdw,jldw,jsdw,htje,sgxkwj,jgtcwj,jgyswj,
		wjgyy,gsztz,sfqxkg,kgzt,jgzt,jh.id jhid,jh.id
		from PLAN_HSLY jh left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on jh.id=c.jhid
		where 1=1 and jh.jhnf=#{jhnf}
	<if test="xzqhdm != null and  xzqhdm != ''">
			${xzqhdm}
	</if>
	<if test="gydwdm != null and  gydwdm != ''">
			${gydwdm}
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="xmmc != null and  xmmc != ''">
			and xmmc like '%'||trim(#{xmmc})||'%'
	</if>
	<if test="tiaojian != null and  tiaojian != ''">
				<if test="tiaojian =='未拨付'">
					and c.tbyf is null
				</if>
				<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
				</if>
	</if>
	order by jhnf desc
	) m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
	</select>
	 <select id="selectWqgzjhListCount1" parameterType="gcglhsly" resultType="int">
	 	select count(*) 	
	 	from PLAN_HSLY jh left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on jh.id=c.jhid
		where 1=1 and jh.jhnf=#{jhnf}
	<if test="xzqhdm != null and  xzqhdm != ''">
			${xzqhdm}
	</if>
	<if test="gydwdm != null and  gydwdm != ''">
			${gydwdm}
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="xmmc != null and  xmmc != ''">
			and xmmc like '%'||trim(#{xmmc})||'%'
	</if>
	<if test="tiaojian != null and  tiaojian != ''">
				<if test="tiaojian =='未拨付'">
					and c.tbyf is null
				</if>
				<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
				</if>
	</if>
	 </select>
</mapper>