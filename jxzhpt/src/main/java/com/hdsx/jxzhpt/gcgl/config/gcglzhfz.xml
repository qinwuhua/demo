<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.gcglzhfz">

	<select id="selectZhfzYbByJhid" parameterType="gcglzhfz" resultType="gcglzhfz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_ZHFZ t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectZhfzYbByJhidCount" parameterType="gcglzhfz" resultType="int">
		select count(*) from GCGL_ZHFZ 
		where 1=1
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<select id="selectZhfzYbByJhid1" parameterType="gcglzhfz" resultType="gcglzhfz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_ZHFZ t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and sfsj='是' 
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectZhfzYbByJhidCount1" parameterType="gcglzhfz" resultType="int">
		select count(*) from GCGL_ZHFZ 
		where 1=1 and sfsj='是' 
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 添加月报 -->
	<insert id="insertZhfzYb" parameterType="gcglzhfz">
		insert into GCGL_ZHFZ(id,jhid,wc_btz,wc_stz,wc_qttz,zjdw_btz,zjdw_stz,zjdw_qttz,bywcgl,kgdl,qksm,sbsj,sbyf,shzt,sfsj,sfth)
		values(sys_guid(),#{jhid},#{wc_btz},#{wc_stz},#{wc_qttz},#{zjdw_btz},#{zjdw_stz},#{zjdw_qttz},#{bywcgl},#{kgdl},#{qksm},#{sbsj},#{sbyf},#{shzt},#{sfsj},'否')
	</insert>
	<select id="queryYbByYf" parameterType="gcglzhfz" resultType="gcglzhfz">
		select * from GCGL_ZHFZ where sbyf=#{sbyf} and jhid=#{jhid}
	</select>
	<!-- 修改月报 -->
	<update id="updateZhfzYb" parameterType="gcglzhfz">
		update GCGL_ZHFZ set wc_btz=#{wc_btz},wc_stz=#{wc_stz},wc_qttz=#{wc_qttz},zjdw_btz=#{zjdw_btz},zjdw_stz=#{zjdw_stz},zjdw_qttz=#{zjdw_qttz},bywcgl=#{bywcgl},kgdl=#{kgdl},qksm=#{qksm}
		where id=#{id} and jhid=#{jhid}
	</update>
	<!-- 修改月报状态 -->
	<update id="sbWqgzYb" parameterType="gcglzhfz">
		update GCGL_ZHFZ set sfsj=#{sfsj},sfth=#{sfth}
		where id=#{id}
	</update>
	<!-- 删除月报 -->
	<delete id="deleteZhfzYb" parameterType="gcglzhfz">
		delete from GCGL_ZHFZ where id=#{id}
	</delete>
	<!-- 审核月报 -->
	<update id="shZhfzYb" parameterType="gcglzhfz">
		update GCGL_ZHFZ set shuser=#{shuser},shtime=#{shtime},zjje=#{zjje},xgcsyj=#{xgcsyj},cscyj=#{cscyj},shzt='已审核'
		where id=#{id} and jhid=#{jhid}
	</update>
	
	<!-- 添加车购税 -->
	<insert id="insertZhfzCgs" parameterType="gcglzhfz">
		insert into GCGL_CGS(id,jhid,cgsdwzj,tbr,tbyf,tbsj)
		values(sys_guid(),#{jhid},#{cgsdwzj},#{tbr},#{tbyf},#{tbsj})
	</insert>
	<select id="queryCGSByYf" parameterType="gcglwqgz" resultType="gcglzhfz">
		select * from GCGL_CGS where tbyf=#{tbyf} and jhid=#{jhid}
	</select>
	<!-- 查询cgs -->
	<select id="selectZhfzCgsList" parameterType="gcglzhfz" resultType="gcglzhfz">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.sbsj,t2.sbyf from GCGL_CGS t1 left join GCGL_ZHFZ t2 on t1.jhid=t2.jhid and t1.tbyf=t2.sbyf
			where 1=1
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(tbyf,0,4))desc,to_number(replace(tbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectZhfzCgsListCount" parameterType="gcglzhfz" resultType="int">
		select count(*) from GCGL_CGS 
		where 1=1
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 删除cgs -->
	<delete id="deleteabgcCgs" parameterType="gcglzhfz">
		delete from GCGL_CGS where id=#{id}
	</delete>
	<!-- 修改cgs -->
	<update id="updateZhfzCgs" parameterType="gcglzhfz">
		update GCGL_CGS set cgsdwzj=#{cgsdwzj}
		where id=#{id} and jhid=#{jhid}
	</update>
		<!-- 上传 -->
	<update id="uploadWqgzFilesgxk" parameterType="gcglzhfz">
		update PLAN_ZHFZ set SGXKWJ=#{tiaojian}
		where SCKID=#{jhid}
	</update>
		<update id="uploadWqgzFilejgtc" parameterType="gcglzhfz">
		update PLAN_ZHFZ set JGTCWJ=#{tiaojian}
		where SCKID=#{jhid}
	</update>
		<update id="uploadWqgzFilejgys" parameterType="gcglzhfz">
		update PLAN_ZHFZ set JGYSWJ=#{tiaojian}
		where SCKID=#{jhid}
	</update>
	<!-- 下载 -->
	<select id="downWqgzFile" parameterType="gcglzhfz" resultType="gcglzhfz">
		select ${tiaojian} tiaojian from PLAN_ZHFZ where SCKID=#{jhid}
	</select>
	<update id="insertWqgzwwg" parameterType="gcglzhfz">
		update PLAN_ZHFZ set WJGYY=#{wjgyy} where SCKID=#{jhid}
	</update>
	<update id="insertWqgzwg" parameterType="gcglzhfz">
		update PLAN_ZHFZ set SJWGSJ=#{sjwgsj},JGZT=#{jgzt} where SCKID=#{jhid}
	</update>
	<update id="insertWqgzkg" parameterType="gcglzhfz">
		update PLAN_ZHFZ set xdsj=#{xdsj},kgzt=#{kgzt},sjkgsj=#{sjkgsj},yjwgsj=#{yjjgsj},sgdw=#{sgdw},jldw=#{jldw},jsdw=#{jsdw},htje=#{htje},gys=#{gys} where SCKID=#{jhid}
	</update>
	
	<select id="selectWqgzjhList" parameterType="gcglzhfz" resultType="gcglzhfz">
select * from (
select m.*,rownum rn from (
select 
t1.sbnf,t1.jhkgsj,t1.jhwgsj,t1.sjdw,t1.sjpfdw,t1.pfwh,t1.pfsj,t1.pfztz,t1.jhsybzje,t1.jhsydfzcje,t1.sfsqablbz,t1.ablbzsqwh,t1.gkbglj,t1.gkbgmc,t1.sjsgtlj,t1.sjsgtmc,t1.bz jhbz,t1.xdsj,t1.sjkgsj,t1.SCKID jhid,
t1.yjwgsj yjjgsj,t1.sgdw,t1.jldw,t1.jsdw,t1.gys,t1.htje,t1.sjwgsj,t1.kgzt,t1.jgzt,t1.wjgyy,t1.sgxkwj,t1.jgtcwj,t1.jgyswj,
t2.gydw,t2.xzqhdm,t2.xzqhmc,t2.lxjsdj,t2.lxbm,t2.lxmc,t2.qdzh,t2.zdzh,t2.qzlc,t2.yhlc,t2.gjxjnd,t2.yhnr,t2.xmnf,t2.xmtype,t2.bz,
t3.tzgs,t3.spwh,t3.fapgdw,t3.fascdw,t3.faspsj,t3.jsxz,t3.jsnr,t3.scbz
from PLAN_ZHFZ t1 left join XMK_ZHFZ t2 on t1.SCKID=t2.id left join SCK_ZHFZ t3 on t3.xmkid=t2.id 
where  t1.spzt='1'
	<if test="gydw != null and  gydw != ''">
			and t2.gydwbm like '%'||trim(#{gydw})||'%'
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and t1.kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and t1.jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="lxmc != null and  lxmc != ''">
			and t2.lxmc like '%'||trim(#{lxmc})||'%'
	</if>
	order by t1.sbnf
	) m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
	</select>
	 <select id="selectWqgzjhListCount" parameterType="gcglzhfz" resultType="int">
	 	select count(*) from PLAN_ZHFZ t1 left join XMK_ZHFZ t2 on t1.SCKID=t2.id left join SCK_ZHFZ t3 on t3.xmkid=t2.id 
	 	where 1=1 and spzt='1'
	<if test="gydw != null and  gydw != ''">
			and t2.gydwbm like '%'||trim(#{gydw})||'%'
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and t1.kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and t1.jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="lxmc != null and  lxmc != ''">
			and t2.lxmc like '%'||trim(#{lxmc})||'%'
	</if>
	 </select>
	 <select id="selectWqgzjhFile" parameterType="gcglzhfz" resultType="gcglzhfz">
	 	select sgxkwj,jgtcwj,jgyswj from PLAN_ZHFZ where SCKID=#{jhid}
	 </select>
	
</mapper>