<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.gcglyhdzx">

	<select id="selectYhdzxYbByJhid" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_YHDZX t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and t1.sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectYhdzxYbByJhidCount" parameterType="gcglyhdzx" resultType="int">
		select count(*) from GCGL_YHDZX 
		where 1=1 and sfsj &lt;=#{sfsj}
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<select id="selectYhdzxYbByJhid1" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.tbr,t2.tbsj,t2.tbyf,t2.cgsdwzj from GCGL_YHDZX t1 left join GCGL_CGS t2 on t1.jhid=t2.jhid and t1.sbyf=t2.tbyf
			where 1=1 and sfsj=7 
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(sbyf,0,4))desc,to_number(replace(sbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectYhdzxYbByJhidCount1" parameterType="gcglyhdzx" resultType="int">
		select count(*) from GCGL_YHDZX 
		where 1=1 and sfsj=7
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 添加月报 -->
	<insert id="insertYhdzxYb" parameterType="gcglyhdzx">
		insert into GCGL_YHDZX(id,jhid,wc_btz,wc_stz,wc_qttz,zjdw_btz,zjdw_stz,zjdw_qttz,bywcdc,bywcjc,bywcmc,kgdl,qksm,sbsj,sbyf,shzt,wcqk,sfsj,sfth)
		values(sys_guid(),#{jhid},#{wc_btz},#{wc_stz},#{wc_qttz},#{zjdw_btz},#{zjdw_stz},#{zjdw_qttz},#{bywcdc},#{bywcjc},#{bywcmc},#{kgdl},#{qksm},#{sbsj},#{sbyf},#{shzt},#{wcqk},#{sfsj},'否')
	</insert>
	<select id="queryYbByYf" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from GCGL_YHDZX where sbyf=#{sbyf} and jhid=#{jhid}
	</select>
	<!-- 修改月报 -->
	<update id="updateYhdzxYb" parameterType="gcglyhdzx">
		update GCGL_YHDZX set wc_btz=#{wc_btz},wc_stz=#{wc_stz},wc_qttz=#{wc_qttz},zjdw_btz=#{zjdw_btz},zjdw_stz=#{zjdw_stz},zjdw_qttz=#{zjdw_qttz},bywcdc=#{bywcdc},bywcjc=#{bywcjc},bywcmc=#{bywcmc},wcqk=#{wcqk},kgdl=#{kgdl},qksm=#{qksm},sbyf=#{sbyf} 
		where id=#{id} and jhid=#{jhid}
	</update>
	<!-- 修改月报状态 -->
	<update id="sbWqgzYb" parameterType="gcglyhdzx">
		update GCGL_YHDZX set sfsj=#{sfsj}
		where id=#{id}
	</update>
	<!-- 删除月报 -->
	<delete id="deleteYhdzxYb" parameterType="gcglyhdzx">
		delete from GCGL_YHDZX where id=#{id}
	</delete>
	<!-- 审核月报 -->
	<update id="shYhdzxYb" parameterType="gcglyhdzx">
		update GCGL_YHDZX set shuser=#{shuser},shtime=#{shtime},zjje=#{zjje},xgcsyj=#{xgcsyj},cscyj=#{cscyj},shzt='已审核'
		where id=#{id} and jhid=#{jhid}
	</update>
		<!-- 添加车购税 -->
	<insert id="insertYhdzxCgs" parameterType="gcglyhdzx">
		insert into GCGL_CGS(id,jhid,cgsdwzj,tbr,tbyf,tbsj,stz,cscyj)
		values(sys_guid(),#{jhid},#{cgsdwzj},#{tbr},#{tbyf},#{tbsj},#{stz},#{cscyj})
	</insert>
	<select id="queryCGSByYf" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from GCGL_CGS where tbyf=#{tbyf} and jhid=#{jhid}
	</select>
	<!-- 查询cgs -->
	<select id="selectYhdzxCgsList" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from (
		select m.*,rownum rn from (
			select t1.*,t2.sbsj,t2.sbyf from GCGL_CGS t1 left join GCGL_YHDZX t2 on t1.jhid=t2.jhid and t1.tbyf=t2.sbyf
			where 1=1
		<if test="jhid != null and  jhid != ''">
			and t1.jhid =#{jhid}
		</if>
		order by to_number(substr(tbyf,0,4))desc,to_number(replace(tbyf,'-','')) desc
		)  m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
		
	</select>
	<select id="selectYhdzxCgsListCount" parameterType="gcglyhdzx" resultType="int">
		select count(*) from GCGL_CGS 
		where 1=1
		<if test="jhid != null and  jhid != ''">
			and jhid =#{jhid}
		</if>
	</select>
	<!-- 删除cgs -->
	<delete id="deleteYhdzxCgs" parameterType="gcglyhdzx">
		delete from GCGL_CGS where id=#{id}
	</delete>
	<!-- 修改cgs -->
	<update id="updateYhdzxCgs" parameterType="gcglyhdzx">
			update GCGL_CGS set cgsdwzj=#{cgsdwzj},tbyf=#{tbyf},stz=#{stz},cscyj=#{cscyj}
		where id=#{id} and jhid=#{jhid}
	</update>

<!-- 上传 -->
	<update id="uploadWqgzFilesgxk" parameterType="gcglyhdzx">
		update PLAN_YHDZX set SGXKWJ=#{tiaojian},SGXKWJFILE=#{sgxkwjfile}
		where id=#{jhid}
	</update>
		<update id="uploadWqgzFilejgtc" parameterType="gcglyhdzx">
		update PLAN_YHDZX set JGTCWJ=#{tiaojian},JGTCWJFILE=#{jgtcwjfile}
		where id=#{jhid}
	</update>
		<update id="uploadWqgzFilejgys" parameterType="gcglyhdzx">
		update PLAN_YHDZX set JGYSWJ=#{tiaojian},JGYSWJFILE=#{jgyswjfile}
		where id=#{jhid}
	</update>
	<!-- 下载 -->
	<select id="downWqgzFile" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select ${tiaojian} tiaojian,${lxmc} sgxkwjfile from PLAN_YHDZX where id=#{jhid}
	</select>
	<update id="insertWqgzwwg" parameterType="gcglyhdzx">
		update PLAN_YHDZX set WJGYY=#{wjgyy} where id=#{jhid}
	</update>
	<update id="insertWqgzwg" parameterType="gcglyhdzx">
		update PLAN_YHDZX set SJWGSJ=#{sjwgsj},JGZT=#{jgzt} where id=#{jhid}
	</update>
	<update id="insertWqgzkg" parameterType="gcglyhdzx">
		update PLAN_YHDZX set xdsj=#{jhxdsj},kgzt=#{kgzt},sjkgsj=#{sjkgsj},yjwgsj=#{yjwgsj},sgdw=#{sgdw},jldw=#{jldw},jsdw=#{jsdw},htje=#{htje},gys=#{gys},sfgk=#{sfgk} where id=#{jhid}
	</update>
	
	<select id="selectWqgzjhList" parameterType="gcglyhdzx" resultType="gcglyhdzx">
		select * from (
		select m.*,rownum rn from (
		select 
		t2.sbnf,t1.lxmc,t1.lxbm,t1.gydwmc gydw,t1.gydwdm gydwbm,t1.qdzh,t1.zdzh,t1.qzlc,t1.hdlc hdhlc,t1.xzqhdm,t1.xzqhmc,t1.yjsdj jsdj,t1.ylmkd,t1.ylmlx,t1.ylmhd,
		t2.description sczmsj,t2.xchsqk,t2.qtbz,
		t2.classify,t2.reportingfee,t2.fee,t2.newfee,t2.totalinvest,t2.totalplacefund,t2.totalsubsidyfund,t2.accumulativesubsidyfund,
		t2.nowyearsubsidyfund,t2.dianceng,t2.jiceng,t2.surface,t2.pqi,t2.planhistorycompara,t2.aadt,t2.constructnumber,
		t2.replynumber,t2.devisenumbder,t2.plandownnumber,t2.remarks,t2.id jhid,t2.id,
<!-- 		t2.mark, -->
		t2.xdsj jhxdsj,t2.sjkgsj,t2.sjwgsj,t2.kgzt,t2.jgzt,t2.yjwgsj,t2.jsdw,t2.sgdw,t2.jldw,t2.htje,t2.sgxkwj,t2.jgtcwj,t2.jgyswj,t2.gys,t2.wjgyy
		from PLAN_LX_YHDZX t1 left join PLAN_YHDZX t2 on t1.jhid=t2.id
		where t2.spzt='1'
	<if test="gydw != null and  gydw != ''">
			and t1.gydwdm like '%'||trim(#{gydw})||'%'
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and t2.kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and t2.jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="lxmc != null and  lxmc != ''">
			and t1.lxmc like '%'||trim(#{lxmc})||'%'
	</if>
	<if test="shzt != null and  shzt != ''">
			and ${tiaojian} like '%'||trim(#{shzt})||'%'
	</if>
	order by t2.xdsj
	) m
			where <![CDATA[rownum<=(#{page} * #{rows})]]>
		) 
			where RN>((#{page} - 1) * #{rows})
	</select>
	 <select id="selectWqgzjhListCount" parameterType="gcglyhdzx" resultType="int">
	 	select count(*) from PLAN_LX_YHDZX t1 left join PLAN_YHDZX t2 on t1.jhid=t2.id
		where t2.spzt='1'
	<if test="gydw != null and  gydw != ''">
			and t1.gydwdm like '%'||trim(#{gydw})||'%'
	</if>
	<if test="kgzt != null and  kgzt != ''">
			and t2.kgzt like '%'||trim(#{kgzt})||'%'
	</if>
	<if test="jgzt != null and  jgzt != ''">
			and t2.jgzt like '%'||trim(#{jgzt})||'%'
	</if>
	<if test="lxmc != null and  lxmc != ''">
			and t1.lxmc like '%'||trim(#{lxmc})||'%'
	</if>
	<if test="shzt != null and  shzt != ''">
			and ${tiaojian} like '%'||trim(#{shzt})||'%'
	</if>
	 </select>
	 <select id="selectWqgzjhFile" parameterType="gcglyhdzx" resultType="gcglyhdzx">
	 	select sgxkwj,jgtcwj,jgyswj from PLAN_YHDZX where id=#{jhid}
	 </select>
	 <update id="updateSjZT" parameterType="gcglyhdzx" >
	 update PLAN_YHDZX set sjzt=#{sjzt} where id=#{jhid}
	 </update>
	 <update id="updateXjZT" parameterType="gcglyhdzx" >
	 update PLAN_YHDZX set xjzt=#{xjzt} where id=#{jhid}
	 </update>
	 <update id="updateSJSH" parameterType="gcglyhdzx" >
	 update PLAN_YHDZX set sjsh=#{sjsh} where id=#{jhid}
	 </update>
	 <update id="updatezdyf" parameterType="gcglyhdzx" >
	 update PLAN_YHDZX set zdyf=#{sbyf} where id=#{jhid}
	 </update>
	 <select id="selectnumbyyh" parameterType="gcglyhdzx" resultType="int">
	 	select count(*) from GCGL_YHDZX 
		where jhid=#{jhid} and sfsj=#{yhtype} and shzt='未审核'
	 </select>
	  <!-- 查询最进展大月份 -->
	 <select id="querymaxybyf" parameterType="gcglyhdzx" resultType="gcglyhdzx">
	 	select max(sbyf) sbyf from gcgl_yhdzx where jhid=#{jhid}
	 </select>
	 <resultMap type="plan_yhdzx" id="yhdzx_jh">
		<id property="id" column="id" />
		<result property="xdsj" column="xdsj"/>
		<result property="sbnf" column="sbnf"/>
		<result property="classify" column="classify"/>
		<result property="fee" column="fee"/>
		<result property="newfee" column="newfee"/>
		<result property="reportingfee" column="reportingfee"/>
		<result property="totalinvest" column="totalinvest"/>
		<result property="totalsubsidyfund" column="totalsubsidyfund"/>
		<result property="nowyearsubsidyfund" column="nowyearsubsidyfund"/>
		<result property="accumulativesubsidyfund" column="accumulativesubsidyfund"/>
		<result property="dianceng" column="dianceng"/>
		<result property="jiceng" column="jiceng"/>
		<result property="surface" column="surface"/>
		<result property="mark" column="mark"/>
		<result property="pqi" column="pqi"/>
		<result property="aadt" column="aadt"/>
		<result property="constructnumber" column="constructnumber"/>
		<result property="replynumber" column="replynumber"/>
		<result property="devisenumber" column="devisenumber"/>
		<result property="plandownnumber" column="plandownnumber"/>
		<result property="description" column="description"/>
		<result property="xchsqk" column="xchsqk"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="kgzt" column="kgzt"/>
		<result property="jgzt" column="jgzt"/>
		<result property="remarks" column="remarks"/>
		<result property="qtbz" column="qtbz"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<result property="totalplacefund" column="totalplacefund"/>
		<result property="devisenumbder" column="devisenumbder"/>
		<collection property="plan_lx_yhdzxs" ofType="plan_lx_yhdzx" resultMap="yhdzx_lx"/>
	</resultMap>
	<resultMap type="plan_lx_yhdzx" id="yhdzx_lx">
		<id property="lxid" column="lxid" />
		<result property="lxbm" column="lxbm"/>
		<result property="lxmc" column="lxmc"/>
		<result property="gydwmc" column="gydwmc"/>
		<result property="gydwdm" column="gydwdm"/>
		<result property="xzqhdm" column="xzqhdm"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="qdzh" column="qdzh"/>
		<result property="zdzh" column="zdzh"/>
		<result property="qzlc" column="qzlc"/>
		<result property="hdlc" column="hdlc"/>
		<result property="yjsdj" column="yjsdj"/>
		<result property="ylmlx" column="ylmlx"/>
		<result property="ylmkd" column="ylmkd"/>
		<result property="ylmhd" column="ylmhd"/>
		<result property="dzxkd" column="dzxkd"/>
		<result property="lmjg" column="lmjg"/>
		<result property="aym" column="aym"/>
		<result property="asl" column="asl"/>
		<result property="glf" column="glf"/>
	</resultMap>
	 
	 <select id="queryGcgjList"  parameterType="gcglyhdzx" resultMap="yhdzx_jh">
	select * from (
			select rownum as num,t.* from (
	    		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) 
			where 1=1 and spzt='1'
			<if test="kgzt != null and  kgzt != ''">
					and jh.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and jh.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="shzt != null and  shzt != ''">
					and ${tiaojian} like '%'||trim(#{shzt})||'%'
			</if>
			and jh.id in (
					select l.jhid from PLAN_lx_yhdzx l
					where 1=1 
						<if test="gydw != null and  gydw != ''">
					and l.gydwdm like '%'||trim(#{gydw})||'%'
						</if>
						<if test="lxmc != null and  lxmc != ''">
								and l.lxmc like '%'||trim(#{lxmc})||'%'
						</if>
						
					     )
					) t
			)
		where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="queryGcgjListCount" resultType="int" parameterType="gcglyhdzx">
		select count(*) from PLAN_yhdzx jh where 1=1 and spzt='1'
			<if test="kgzt != null and  kgzt != ''">
					and jh.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and jh.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="shzt != null and  shzt != ''">
					and ${tiaojian} like '%'||trim(#{shzt})||'%'
			</if>
				and jh.id in (
					select l.jhid from PLAN_lx_yhdzx l
					where 1=1 
						<if test="gydw != null and  gydw != ''">
					and l.gydwdm like '%'||trim(#{gydw})||'%'
						</if>
						<if test="lxmc != null and  lxmc != ''">
								and l.lxmc like '%'||trim(#{lxmc})||'%'
						</if>
						
					     )
	</select>
	
	 <select id="selectWqgzjhList2"  parameterType="gcglyhdzx" resultMap="yhdzx_jh">
	select * from (
			select rownum as num,t.* from (
	    		select * from plan_yhdzx jh left join plan_lx_yhdzx lx on (jh.id=lx.jhid) left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on jh.id=c.jhid
			where 1=1 and spzt='1' and jh.sbnf=#{sbnf}
			<if test="kgzt != null and  kgzt != ''">
					and jh.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and jh.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="tiaojian != null and  tiaojian != ''">
				<if test="tiaojian =='未拨付'">
					and c.tbyf is null
				</if>
				<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
				</if>
			</if>
			and jh.id in (
					select l.jhid from PLAN_lx_yhdzx l
					where 1=1 
						<if test="gydw != null and  gydw != ''">
					and l.gydwdm like '%'||trim(#{gydw})||'%'
						</if>
						<if test="lxmc != null and  lxmc != ''">
								and l.lxmc like '%'||trim(#{lxmc})||'%'
						</if>
						
					     )
					) t
			)
		where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="selectWqgzjhListcount1" resultType="int" parameterType="gcglyhdzx">
		select count(*) from PLAN_yhdzx jh left join (select * from gcgl_cgs where tbyf=#{tbyf}) c on jh.id=c.jhid
		where 1=1 and spzt='1' and jh.sbnf=#{sbnf}
			<if test="kgzt != null and  kgzt != ''">
					and jh.kgzt like '%'||trim(#{kgzt})||'%'
			</if>
			<if test="jgzt != null and  jgzt != ''">
					and jh.jgzt like '%'||trim(#{jgzt})||'%'
			</if>
			<if test="tiaojian != null and  tiaojian != ''">
				<if test="tiaojian =='未拨付'">
					and c.tbyf is null
				</if>
				<if test="tiaojian =='已拨付'">
					and c.tbyf is not null
				</if>
			</if>
				and jh.id in (
					select l.jhid from PLAN_lx_yhdzx l
					where 1=1 
						<if test="gydw != null and  gydw != ''">
					and l.gydwdm like '%'||trim(#{gydw})||'%'
						</if>
						<if test="lxmc != null and  lxmc != ''">
								and l.lxmc like '%'||trim(#{lxmc})||'%'
						</if>
						
					     )
	</select>
</mapper>