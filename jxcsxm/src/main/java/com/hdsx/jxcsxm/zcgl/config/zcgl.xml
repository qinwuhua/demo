<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxcsxm.zcgl">
	<select id="queryZclist" parameterType="zcgl" resultType="zcgl">
		select * from(select rownum num ,t1.* from(select * from (select t.*,decode(xsbzt,'0','未上报',1,'已上报') xsbztstr,decode(ssbzt,'0','未上报',1,'已上报') ssbztstr,decode(shzt,'0','未审核',1,'已审核') shztstr,decode(sfbj,'0','未填写','已填写') sftx from
		(
		select id,lxbm,gydw,gydwdm,lxmc,qdzh,zdzh,jsdj,lc,nf,zcqcs,zcqms,fzqcs,fzqms,xsbzt,ssbzt,shzt ,thyy,sfbj from zcgl where nf=#{nf}    
		union all
		select #{nf}||xlxbm||xqdzh||xzdzh,xlxbm,gydw,gydwdm,xlxmc,xqdzh,xzdzh,jsdj,xzdzh-xqdzh,#{nf} nf,'0','0','0','0','0','0','0','','0' from zcgl_lx l where (select count(*) from zcgl where nf=#{nf} and lxbm||qdzh||zdzh=xlxbm||xqdzh||xzdzh)=0
		order by lxbm,qdzh
		) t
		where 1=1 
		<if test="dwlx !='' and dwlx != null">and gydwdm like #{dwlx}||'%'</if>
		<if test="gydw !='' and gydw != null">${gydw}</if>
		<if test="jsdj !='' and jsdj != null">${jsdj}</if>
		<if test="nf !='' and nf != null">and nf=#{nf}</if>
		<if test="lxbm !='' and lxbm != null">and lxbm like '%'||#{lxbm}||'%'</if>
		<if test="lxmc !='' and lxmc != null">and lxmc like '%'||#{lxmc}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
		order by decode(substr(lxbm,0,1),'G',1,'S',2,'X',3,'Y',4,'C',5,'Z',6),substr(lxbm,-6),qdzh
	
		) t1 
		)t2
		where t2.num &lt;=(#{page} * #{rows}) and t2.num>(#{page}-1)*#{rows}
		
	</select>
	<select id="queryZclistCount" parameterType="zcgl" resultType="int">
		select count(*) from (select t.*,decode(xsbzt,'0','未上报',1,'已上报') xsbztstr,decode(ssbzt,'0','未上报',1,'已上报') ssbztstr,decode(shzt,'0','未审核',1,'已审核') shztstr,decode(sfbj,'0','未填写','已填写') sftx from
		(
		select id,lxbm,gydw,gydwdm,lxmc,qdzh,zdzh,jsdj,lc,nf,zcqcs,zcqms,fzqcs,fzqms,xsbzt,ssbzt,shzt ,thyy,sfbj from zcgl where nf=#{nf}    
		union all
		select '',xlxbm,gydw,gydwdm,xlxmc,xqdzh,xzdzh,jsdj,xzdzh-xqdzh,#{nf} nf,'0','0','0','0','0','0','0','','0' from zcgl_lx where (select count(*) from zcgl where nf=#{nf} and lxbm||qdzh||zdzh=xlxbm||xqdzh||xzdzh)=0
		) t
		where 1=1 
		<if test="dwlx !='' and dwlx != null">and gydwdm like #{dwlx}||'%'</if>
		<if test="gydw !='' and gydw != null">${gydw}</if>
		<if test="jsdj !='' and jsdj != null">${jsdj}</if>
		<if test="nf !='' and nf != null">and nf=#{nf}</if>
		<if test="lxbm !='' and lxbm != null">and lxbm like '%'||#{lxbm}||'%'</if>
		<if test="lxmc !='' and lxmc != null">and lxmc like '%'||#{lxmc}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
		order by lxbm,qdzh
	
	</select>
	
	<select id="getbfTjAll" parameterType="xmjbxx" resultType="xmzjbf">
		select count(*) xmsl,sum(nvl(dwzj,0)) dwzj,sum(nvl(bfzj,0)) bfzj,sum(nvl(yshbfzj,0)) yshbfzj,sum(nvl(jhxdzj,0)) jhxdzj from(select t.*,zj.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
	    left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
	    on t.xmbm=xd.xmid 
	    left join(
	      select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
	    (case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
	    (case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
	    (case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
	    from xm_zjdw group by xmbm) dw on t.xmbm=dw.xmids
	    left join
	      (select xm.xmbm xmbms1,nvl(dwzj,0) dwzj,nvl(bfzj,0) bfzj,nvl(yshbfzj,0) yshbfzj,nvl(jhxdzj,0) jhxdzj from xmjbxx xm left join 
	      (select xmbm,sum(decode(shzt,'已审核',ztz,0)) dwzj from xm_zjdw group by xmbm) dw on xm.xmbm=dw.xmbm left join
			  (select xmbm,sum(ztz) bfzj,sum(decode(shzt,'已审核',ztz,0)) yshbfzj from xm_zjbf group by xmbm) bf on xm.xmbm=bf.xmbm left join
			  (select xmid xmbm,sum(nvl(ztz,0)) jhxdzj from xm_gsd_jhxd group by xmid) xd on xm.xmbm=xd.xmbm 
	    ) zj on t.xmbm=zj.xmbms1
	    where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">${jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
	</select>
	
	<select id="getsfktj" parameterType="zcgl" resultType="int">
		select count(*) from zcgl where id=#{id}
	</select>
	
	<insert id="insertZcgl" parameterType="zcgl">
		insert into ZCGL
	    <trim prefix="(" suffix=")" suffixOverrides="," >
	      <if test="id != null" >
	        ID,
	      </if>
	      <if test="lxbm != null" >
	        LXBM,
	      </if>
	      <if test="gydw != null" >
	        GYDW,
	      </if>
	      <if test="gydwdm != null" >
	        GYDWDM,
	      </if>
	      <if test="lxmc != null" >
	        LXMC,
	      </if>
	      <if test="qdzh != null" >
	        QDZH,
	      </if>
	      <if test="zdzh != null" >
	        ZDZH,
	      </if>
	      <if test="jsdj != null" >
	        JSDJ,
	      </if>
	      <if test="lc != null" >
	        LC,
	      </if>
	      <if test="nf != null" >
	        NF,
	      </if>
	      <if test="zcqcs != null" >
	        ZCQCS,
	      </if>
	      <if test="zcqms != null" >
	        ZCQMS,
	      </if>
	      <if test="fzqcs != null" >
	        FZQCS,
	      </if>
	      <if test="fzqms != null" >
	        FZQMS,
	      </if>
	      <if test="xsbzt != null" >
	        XSBZT,
	      </if>
	      <if test="ssbzt != null" >
	        SSBZT,
	      </if>
	      <if test="shzt != null" >
	        SHZT,
	      </if>
	      <if test="thyy != null" >
	        THYY,
	      </if>
	      <if test="sfbj != null" >
	        SFBJ,
	      </if>
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	      <if test="id != null" >
	        #{id},
	      </if>
	      <if test="lxbm != null" >
	        #{lxbm},
	      </if>
	      <if test="gydw != null" >
	        #{gydw},
	      </if>
	      <if test="gydwdm != null" >
	        #{gydwdm},
	      </if>
	      <if test="lxmc != null" >
	        #{lxmc},
	      </if>
	      <if test="qdzh != null" >
	        #{qdzh},
	      </if>
	      <if test="zdzh != null" >
	        #{zdzh},
	      </if>
	      <if test="jsdj != null" >
	        #{jsdj},
	      </if>
	      <if test="lc != null" >
	        #{lc},
	      </if>
	      <if test="nf != null" >
	        #{nf},
	      </if>
	      <if test="zcqcs != null" >
	        #{zcqcs},
	      </if>
	      <if test="zcqms != null" >
	        #{zcqms},
	      </if>
	      <if test="fzqcs != null" >
	        #{fzqcs},
	      </if>
	      <if test="fzqms != null" >
	        #{fzqms},
	      </if>
	      <if test="xsbzt != null" >
	        #{xsbzt},
	      </if>
	      <if test="ssbzt != null" >
	        #{ssbzt},
	      </if>
	      <if test="shzt != null" >
	        #{shzt},
	      </if>
	      <if test="thyy != null" >
	        #{thyy},
	      </if>
	      <if test="sfbj != null" >
	        #{sfbj},
	      </if>
	    </trim>
	</insert>
	
	<update id="updateZcgl" parameterType="zcgl">
		update ZCGL
	    <set >
	     <if test="lxbm != null" >
	        LXBM = #{lxbm},
	      </if>
	      <if test="gydw != null" >
	        GYDW = #{gydw},
	      </if>
	      <if test="gydwdm != null" >
	        GYDWDM = #{gydwdm},
	      </if>
	      <if test="lxmc != null" >
	        LXMC = #{lxmc},
	      </if>
	      <if test="qdzh != null" >
	        QDZH = #{qdzh},
	      </if>
	      <if test="zdzh != null" >
	        ZDZH = #{zdzh},
	      </if>
	      <if test="jsdj != null" >
	        JSDJ = #{jsdj},
	      </if>
	      <if test="lc != null" >
	        LC = #{lc},
	      </if>
	      <if test="nf != null" >
	        NF = #{nf},
	      </if>
	      <if test="zcqcs != null" >
	        ZCQCS = #{zcqcs},
	      </if>
	      <if test="zcqms != null" >
	        ZCQMS = #{zcqms},
	      </if>
	      <if test="fzqcs != null" >
	        FZQCS = #{fzqcs},
	      </if>
	      <if test="fzqms != null" >
	        FZQMS = #{fzqms},
	      </if>
	      <if test="xsbzt != null" >
	        XSBZT = #{xsbzt},
	      </if>
	      <if test="ssbzt != null" >
	        SSBZT = #{ssbzt},
	      </if>
	      <if test="shzt != null" >
	        SHZT = #{shzt},
	      </if>
	      <if test="thyy != null" >
	        THYY = #{thyy},
	      </if>
	      <if test="sfbj != null" >
	        SFBJ = #{sfbj},
	      </if>
	    </set>
	    where id=#{id}
	</update>
	<update id="plsbshzc" parameterType="zcgl">
	update ZCGL
	    <set >
	      <if test="xsbzt != null" >
	        XSBZT = #{xsbzt},
	      </if>
	      <if test="ssbzt != null" >
	        SSBZT = #{ssbzt},
	      </if>
	      <if test="shzt != null" >
	        SHZT = #{shzt},
	      </if>
	      <if test="thyy != null" >
	        THYY = #{thyy},
	      </if>
	      <if test="sfbj != null" >
	        SFBJ = #{sfbj},
	      </if>
	    </set>
	    where ${id}
	
	</update>
	<!-- 查询附件 -->
	<select id="queryFjByMd5" parameterType="myfile" resultType="myfile">
		select  distinct fileurl from XTFILE 
		where FILEMD5=#{filemd5}
	</select>
	<insert id="insertFile" parameterType="myfile">
		insert into XTFILE
		 <trim prefix="(" suffix=")" suffixOverrides="," >
	      <if test="filename != null" >filename,</if>
	      <if test="fid != null" >fid,</if>
	      <if test="fileurl != null" >fileurl,</if>
	      <if test="filemd5 != null" >filemd5,</if>
	      <if test="xmlx != null" >xmlx,</if>
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	      <if test="filename != null" >#{filename},</if>
	      <if test="fid != null" >#{fid},</if>
	      <if test="fileurl != null" >#{fileurl},</if>
	      <if test="filemd5 != null" >#{filemd5},</if>
	      <if test="xmlx != null" >#{xmlx},</if>
	    </trim>
	</insert>
	<select id="queryFjByfid" parameterType="myfile" resultType="myfile">
		select * from XTFILE where fid=#{fid}
	</select>
	
	<select id="queryFjByid" parameterType="myfile" resultType="myfile">
		select * from XTFILE where id=#{id}
	</select>
	
	<select id="queryFileBymd5" parameterType="myfile" resultType="myfile">
		select * from XTFILE where id!=#{id} and filemd5=#{filemd5}
	</select>
	
	<select id="deleteFileByid" parameterType="myfile">
		delete from XTFILE where id=#{id}
	</select>
	
	<select id="queryListzcqtbynf" parameterType="zcgl" resultType="zcgl">
		select * from zcgl_qt where xmlx=#{xmlx} and nf=#{oldnf}
		and xmbm not in (
		select xmbm from zcgl_qt where xmlx=#{xmlx} and nf=#{newnf}
		)
	</select>
	<select id="copydatabyyear" parameterType="zcgl">
		insert into zcgl_qt(ID, WZ, MJ, ZC, FZ, BZ, FID, XMBM, NF, GYDW, GYDWDM, XMLX, SBTHCD, XSBZT, THYY, SSBZT, SHZT,lxbm,szzh,dbmc,fwqmc,fwnr)
		select 
		sys_guid(), WZ, MJ, ZC, FZ, BZ, sys_guid(), XMBM, #{newnf}, GYDW, GYDWDM, XMLX,decode(substr(gydwdm,0,1),'1','11','9'),decode(substr(gydwdm,0,1),'1','未上报','已上报'),'','未上报','未审核',lxbm,szzh,dbmc,fwqmc,fwnr
		from zcgl_qt where nf=#{oldnf} and xmlx=#{xmlx} and xmbm in (${xmbm})
	</select>
	<select id="copydatabyyearfj" parameterType="zcgl">
		insert into XTFILE
		
		select sys_guid(), t1.FILENAME, t2.FID, t1.FILEURL, t1.FILEMD5, t1.XMLX from(
			select x.FILENAME, x.FILEURL, x.FILEMD5, x.XMLX,z.xmbm  from XTFILE x left join zcgl_qt z on x.fid=z.fid where x.fid in
			(select fid from zcgl_qt where nf=#{oldnf} and xmlx=#{xmlx} and xmbm in (${xmbm}))
		)t1,
		(
		select * from zcgl_qt where nf=#{newnf} and xmlx=#{xmlx} and xmbm in (${xmbm})
		) t2 where t1.xmbm=t2.xmbm
		
	</select>
	<insert id="insertZcglqt" parameterType="myfile">
		insert into zcgl_qt
		 <trim prefix="(" suffix=")" suffixOverrides="," >
	      <if test="wz != null" >wz,</if>
	      <if test="mj > 0" >mj,</if>
	      <if test="zc > 0" >zc,</if>
	      <if test="fz > 0" >fz,</if>
	      <if test="fid != null" >fid,</if>
	      <if test="xmbm != null" >xmbm,</if>
	      <if test="nf != null" >nf,</if>
	      <if test="gydw != null" >gydw,</if>
	      <if test="gydwdm != null" >gydwdm,</if>
	      <if test="xmlx != null" >xmlx,</if>
	      <if test="sbthcd != null" >sbthcd,</if>
	      <if test="xsbzt != null" >xsbzt,</if>
	      <if test="ssbzt != null" >ssbzt,</if>
	      <if test="thyy != null" >thyy,</if>
	      <if test="bz != null" >bz,</if>
	      <if test="lxbm != null" >lxbm,</if>
	      <if test="dbmc != null" >dbmc,</if>
	      <if test="szzh != null" >szzh,</if>
	      <if test="fwqmc != null" >fwqmc,</if>
	      <if test="fwnr != null" >fwnr,</if>
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	      <if test="wz != null" >#{wz},</if>
	      <if test="mj > 0" >#{mj},</if>
	      <if test="zc > 0" >#{zc},</if>
	      <if test="fz > 0" >#{fz},</if>
	      <if test="fid != null" >#{fid},</if>
	      <if test="xmbm != null" >#{xmbm},</if>
	      <if test="nf != null" >#{nf},</if>
	      <if test="gydw != null" >#{gydw},</if>
	      <if test="gydwdm != null" >#{gydwdm},</if>
	      <if test="xmlx != null" >#{xmlx},</if>
	      <if test="sbthcd != null" >#{sbthcd},</if>
	      <if test="xsbzt != null" >#{xsbzt},</if>
	      <if test="ssbzt != null" >#{ssbzt},</if>
	      <if test="thyy != null" >#{thyy},</if>
	      <if test="bz != null" >#{bz},</if>
	      <if test="lxbm != null" >#{lxbm},</if>
	      <if test="dbmc != null" >#{dbmc},</if>
	      <if test="szzh != null" >#{szzh},</if>
	      <if test="fwqmc != null" >#{fwqmc},</if>
	      <if test="fwnr != null" >#{fwnr},</if>
	    </trim>
	</insert>
	
	
	<select id="queryZcqtlist" parameterType="zcgl" resultType="zcgl">
		select * from(select rownum num ,t1.* from(select * from (select t.*,xsbzt xsbztstr,ssbzt ssbztstr,shzt shztstr from
		(
		select * from ZCGL_QT where xmlx=#{xmlx} and to_number(sbthcd)&lt;=${sbthcd}
		) t
		where 1=1 
		<if test="gydw !='' and gydw != null">${gydw}</if>
		<if test="nf !='' and nf != null">and nf=#{nf}</if>
		<if test="wz !='' and wz != null">and wz like '%'||#{wz}||'%'</if>
		<if test="dbmc !='' and dbmc != null">and dbmc like '%'||#{dbmc}||'%'</if>
		<if test="lxbm !='' and lxbm != null">and lxbm like '%'||#{lxbm}||'%'</if>
		<if test="fwqmc !='' and fwqmc != null">and fwqmc like '%'||#{fwqmc}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
		
		) t1 
		)t2
		where t2.num &lt;=(#{page} * #{rows}) and t2.num>(#{page}-1)*#{rows}
		
	</select>
	<select id="queryZcqtlistCount" parameterType="zcgl" resultType="int">
		select count(*) from (select t.*,xsbzt xsbztstr,ssbzt ssbztstr,shzt shztstr from
		(
		select * from ZCGL_QT where xmlx=#{xmlx} and to_number(sbthcd)&lt;=${sbthcd}
		) t
		where 1=1 
		<if test="gydw !='' and gydw != null">${gydw}</if>
		<if test="nf !='' and nf != null">and nf=#{nf}</if>
		<if test="wz !='' and wz != null">and wz like '%'||#{wz}||'%'</if>
		<if test="dbmc !='' and dbmc != null">and dbmc like '%'||#{dbmc}||'%'</if>
		<if test="lxbm !='' and lxbm != null">and lxbm like '%'||#{lxbm}||'%'</if>
		<if test="fwqmc !='' and fwqmc != null">and fwqmc like '%'||#{fwqmc}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
		
	</select>
	<delete id="deleteZcqt" parameterType="zcgl">
		delete from ZCGL_QT where id in(${id})
	</delete>
	
	<select id="queryZcqtwj" parameterType="zcgl" resultType="myfile">
		select * from XTFILE where fid in (${fid})
	</select>
	<insert id="updateZcglqt" parameterType="myfile">
		update zcgl_qt
		 <set>
		  <if test="wz != null" >wz=#{wz},</if>
	      <if test="mj > 0" >mj=#{mj},</if>
	      <if test="zc > 0" >zc=#{zc},</if>
	      <if test="fz > 0" >fz=#{fz},</if>
	      <if test="fid != null" >fid=#{fid},</if>
	      <if test="xmbm != null" >xmbm=#{xmbm},</if>
	      <if test="nf != null" >nf=#{nf},</if>
	      <if test="gydw != null" >gydw=#{gydw},</if>
	      <if test="gydwdm != null" >gydwdm=#{gydwdm},</if>
	      <if test="xmlx != null" >xmlx=#{xmlx},</if>
	      <if test="sbthcd != null" >sbthcd=#{sbthcd},</if>
	      <if test="xsbzt != null" >xsbzt=#{xsbzt},</if>
	      <if test="ssbzt != null" >ssbzt=#{ssbzt},</if>
	      <if test="thyy != null" >thyy=#{thyy},</if>
	      <if test="bz != null" >bz=#{bz},</if>
	      <if test="lxbm != null" >lxbm=#{lxbm},</if>
	      <if test="dbmc != null" >dbmc=#{dbmc},</if>
	      <if test="szzh != null" >szzh=#{szzh},</if>
	      <if test="fwqmc != null" >fwqmc=#{fwqmc},</if>
	      <if test="fwnr != null" >fwnr=#{fwnr},</if>
		 </set>
	     where id=#{id}
	</insert>
	
	<update id="plsbshzcqt" parameterType="zcgl">
	update ZCGL_QT
	    <set >
	      <if test="xsbzt != null" >
	        XSBZT = #{xsbzt},
	      </if>
	      <if test="ssbzt != null" >
	        SSBZT = #{ssbzt},
	      </if>
	      <if test="shzt != null" >
	        SHZT = #{shzt},
	      </if>
	      <if test="thyy != null" >
	        THYY = #{thyy},
	      </if>
	      <if test="sbthcd != null" >
	        sbthcd = #{sbthcd},
	      </if>
	    </set>
	    where ${id}
	
	</update>
	
	
</mapper>
