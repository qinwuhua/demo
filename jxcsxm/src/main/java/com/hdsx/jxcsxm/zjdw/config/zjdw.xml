<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxcsxm.zjdw">
	<select id="queryXmlist" parameterType="xmjbxx" resultType="xmjbxx">
		select * from(select rownum num ,t1.* from(select t.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
		on t.xmbm=xd.xmid	
		left join(
	    select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
		(case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
		(case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
		(case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
		from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on t.xmbm=dw.xmids
		left join (select xmb.xmbm sfxmbm,decode(dwbz,null,'否',xdbz,'是','否') sfqbdw from 
		xmjbxx xmb left join (select xmbm,sum(ztz)-sum(dfzc) dwbz from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} and (case when ${sbthcd}=7 then shzt else '已审核' end)='已审核' group by xmbm) dwb on xmb.xmbm=dwb.xmbm left join (select xmid,sum(ztz)-sum(dfzc) xdbz from xm_gsd_jhxd group by xmid) xdb
		on dwb.xmbm=xdb.xmid) sf on t.xmbm=sf.sfxmbm
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">${jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		<if test="sfqbdw !='' and sfqbdw != null">${sfqbdw}</if>
		) t1 where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
		and rownum &lt;=(#{page} * #{rows})  
		order by decode(xsbzt,null,0,xsbzt) desc,decode(ssbzt,null,0,ssbzt) desc,decode(shzt,null,0,shzt) desc,xmnf
		)t2
		where t2.num>(#{page}-1)*#{rows}
		
	</select>
	<select id="queryXmlistCount" parameterType="xmjbxx" resultType="int">
		select count(*) from(select t.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
		on t.xmbm=xd.xmid	
		left join(
	    select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
		(case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
		(case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
		(case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
		from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on t.xmbm=dw.xmids
		left join (select xmb.xmbm sfxmbm,decode(dwbz,null,'否',xdbz,'是','否') sfqbdw from 
		xmjbxx xmb left join (select xmbm,sum(ztz)-sum(dfzc) dwbz from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} and (case when ${sbthcd}=7 then shzt else '已审核' end)='已审核' group by xmbm) dwb on xmb.xmbm=dwb.xmbm left join (select xmid,sum(ztz)-sum(dfzc) xdbz from xm_gsd_jhxd group by xmid) xdb
		on dwb.xmbm=xdb.xmid) sf on t.xmbm=sf.sfxmbm
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">${jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		<if test="sfqbdw !='' and sfqbdw != null">${sfqbdw}</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
	</select>
	<select id="getdwTjAll" parameterType="xmjbxx" resultType="xmzjdw">
		select count(*) xmsl,round(sum(nvl(dwzj,0)),2) dwzj,round(sum(nvl(yshdwzj,0)),2) yshdwzj,round(sum(nvl(jhxdzj,0)),2) jhxdzj,
		round(sum(nvl(jhxdstz,0)),2) jhxdstz,round(sum(nvl(jhxdttc,0)),2) jhxdttc,
		round(sum(nvl(jhxdtdk,0)),2) jhxdtdk,round(sum(nvl(jhxdrys,0)),2) jhxdrys,
		round(sum(nvl(jhxddfzc,0)),2) jhxddfzc
		from(select t.*,zj.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
		on t.xmbm=xd.xmid	
		left join(
	    select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
		(case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
		(case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
		(case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
		from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on t.xmbm=dw.xmids
		left join
	    (select distinct xm.xmbm xmbms1,nvl(dwzj,0) dwzj,nvl(yshdwzj,0) yshdwzj,nvl(jhxdzj,0) jhxdzj,nvl(jhxdcgs,0) jhxdcgs,nvl(jhxdstz,0) jhxdstz,nvl(jhxdttc,0) jhxdttc,nvl(jhxdrys,0) jhxdrys,nvl(jhxdtdk,0) jhxdtdk,nvl(jhxddfzc,0) jhxddfzc from xmjbxx xm left join 
			(select xmbm,sum(ztz) dwzj,sum(decode(shzt,'已审核',ztz,0)) yshdwzj from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on xm.xmbm=dw.xmbm left join
			(select xmid xmbm,sum(nvl(ztz,0)) jhxdzj,sum(nvl(btzzj,0)) jhxdcgs,sum(nvl(ztz,0))-sum(nvl(btzzj,0))-sum(nvl(dfzc,0)) jhxdstz,sum(nvl(ztz,0))-sum(nvl(btzzj,0))-sum(nvl(dfzc,0))-sum(nvl(rys,0))-sum(nvl(dk,0)) jhxdttc,sum(nvl(dk,0)) jhxdtdk,sum(nvl(rys,0)) jhxdrys,sum(nvl(dfzc,0)) jhxddfzc from xm_gsd_jhxd group by xmid) xd on xm.xmbm=xd.xmbm 
	    ) zj on t.xmbm=zj.xmbms1
		left join (select xmb.xmbm sfxmbm,decode(dwbz,null,'否',xdbz,'是','否') sfqbdw from 
		xmjbxx xmb left join (select xmbm,sum(ztz)-sum(dfzc) dwbz from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} and (case when ${sbthcd}=7 then shzt else '已审核' end)='已审核' group by xmbm) dwb on xmb.xmbm=dwb.xmbm left join (select xmid,sum(ztz)-sum(dfzc) xdbz from xm_gsd_jhxd group by xmid) xdb
		on dwb.xmbm=xdb.xmid) sf on t.xmbm=sf.sfxmbm
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">${jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		<if test="sfqbdw !='' and sfqbdw != null">${sfqbdw}</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
	</select>
	
	<select id="queryXmlistshqx" parameterType="xmzjdw" resultType="xmzjdw">
		select * from
		(select rownum num,t.*,(select name from xtgl_department where id=t.gydwdm) gydw   from xm_zjdw t
		where 1=1 and gydwdm is not null 
		<if test="gydw !='' and gydw != null">${gydw}</if>
		<if test="dwyf !='' and dwyf != null">and dwyf like '%'||#{dwyf}||'%'</if>
		and rownum &lt;=(#{page} * #{rows}) 
		order by nf,gydwdm
		)t2
		where t2.num>(#{page}-1)*#{rows}
	</select>
	<select id="queryXmlistshqxCount" parameterType="xmzjdw" resultType="int">
		select count(*) from xm_zjdw t
		where 1=1 and gydwdm is not null 
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="dwyf !='' and dwyf != null">and dwyf like '%'||#{dwyf}||'%'</if>
		
	</select>
	<select id="queryzjdwlist" parameterType="xmzjdw" resultType="xmzjdw">
		select * from
		(select rownum num ,t.*  from xm_zjdw t
		where 1=1 and xmbm=#{xmbm} 
		and to_number(sbthcd)&lt;=to_number(#{sbthcd})
		and rownum &lt;=(#{page} * #{rows})
		order by xsbzt,ssbzt,shzt,dwyf
		)t2
		where t2.num>(#{page}-1)*#{rows}
		
	</select>
	<select id="queryzjdwlistCount" parameterType="xmzjdw" resultType="int">
		select count(*) from xm_zjdw t
		where 1=1 and xmbm=#{xmbm} and to_number(sbthcd)&lt;=to_number(#{sbthcd})
	</select>
	
	<select id="queryzjxdlist" parameterType="xmzjdw" resultType="xmzjdw">
		select * from
		(select rownum num ,t.*  from XM_GSD_JHXD t
		where 1=1 and xmid=#{xmbm} 
		and rownum &lt;=(#{page} * #{rows}) 
		order by xdnf
		)t2
		where t2.num>(#{page}-1)*#{rows}
		
	</select>
	<select id="queryzjxdlistCount" parameterType="xmzjdw" resultType="int">
		select count(*) from XM_GSD_JHXD t
		where 1=1 and xmid=#{xmbm} 
	</select>
	
	
	<select id="queryDwByid" parameterType="xmzjdw" resultType="xmzjdw">
		select * from xm_zjdw t where id=#{id}
	</select>
	<select id="getdwTj" parameterType="xmzjdw" resultType="xmzjdw">
		select distinct xmmc,nvl(dwzj,0) dwzj,nvl(yshdwzj,0) yshdwzj,nvl(jhxdzj,0) jhxdzj,nvl(jhxdcgs,0) jhxdcgs,(case when round(nvl(jhxdstz,0),2)&lt;0 then 0 else round(nvl(jhxdstz,0),2) end) jhxdstz,round(nvl(jhxdttc,0),2) jhxdttc,round(nvl(jhxdrys,0),2) jhxdrys,round(nvl(jhxdtdk,0),2) jhxdtdk,round(nvl(jhxddfzc,0),2) jhxddfzc from xmjbxx xm left join 
		(select xmbm,sum(ztz) dwzj,sum(decode(shzt,'已审核',ztz,0)) yshdwzj from xm_zjdw where to_number(sbthcd)&lt;=to_number(#{sbthcd}) group by xmbm) dw on xm.xmbm=dw.xmbm left join
		(select xmid xmbm,sum(nvl(ztz,0)) jhxdzj,sum(nvl(btzzj,0)) jhxdcgs,sum(nvl(ztz,0))-sum(nvl(btzzj,0))-sum(nvl(dfzc,0)) jhxdstz,sum(nvl(ztz,0))-sum(nvl(btzzj,0))-sum(nvl(dfzc,0))-sum(nvl(rys,0))-sum(nvl(dk,0)) jhxdttc,sum(nvl(dk,0)) jhxdtdk,sum(nvl(rys,0)) jhxdrys,sum(nvl(dfzc,0)) jhxddfzc from xm_gsd_jhxd group by xmid) xd on xm.xmbm=xd.xmbm 
		where xm.xmbm=#{xmbm}
	</select>
	<insert id="insertZjdw" parameterType="xmzjdw">
		insert into xm_zjdw
	    <trim prefix="(" suffix=")" suffixOverrides="," >
	      <if test="xmbm != null and xmbm != ''" >xmbm,</if>
	       <if test="ztz != null and ztz != ''" >ztz,</if>
	      <if test="cgs != null and cgs != ''" >cgs,</if>
	      <if test="gz != null and gz != ''" >gz,</if>
	      <if test="sz != null and sz != ''" >sz,</if>
	      <if test="zq != null and zq != ''" >zq,</if>
	      <if test="tdk != null and tdk != ''" >tdk,</if>
	      <if test="jl != null and jl != ''" >jl,</if>
	      <if test="qt != null and qt != ''" >qt,</if>
	      <if test="rys != null and rys != ''" >rys,</if>
	      <if test="dfzc != null and dfzc != ''" >dfzc,</if>
	      <if test="yhdk != null and yhdk != ''" >yhdk,</if>
	      <if test="stz != null and stz != ''" >stz,</if>
	      <if test="jhxdwh != null and jhxdwh != ''" >jhxdwh,</if>
	      <if test="bd != null and bd != ''" >bd,</if>
	      <if test="sbthcd != null and sbthcd != ''" >sbthcd,</if>
	      <if test="xsbzt != null and xsbzt != ''" >xsbzt,</if>
	      <if test="ssbzt != null and ssbzt != ''" >ssbzt,</if>
	      <if test="dwyf != null and dwyf != ''" >dwyf,</if>
	      <if test="ttc != null and ttc != ''" >ttc,</if>
	      <if test="tbr != null and tbr != ''" >tbr,</if>
	      <if test="tbsj != null and tbsj != ''" >tbsj,</if>
	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	      <if test="xmbm != null and xmbm != ''" >#{xmbm},</if>
	      <if test="ztz != null and ztz != ''" >#{ztz},</if>
	      <if test="cgs != null and cgs != ''" >#{cgs},</if>
	      <if test="gz != null and gz != ''" >#{gz},</if>
	      <if test="sz != null and sz != ''" >#{sz},</if>
	      <if test="zq != null and zq != ''" >#{zq},</if>
	      <if test="tdk != null and tdk != ''" >#{tdk},</if>
	      <if test="jl != null and jl != ''" >#{jl},</if>
	      <if test="qt != null and qt != ''" >#{qt},</if>
	      <if test="rys != null and rys != ''" >#{rys},</if>
	      <if test="dfzc != null and dfzc != ''" >#{dfzc},</if>
	      <if test="yhdk != null and yhdk != ''" >#{yhdk},</if>
	      <if test="stz != null and stz != ''" >#{stz},</if>
	      <if test="jhxdwh != null and jhxdwh != ''" >#{jhxdwh},</if>
	      <if test="bd != null and bd != ''" >#{bd},</if>
	      <if test="sbthcd != null and sbthcd != ''" >#{sbthcd},</if>
	      <if test="xsbzt != null and xsbzt != ''" >#{xsbzt},</if>
	      <if test="ssbzt != null and ssbzt != ''" >#{ssbzt},</if>
	      <if test="dwyf != null and dwyf != ''" >#{dwyf},</if>
	      <if test="ttc != null and ttc != ''" >#{ttc},</if>
	      <if test="tbr != null and tbr != ''" >#{tbr},</if>
	      <if test="tbsj != null and tbsj != ''" >#{tbsj},</if>
	    </trim>
	</insert>
	<update id="updateZjdw" parameterType="xmzjdw">
	 update xm_zjdw
    <set>
      <if test="xmbm != null" >xmbm = #{xmbm},</if>
      <if test="ztz != null" >ztz = #{ztz},</if>
      <if test="cgs != null" >cgs = #{cgs},</if>
      <if test="gz != null" >gz = #{gz},</if>
      <if test="sz != null" >sz = #{sz},</if>
      <if test="zq != null" >zq = #{zq},</if>
      <if test="tdk != null" >tdk = #{tdk},</if>
      <if test="jl != null" >jl = #{jl},</if>
      <if test="qt != null" >qt = #{qt},</if>
      <if test="rys != null" >rys = #{rys},</if>
      <if test="dfzc != null" >dfzc = #{dfzc},</if>
      <if test="yhdk != null" >yhdk = #{yhdk},</if>
      <if test="stz != null and stz != ''" >stz = #{stz},</if>
      <if test="jhxdwh != null" >jhxdwh = #{jhxdwh},</if>
      <if test="bd != null" >bd = #{bd},</if>
      <if test="sbthcd != null" >sbthcd = #{sbthcd},</if>
      <if test="thyy != null" >thyy = #{thyy},</if>
      <if test="xsbzt != null" >xsbzt = #{xsbzt},xsbsj=sysdate,</if>
      <if test="ssbzt != null" >ssbzt = #{ssbzt},ssbsj=sysdate,</if>
      <if test="shzt != null" >shzt = #{shzt},shsj=sysdate,</if>
      <if test="sfth != null" >sfth = #{sfth},</if>
      <if test="dwyf != null" >dwyf = #{dwyf},</if>
      <if test="ttc != null" >ttc = #{ttc},</if>
      <if test="tbr != null and tbr != ''" >tbr = #{tbr},</if>
      <if test="tbsj != null and tbsj != ''" >tbsj = #{tbsj},</if>
    </set>
    where 1=1 and ${id}
	</update>
	<update id="updateZjdwType" parameterType="xmzjdw">
	 update xm_zjdw
    <set>
      <if test="sbthcd != null" >sbthcd = #{sbthcd},</if>
      <if test="thyy != null" >thyy = #{thyy},</if>
      <if test="xsbzt != null" >xsbzt = #{xsbzt},xsbsj=sysdate,</if>
      <if test="ssbzt != null" >ssbzt = #{ssbzt},ssbsj=sysdate,</if>
      <if test="shzt != null" >shzt = #{shzt},shsj=sysdate,</if>
      <if test="sfth != null" >sfth = #{sfth},</if>
    </set>
    where 1=1 and ${id}
	</update>
	<update id="plshdw" parameterType="xmzjdw">
	 update xm_zjdw
    <set>
      <if test="sbthcd != null" >sbthcd = #{sbthcd},</if>
      <if test="thyy != null" >thyy = #{thyy},</if>
      <if test="xsbzt != null" >xsbzt = #{xsbzt},xsbsj=sysdate,</if>
      <if test="ssbzt != null" >ssbzt = #{ssbzt},ssbsj=sysdate,</if>
      <if test="shzt != null" >shzt = #{shzt},shsj=sysdate,</if>
      <if test="sfth != null" >sfth = #{sfth},</if>
    </set>
    where 1=1 and ${xmbm}
	</update>
	<select id="deldw" parameterType="xmzjdw">
		delete from xm_zjdw where 1=1 and ${id}
	</select>
	
	<select id="queryChildGydw"  parameterType="xmZjdw" resultType="xmZjdw">
		select * from XTGL_DEPARTMENT t where t.parent=#{gydw} and (t.id not like '%000_' or t.id  like '%0000')  order by t.id
	</select>
	<select id="queryChildGydwJtj"  parameterType="xmZjdw" resultType="xmZjdw">
		select t.*,decode(parent,'11101360000',decode(substr(id,-2),'00',1,0),0) sfds,decode(parent,'11101360000',0,1) sftj from XTGL_DEPARTMENT t where (t.parent=#{gydw}
			or id like substr(#{gydw},0,decode(instr(#{gydw},'00'),0,length(#{gydw}),instr(#{gydw},'00')-1))||'%' )
			and parent !='36'
<!-- 		and (t.id not like '%000_' or t.id  like '%0000')   -->
		order by t.id
	</select>
	
	<select id="queryShqxByOne" parameterType="xmZjdw" resultType="xmZjdw">
		select * from xm_zjdw where 1=1 and gydwdm=#{gydwdm} and dwyf=#{dwyf} and jhxdwh=#{jhxdwh}
	</select>
	<insert id="insertShqx" parameterType="xmzjdw">
		insert into xm_zjdw
	    <trim prefix="(" suffix=")" suffixOverrides="," >
	    	xsbzt,ssbzt,shzt,
	    	<if test="ztz != null and ztz != ''" >ztz,</if>
	    	<if test="cgs != null and cgs != ''" >cgs,</if>
	    	<if test="rys != null and rys != ''" >rys,</if>
	    	<if test="ttc != null and ttc != ''" >ttc,</if>
	    	<if test="dfzc != null and dfzc != ''" >dfzc,</if>
	    	<if test="bd != null and bd != ''" >bd,</if>
	    	<if test="dwyf != null and dwyf != ''" >dwyf,</if>
	    	<if test="jhxdwh != null and jhxdwh != ''" >jhxdwh,</if>
	    	<if test="parent != null and parent != ''" >parent,</if>
	    	<if test="gydwdm != null and gydwdm != ''" >gydwdm,</if>
	    	<if test="xmbm != null and xmbm != ''" >xmbm,</if>
	    	<if test="nf != null and nf != ''" >nf,</if>
	    	<if test="tbr != null and tbr != ''" >tbr,</if>
	    	<if test="tbsj != null and tbsj != ''" >tbsj,</if>
	  	</trim>
	    <trim prefix="values (" suffix=")" suffixOverrides="," >
	    	'已上报','已上报','已审核',
	    	<if test="ztz != null and ztz != ''" >#{ztz},</if>
	    	<if test="cgs != null and cgs != ''" >#{cgs},</if>
	    	<if test="rys != null and rys != ''" >#{rys},</if>
	    	<if test="ttc != null and ttc != ''" >#{ttc},</if>
	    	<if test="dfzc != null and dfzc != ''" >#{dfzc},</if>
	    	<if test="bd != null and bd != ''" >#{bd},</if>
	    	<if test="dwyf != null and dwyf != ''" >#{dwyf},</if>
	    	<if test="jhxdwh != null and jhxdwh != ''" >#{jhxdwh},</if>
	    	<if test="parent != null and parent != ''" >#{parent},</if>
	    	<if test="gydwdm != null and gydwdm != ''" >#{gydwdm},</if>
	    	<if test="xmbm != null and xmbm != ''" >#{xmbm},</if>
	    	<if test="nf != null and nf != ''" >#{nf},</if>
	    	<if test="tbr != null and tbr != ''" >#{tbr},</if>
	    	<if test="tbsj != null and tbsj != ''" >#{tbsj},</if>
		</trim>
	</insert>
	<update id="updateShqx" parameterType="xmzjdw">
	 update xm_zjdw
   	 <set>
      <if test="ztz != null" >ztz = #{ztz},</if>
      <if test="cgs != null" >cgs = #{cgs},</if>
      <if test="rys != null" >rys = #{rys},</if>
      <if test="ttc != null" >ttc = #{ttc},</if>
      <if test="dfzc != null" >dfzc = #{dfzc},</if>
      <if test="bd != null" >bd = #{bd},</if>
      <if test="dwyf != null" >dwyf = #{dwyf},</if>
      <if test="jhxdwh != null" >jhxdwh = #{jhxdwh},</if>
      <if test="parent != null" >parent = #{parent},</if>
      <if test="gydwdm != null" >gydwdm = #{gydwdm},</if>
      <if test="xmbm != null" >xmbm = #{xmbm},</if>
      <if test="nf != null and nf != ''" >nf=#{nf},</if>
	  <if test="tbr != null and tbr != ''" >tbr=#{tbr},</if>
	  <if test="tbsj != null and tbsj != ''" >tbsj=#{tbsj},</if>
	 </set>
      where 1=1 and gydwdm=#{gydwdm} and dwyf=#{dwyf} and nf=#{nf} and jhxdwh=#{jhxdwh}
	</update>
	
	<select id="queryZjByGydwdm" parameterType="xmzjdw" resultType="xmzjdw">
		select * from xm_zjdw z where dwyf=#{dwyf} and z.parent=#{gydwdm} and nf=#{nf}  and jhxdwh=#{jhxdwh} order by gydwdm
	</select>
	
	<select id="queryZjByGydwdmJtj" parameterType="xmzjdw" resultType="xmzjdw">
		
		select * from xm_zjdw z where dwyf=#{dwyf} and (z.parent=#{gydwdm} or gydwdm like rtrim(#{gydwdm}, '0')||'%') and nf=#{nf} and jhxdwh=#{jhxdwh} order by gydwdm
	
	</select>
	<select id="queryZjxddwByGydwdm" parameterType="xmzjdw" resultType="xmzjdw">
		 select 
		  xmbm,decode(t2.gydwdm,null,t1.gydwdm,t2.gydwdm) gydwdm,nvl(t1.cgs,0)-nvl(t2.cgs,0) cgs,nvl(t1.rys,0)-nvl(t2.rys,0) rys,nvl(t1.ttc,0)-nvl(t2.ttc,0) ttc,nvl(t1.dfzc,0)-nvl(t2.dfzc,0) dfzc
		  from (
		  select xmid,gydwdm,sum(nvl(btzzj,0)) cgs,sum(nvl(rys,0)) rys,sum(nvl(dfzc,0)) dfzc,sum(nvl(ttc,0)) ttc from xm_gsd_jhxd z where 1=1 and (z.parent=#{gydwdm}) and substr(xmid,0,4)=#{nf} and jhxdwh=#{jhxdwh} group by xmid,gydwdm order by gydwdm 
		  ) t1 left join
		  (
		  select xmbm,gydwdm,sum(nvl(cgs,0)) cgs,sum(nvl(rys,0)) rys,sum(nvl(ttc,0)) ttc,sum(nvl(dfzc,0)) dfzc from xm_zjdw z where 1=1 and (z.parent=#{gydwdm}) and nf=#{nf} and jhxdwh=#{jhxdwh} group by xmbm,gydwdm order by gydwdm 
			) t2
		  on t1.xmid=t2.xmbm order by gydwdm
	</select>
	
	<select id="queryZjxddwByGydwdmJtj" parameterType="xmzjdw" resultType="xmzjdw">
		 select 
		  xmbm,decode(t2.gydwdm,null,t1.gydwdm,t2.gydwdm) gydwdm,nvl(t1.cgs,0)-nvl(t2.cgs,0) cgs,nvl(t1.rys,0)-nvl(t2.rys,0) rys,nvl(t1.ttc,0)-nvl(t2.ttc,0) ttc,nvl(t1.dfzc,0)-nvl(t2.dfzc,0) dfzc
		  from (
		  select xmid,gydwdm,sum(nvl(btzzj,0)) cgs,sum(nvl(rys,0)) rys,sum(nvl(dfzc,0)) dfzc,sum(nvl(ttc,0)) ttc from xm_gsd_jhxd z where 1=1 and (z.parent=#{gydwdm} or gydwdm like rtrim(#{gydwdm}, '0')||'%') and substr(xmid,0,4)=#{nf} and jhxdwh=#{jhxdwh} group by xmid,gydwdm order by gydwdm 
		  ) t1 left join
		  (
		  select xmbm,gydwdm,sum(nvl(cgs,0)) cgs,sum(nvl(rys,0)) rys,sum(nvl(ttc,0)) ttc,sum(nvl(dfzc,0)) dfzc from xm_zjdw z where 1=1 and (z.parent=#{gydwdm} or gydwdm like rtrim(#{gydwdm}, '0')||'%') and nf=#{nf} and jhxdwh=#{jhxdwh} group by xmbm,gydwdm order by gydwdm 
			) t2
		  on t1.xmid=t2.xmbm order by gydwdm
	</select>
	
	
	<select id="queryzjdwmb" parameterType="xmjbxx" resultType="xmzjdw">
		select xmbm,xmnf,xmmc,gydw,xzqh,ztz jhztz,jhxdcgs xdcgs,jhxdrys xdrys,jhxddfzc xddfzc,(case when (jhxdzj-jhxdcgs-jhxdrys-jhxddfzc)&lt;0 then 0 else (jhxdzj-jhxdcgs-jhxdrys-jhxddfzc) end) xdttc,jhxdwh,
		'0' cgs,'0' rys,'0' dfzc,'0' ttc,to_char(sysdate,'yyyy-mm') dwyf,gydw tbr,to_char(sysdate,'yyyy-mm-dd') tbsj
		from(select t.*,zj.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
		on t.xmbm=xd.xmid	
		left join(
	    select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
		(case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
		(case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
		(case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
		from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on t.xmbm=dw.xmids
		left join
	    (select distinct xm.xmbm xmbms1,nvl(dwzj,0) dwzj,nvl(yshdwzj,0) yshdwzj,nvl(jhxdzj,0) jhxdzj,nvl(jhxdcgs,0) jhxdcgs,nvl(jhxdstz,0) jhxdstz,nvl(jhxddfzc,0) jhxddfzc,nvl(jhxdrys,0) jhxdrys from xmjbxx xm left join 
			(select xmbm,sum(ztz) dwzj,sum(decode(shzt,'已审核',ztz,0)) yshdwzj from xm_zjdw where to_number(sbthcd)&lt;=${sbthcd} group by xmbm) dw on xm.xmbm=dw.xmbm left join
			(select xmid xmbm,sum(nvl(ztz,0)) jhxdzj,sum(nvl(btzzj,0)) jhxdcgs,sum(nvl(ztz,0))-sum(nvl(btzzj,0))-sum(nvl(dfzc,0)) jhxdstz,sum(nvl(dfzc,0)) jhxddfzc,sum(nvl(rys,0)) jhxdrys from xm_gsd_jhxd group by xmid) xd on xm.xmbm=xd.xmbm 
	    ) zj on t.xmbm=zj.xmbms1
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">${jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		) where 1=1
		<if test="shzt !='' and shzt != null">${shzt}</if>
		<if test="ssbzt !='' and ssbzt != null">${ssbzt}</if>
		<if test="xsbzt !='' and xsbzt != null">${xsbzt}</if>
	</select>
	
	<insert id="importZjdw" parameterType="hashMap">
		insert into xm_zjdw (id,jhxdwh,ztz,cgs,rys,ttc,dfzc,dwyf,xmbm,tbr,tbsj,sbthcd)
		values(sys_guid(),#{10},#{11}+#{12}+#{13}+#{14},#{11},#{12},#{13},#{14},#{15},#{0},#{16},#{17},11) 
	</insert>
	<update id="plsbdwxj" parameterType="xmzjdw">
	update xm_zjdw
    <set>
      <if test="sbthcd != null" >sbthcd = #{sbthcd},</if>
      <if test="thyy != null" >thyy = #{thyy},</if>
      <if test="xsbzt != null" >xsbzt = #{xsbzt},xsbsj=sysdate,</if>
      <if test="ssbzt != null" >ssbzt = #{ssbzt},ssbsj=sysdate,</if>
      <if test="shzt != null" >shzt = #{shzt},shsj=sysdate,</if>
      <if test="sfth != null" >sfth = #{sfth},</if>
    </set>
    where 1=1 and xsbzt='未上报' and sbthcd='11' ${xmbm} 
	</update>
	<update id="plsbdwsj" parameterType="xmzjdw">
	update xm_zjdw
    <set>
      <if test="sbthcd != null" >sbthcd = #{sbthcd},</if>
      <if test="thyy != null" >thyy = #{thyy},</if>
      <if test="xsbzt != null" >xsbzt = #{xsbzt},xsbsj=sysdate,</if>
      <if test="ssbzt != null" >ssbzt = #{ssbzt},ssbsj=sysdate,</if>
      <if test="shzt != null" >shzt = #{shzt},shsj=sysdate,</if>
      <if test="sfth != null" >sfth = #{sfth},</if>
    </set>
    where 1=1 and ssbzt='未上报' and sbthcd='9' ${xmbm} 
	</update>
	
	
</mapper>
