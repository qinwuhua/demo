<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxcsxm.jhcx">
	<select id="queryXmlist" parameterType="xmjbxx" resultType="xmjbxx">
		select * from (select rownum num ,t.*,xd.jhxdwh  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd where 1=1 <if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if> group by xmid) xd
		on t.xmbm=xd.xmid	
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">and jsxz =#{jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		and rownum &lt;=(#{page} * #{rows})
		) t1 
		 where t1.num>(#{page}-1)*#{rows}
		order by jhxdwh,xmnf,xmbm
	</select>
	<select id="queryXmlistCount" parameterType="xmjbxx" resultType="int">
		select count(*) from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd where 1=1 <if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if> group by xmid) xd
		on t.xmbm=xd.xmid	
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">and jsxz =#{jsxz}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		
	</select>
	<select id="getTjAll" parameterType="xmjbxx" resultType="xmjbxx">
		select count(*) xmsl,round(sum(nvl(dwzj,0)),2) dwzj,round(sum(nvl(yshdwzj,0)),2) yshdwzj,round(sum(nvl(jhxdzj,0)),2) jhxdzj,round(sum(nvl(jhxdcgs,0)),2) jhxdcgs,(case when round(sum(nvl(jhxdstz,0)),2)&lt;0 then 0 else round(sum(nvl(jhxdstz,0)),2) end) jhxdstz from(select t.*,zj.*,xd.jhxdwh,xsbzt,ssbzt,shzt,nvl(xsbztstr,'未填写') xsbztstr,nvl(ssbztstr,'未填写') ssbztstr,nvl(shztstr,'未填写') shztstr  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd where 1=1 <if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if> group by xmid) xd
		on t.xmbm=xd.xmid	
		left join(
	    select xmbm xmids,sum(decode(xsbzt,'未上报',1,0)) xsbzt,sum(decode(ssbzt,'未上报',1,0)) ssbzt,sum(decode(shzt,'未审核',1,0)) shzt,
		(case when replace(WMSYS.WM_CONCAT(xsbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) xsbztstr,
		(case when replace(WMSYS.WM_CONCAT(ssbzt),',',',') like '%未上报%' then '未上报' else '已上报' end) ssbztstr,
		(case when replace(WMSYS.WM_CONCAT(shzt),',',',') like '%未审核%' then '未审核' else '已审核' end) shztstr
		from xm_zjdw group by xmbm) dw on t.xmbm=dw.xmids
		left join
	    (select distinct xm.xmbm xmbms1,nvl(dwzj,0) dwzj,nvl(yshdwzj,0) yshdwzj,nvl(jhxdzj,0) jhxdzj,nvl(jhxdcgs,0) jhxdcgs,nvl(jhxdstz,0) jhxdstz from xmjbxx xm left join 
			(select xmbm,sum(ztz) dwzj,sum(decode(shzt,'已审核',ztz,0)) yshdwzj from xm_zjdw group by xmbm) dw on xm.xmbm=dw.xmbm left join
			(select xmid xmbm,sum(nvl(btzzj,0))+sum(nvl(gz,0))+sum(nvl(sz,0))+sum(nvl(zq,0))+sum(nvl(dk,0))+sum(nvl(jl,0))+sum(nvl(qt,0))+sum(nvl(rys,0))+sum(nvl(yhdk,0))+sum(nvl(stz,0)) jhxdzj,sum(nvl(btzzj,0)) jhxdcgs,sum(nvl(gz,0))+sum(nvl(sz,0))+sum(nvl(zq,0))+sum(nvl(dk,0))+sum(nvl(jl,0))+sum(nvl(qt,0))+sum(nvl(yhdk,0))+sum(nvl(stz,0))+sum(nvl(ttc,0))+sum(nvl(zddzjl,0)) jhxdstz from xm_gsd_jhxd where 1=1 <if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if> group by xmid) xd on xm.xmbm=xd.xmbm 
	    ) zj on t.xmbm=zj.xmbms1
		where 1=1 
		<if test="xzqh !='' and xzqh != null">${xzqh}</if>
		<if test="gydwdm !='' and gydwdm != null">${gydwdm}</if>
		<if test="xmnf !='' and xmnf != null">${xmnf}</if>
		<if test="jsxz !='' and jsxz != null">and jsxz =#{jsxz}</if>
		<if test="jhxdwh !='' and jhxdwh != null">${jhxdwh}</if>
		<if test="gcfl !='' and gcfl != null">${gcfl}</if>
		<if test="xmbm !='' and xmbm != null">and xmbm like '%'||#{xmbm}||'%'</if>
		<if test="xmmc !='' and xmmc != null">and xmmc like '%'||#{xmmc}||'%'</if>
		<if test="gydw !='' and gydw != null">and gydwdm like #{gydw}||'%'</if>
		) where 1=1
		
		
		
	</select>
	
	<select id="getxmInfo" parameterType="xmjbxx" resultType="xmjbxx">
		select t.*,xd.jhxdwh,decode(jsxz,'路网结构改造',gcfl,jsxz) xmlx  from xmjbxx t
		left join(select xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_gsd_jhxd group by xmid) xd
		on t.xmbm=xd.xmid	 where xmbm=#{xmbm}
	</select>
	
	<select id="gettjxmInfo" parameterType="xmjbxx" resultType="xmjbxx">
		select t.*,xd.jhxdwh,decode(jsxz,'路网结构改造',gcfl,jsxz) xmlx  from xmjbxx_tj t
		left join(select xmbm xmid,replace(WMSYS.WM_CONCAT(distinct jhxdwh),',',',') jhxdwh from xm_zjdw group by xmbm) xd
		on t.xmbm=xd.xmid	 where xmbm=#{xmbm}
	</select>
	
	<select id="queryZjByGydwdm" parameterType="xmjbxx" resultType="xmjbxx">
		select * from xm_gsd_jhxd z where xdnf=#{xdnf} <if test="jhxdwh !=null">and jhxdwh=#{jhxdwh}</if> and z.parent=#{gydwdm} order by gydwdm
	</select>
	<select id="queryZjByGydwdmJtj" parameterType="xmjbxx" resultType="xmjbxx">
		select * from xm_gsd_jhxd z where xdnf=#{xdnf} <if test="jhxdwh !=null">and jhxdwh=#{jhxdwh}</if> and (z.parent=#{gydwdm} or gydwdm like rtrim(#{gydwdm}, '0')||'%') order by gydwdm
	</select>
	
</mapper>
